<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vikrama ERP - Integrated System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            overflow: hidden;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-item {
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            background: rgba(59, 130, 246, 0.1);
            border-left-color: #3b82f6;
            color: #60a5fa;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        /* Smooth fade animation for table rows */
        #group-table-body tr {
            animation: fadeInRow 0.3s ease-out;
        }

        @keyframes fadeInRow {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Highlight new/updated row briefly */
        @keyframes highlightRow {

            0%,
            100% {
                background-color: transparent;
            }

            50% {
                background-color: rgba(139, 92, 246, 0.2);
            }
        }

        .row-highlight {
            animation: highlightRow 1s ease;
        }


        /* Filter Button Active State */
        .pos-filter-btn.active-filter {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            border-color: #60a5fa !important;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            transform: scale(1.05);
        }

        .page-section {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal Scale Animation */
        .modal-scale {
            animation: modalScale 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .receipt-pattern {
            background-color: #ffffff;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Recipe Card Hover Effects */
        .recipe-card-actions {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .recipe-card:hover .recipe-card-actions {
            opacity: 1;
        }

        /* Flatpickr Dark Theme Customization */
        .flatpickr-calendar {
            background: #1e293b !important;
            border: 1px solid #475569 !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5) !important;
        }

        .flatpickr-calendar.arrowTop:before {
            border-bottom-color: #1e293b !important;
        }

        .flatpickr-calendar.arrowTop:after {
            border-bottom-color: #1e293b !important;
        }

        .flatpickr-months {
            background: #334155 !important;
            border-bottom: 1px solid #475569 !important;
        }

        .flatpickr-month {
            color: #f8fafc !important;
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months {
            background: #1e293b !important;
            color: #f8fafc !important;
            border: 1px solid #475569 !important;
        }

        .flatpickr-current-month input.cur-year {
            color: #f8fafc !important;
            background: transparent !important;
        }

        .flatpickr-weekdays {
            background: #334155 !important;
        }

        .flatpickr-weekday {
            color: #94a3b8 !important;
        }

        .flatpickr-day {
            color: #cbd5e1 !important;
            border: 1px solid transparent !important;
        }

        .flatpickr-day:hover {
            background: #475569 !important;
            border-color: #64748b !important;
        }

        .flatpickr-day.today {
            border-color: #8b5cf6 !important;
            background: rgba(139, 92, 246, 0.1) !important;
        }

        .flatpickr-day.today:hover {
            background: rgba(139, 92, 246, 0.3) !important;
        }

        .flatpickr-day.selected {
            background: #8b5cf6 !important;
            border-color: #8b5cf6 !important;
            color: white !important;
        }

        .flatpickr-day.selected:hover {
            background: #7c3aed !important;
        }

        .flatpickr-day.disabled,
        .flatpickr-day.prevMonthDay,
        .flatpickr-day.nextMonthDay {
            color: #475569 !important;
        }

        .flatpickr-time {
            background: #1e293b !important;
            border-top: 1px solid #475569 !important;
        }

        .flatpickr-time input {
            color: #f8fafc !important;
        }

        /* Icon untuk input date */
        .date-input-wrapper {
            position: relative;
        }

        .date-input-wrapper input {
            padding-right: 40px !important;
        }

        .date-input-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #8b5cf6;
            pointer-events: none;
            font-size: 14px;
        }

        /* Slide animations for collapsible reports */
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                max-height: 2000px;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                max-height: 2000px;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                max-height: 0;
                transform: translateY(-10px);
            }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, deleteDoc, updateDoc, writeBatch, serverTimestamp, query, orderBy, limit, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE (HYBRID) ---
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            // [AREA EDIT UNTUK DEPLOY VERCEL]
            firebaseConfig = {
                apiKey: "AIzaSyDh0E43GugWo4_M6qYwtu9GKJFN9Vm6UAE",
                authDomain: "vk-super-app.firebaseapp.com",
                projectId: "vk-super-app",
                storageBucket: "vk-super-app.firebasestorage.app",
                messagingSenderId: "143863741050",
                appId: "1:143863741050:web:06fccfbd07ba252173d9c3"
            };
        }

        let app, auth, db, appId;
        let currentUser = null;

        // --- STATE GLOBAL ---
        let warehouseStock = {}; 
        let warehouseHistory = []; 
        let warehouseSpecificHistory = [];
        let craftingHistory = []; 
        let productStock = [];
        let recipes = {};
        let materialPrices = {}; 
        let craftQueue = []; // ANTRIAN CRAFTING
        let weaponDatabase = []; // DATABASE SENJATA
        let groupDatabase = []; // DATABASE KELOMPOK & LIMIT
        let lastSalesTransaction = null; // Store last transaction for report
        let lastCraftingReport = null; // Store crafting material usage report
        let allCraftingReports = []; // Store ALL crafting reports
        let salesHistory = []; // Store sales transaction history
        
        // --- MODAL STATE ---
        let currentAction = null; 
        let currentTargetItem = null;
        let currentReportElement = null;
        let currentConfirmCallback = null; // For Custom Alert

        // POS FILTER STATE
let posFilterClass = 'SEMUA';

window.filterPosByClass = (className) => {
    posFilterClass = className;
    
    // Update active button
    document.querySelectorAll('.pos-filter-btn').forEach(btn => {
        btn.classList.remove('active-filter');
    });
    event.target.classList.add('active-filter');
    
    renderPosGrid();
};

        // --- INISIALISASI ---
        const initApp = async () => {
            try {
                appId = typeof __app_id !== 'undefined' ? __app_id : 'vikrama-erp-production';
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('connection-status').innerHTML = '<span class="text-emerald-400"><i class="fas fa-wifi mr-2"></i>Online</span>';
                        startRealtimeListeners();
                    }
                });
            } catch (err) {
                console.error("Init Error", err);
                document.getElementById('connection-status').innerHTML = '<span class="text-rose-500">Offline (Check Config)</span>';
                if(!firebaseConfig.apiKey.includes("ISI_API_KEY")) {
                      showAlert("Koneksi Gagal", "Gagal menghubungkan ke Firebase: " + err.message, "error");
                }
            }
        };

        function startRealtimeListeners() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), (snap) => {
                if(snap.exists()) {
                    warehouseStock = snap.data();
                    renderWarehouseTable();
                    renderCraftingInputs();
                    renderRecipeTable(); 
                    renderCraftQueue(); 
                    renderMaterialStockPreview();
                } else {
                    warehouseStock = {};
                    renderWarehouseTable();
                    renderCraftingInputs();
                    renderRecipeTable(); 
                    renderCraftQueue();
                    renderMaterialStockPreview();
                }
            });
            
            // Listener Harga Bahan
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'material_prices', 'main_prices'), (snap) => {
                if(snap.exists()) materialPrices = snap.data();
                else materialPrices = {};
                renderPriceListTable();
                // Refresh displays that depend on material prices
                renderWeaponDatabase();
                renderPosGrid();
                renderInventoryTable(); // Update inventory view
            });

           onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'recipes'), (snap) => {
                const newRecipes = {};
                snap.forEach(d => newRecipes[d.id] = d.data());
                recipes = newRecipes;
                renderRecipeTable();
                renderProductDropdown();
                // Refresh displays that depend on cost calculation
                renderWeaponDatabase();
                renderPosGrid();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (snap) => {
                productStock = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderPosGrid();
                renderInventoryTable();
            });
            
            const qHist = query(collection(db, 'artifacts', appId, 'public', 'data', 'global_history'), orderBy('timestamp', 'desc'), limit(50));
            onSnapshot(qHist, (snap) => {
                warehouseHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderHistoryTable();
            });
           
        const qWhHist = query(collection(db, 'artifacts', appId, 'public', 'data', 'global_history'), orderBy('timestamp', 'desc'), limit(150));
onSnapshot(qWhHist, (snap) => {
    const allLogs = snap.docs.map(d => ({id: d.id, ...d.data()}));
    warehouseSpecificHistory = allLogs.filter(log => log.type === 'WAREHOUSE');
    // Filter juga untuk Crafting History
    craftingHistory = allLogs.filter(log => log.type === 'CRAFTING');
    
    // NEW: Store all crafting as reports
    allCraftingReports = craftingHistory.map(log => ({
        timestamp: log.timestamp ? new Date(log.timestamp.seconds*1000) : new Date(),
        products: log.details ? log.details.map(d => ({name: d.name, qty: d.qty})) : [],
        materialUsage: calculateMaterialUsageFromLog(log),
        rawLog: log
    }));
    
    renderWarehouseSpecificHistory();
    renderCraftingHistory(); // Update modal jika terbuka
});

 // Listener for Sales History
            const qSalesHist = query(
                collection(db, 'artifacts', appId, 'public', 'data', 'global_history'), 
                where('type', '==', 'SALES'),
                orderBy('timestamp', 'desc'), 
                limit(50)
            );
            onSnapshot(qSalesHist, (snap) => {
                salesHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
    
                // Auto-update if POS page is active
                if(document.getElementById('pos').classList.contains('active')) {
                    renderSalesHistory();
                }
            });
            
            // Listener Weapon Database
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'weapon_database'), (snap) => {
                weaponDatabase = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderWeaponDatabase();
            });

            // Listener Group Database
onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'groups'), (snap) => {
    groupDatabase = snap.docs.map(d => ({id: d.id, ...d.data()}));
    renderGroupDropdown();
    
    // TAMBAHKAN INI - Auto update table if modal is open
    const modal = document.getElementById('groupManagerModal');
    if(modal && !modal.classList.contains('hidden')) {
        renderGroupTable();
    }
});

        }

        // Helper: Calculate material usage from crafting log
function calculateMaterialUsageFromLog(log) {
    if(!log.details) return {};
    
    const usage = {};
    log.details.forEach(item => {
        if(item.materials) {
            Object.entries(item.materials).forEach(([mat, qty]) => {
                if(!usage[mat]) {
                    usage[mat] = {
                        before: 0,
                        used: 0,
                        after: 0
                    };
                }
                usage[mat].used += qty;
            });
        }
    });
    
    return usage;
}


        // --- CUSTOM ALERT SYSTEM ---
        window.showAlert = (title, message, type = 'info') => {
            const modal = document.getElementById('custom-alert-modal');
            const iconWrapper = document.getElementById('alert-icon-wrapper');
            const icon = document.getElementById('alert-icon');
            const titleEl = document.getElementById('alert-title');
            const msgEl = document.getElementById('alert-message');
            const actions = document.getElementById('alert-actions');

            titleEl.textContent = title;
            msgEl.innerHTML = message;
            actions.innerHTML = ''; 

            iconWrapper.className = 'w-16 h-16 rounded-full flex items-center justify-center mb-4 transition-colors mx-auto';
            if (type === 'success') {
                iconWrapper.classList.add('bg-emerald-500/20', 'text-emerald-500');
                icon.className = 'fas fa-check text-3xl';
            } else if (type === 'error') {
                iconWrapper.classList.add('bg-rose-500/20', 'text-rose-500');
                icon.className = 'fas fa-times text-3xl';
            } else if (type === 'warning') {
                iconWrapper.classList.add('bg-yellow-500/20', 'text-yellow-500');
                icon.className = 'fas fa-exclamation-triangle text-3xl';
            } else {
                iconWrapper.classList.add('bg-blue-500/20', 'text-blue-500');
                icon.className = 'fas fa-info text-3xl';
            }

            const btn = document.createElement('button');
            btn.className = 'w-full py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-bold transition shadow-lg';
            btn.textContent = 'OK';
            btn.onclick = closeAlert;
            actions.appendChild(btn);

            modal.classList.remove('hidden');
        };

        window.showConfirm = (title, message, callback, type = 'warning') => {
            const modal = document.getElementById('custom-alert-modal');
            const iconWrapper = document.getElementById('alert-icon-wrapper');
            const icon = document.getElementById('alert-icon');
            const titleEl = document.getElementById('alert-title');
            const msgEl = document.getElementById('alert-message');
            const actions = document.getElementById('alert-actions');

            titleEl.textContent = title;
            msgEl.innerHTML = message;
            actions.innerHTML = '';
            currentConfirmCallback = callback;

            iconWrapper.className = 'w-16 h-16 rounded-full flex items-center justify-center mb-4 transition-colors mx-auto';
            if (type === 'danger') {
                iconWrapper.classList.add('bg-rose-500/20', 'text-rose-500');
                icon.className = 'fas fa-trash-alt text-3xl';
            } else {
                iconWrapper.classList.add('bg-yellow-500/20', 'text-yellow-500');
                icon.className = 'fas fa-question text-3xl';
            }

            const btnCancel = document.createElement('button');
            btnCancel.className = 'flex-1 py-2.5 border border-slate-600 text-slate-300 hover:bg-slate-800 rounded-lg font-bold transition mr-3';
            btnCancel.textContent = 'Batal';
            btnCancel.onclick = closeAlert;

            const btnConfirm = document.createElement('button');
            const colorClass = type === 'danger' ? 'bg-rose-600 hover:bg-rose-500' : 'bg-blue-600 hover:bg-blue-500';
            btnConfirm.className = `flex-1 py-2.5 ${colorClass} text-white rounded-lg font-bold transition shadow-lg`;
            btnConfirm.textContent = 'Ya, Lanjutkan';
            btnConfirm.onclick = () => {
                if(currentConfirmCallback) currentConfirmCallback();
                closeAlert();
            };

            actions.appendChild(btnCancel);
            actions.appendChild(btnConfirm);

            modal.classList.remove('hidden');
        };

        window.closeAlert = () => {
            document.getElementById('custom-alert-modal').classList.add('hidden');
            currentConfirmCallback = null;
        };

        // --- FUNGSI-FUNGSI LOGIKA WAREHOUSE ---
        
        window.saveResource = async (e) => {
            e.preventDefault();
            const name = document.getElementById('wh-name').value.trim().toUpperCase();
            const qty = parseFloat(document.getElementById('wh-qty').value);
            
            if(!name || isNaN(qty)) return;

            const currentQty = warehouseStock[name] || 0;
            const newStock = { ...warehouseStock, [name]: currentQty + qty };

            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), newStock);
            await addLog({
                type: 'WAREHOUSE',
                subtype: 'DEPOSIT',
                itemName: name,
                desc: `Input Bahan Baru`,
                amount: qty,
                before: currentQty,
                after: currentQty + qty,
                pic: 'Admin',
                note: 'Setup Awal'
            });
            
            document.getElementById('wh-form').reset();
            showToast(`Bahan ${name} berhasil diupdate!`);
        };

        window.importWarehouseExcel = async (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if (jsonData.length === 0) {
                        showAlert("File Kosong", "File Excel tidak berisi data yang valid.", "warning");
                        return;
                    }

                    const newStock = { ...warehouseStock };
                    let logDetails = [];

                    jsonData.forEach(row => {
                        const nameKey = Object.keys(row).find(k => k.toLowerCase().includes('nama') || k.toLowerCase().includes('item') || k.toLowerCase().includes('bahan'));
                        const qtyKey = Object.keys(row).find(k => k.toLowerCase().includes('stok') || k.toLowerCase().includes('jumlah') || k.toLowerCase().includes('qty'));

                        if (nameKey && qtyKey) {
                            const name = String(row[nameKey]).trim().toUpperCase();
                            const qty = parseFloat(row[qtyKey]) || 0;
                            if (name) {
                                const current = newStock[name] || 0;
                                newStock[name] = current + qty;
                                logDetails.push(`${name} (+${qty})`);
                            }
                        }
                    });

                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), newStock);
                    await addLog({
                        type: 'WAREHOUSE',
                        subtype: 'BATCH',
                        itemName: 'Batch Import',
                        desc: `Import Excel (${logDetails.length} item)`,
                        amount: 0,
                        note: logDetails.join(', ')
                    });
                    
                    showAlert("Sukses", `Berhasil import <b>${logDetails.length}</b> item dari Excel!`, "success");
                    input.value = '';
                } catch (err) {
                    console.error(err);
                    showAlert("Gagal Import", "Terjadi kesalahan saat membaca file Excel.", "error");
                }
            };
            reader.readAsArrayBuffer(file);
        };
        
        // --- NEW FEATURE: MATERIAL PRICE MANAGEMENT ---
        window.openPriceModal = () => {
            renderPriceListTable();
            document.getElementById('priceModal').classList.remove('hidden');
        };

        window.closePriceModal = () => {
            document.getElementById('priceModal').classList.add('hidden');
        };

        window.renderPriceListTable = () => {
            const tbody = document.getElementById('price-table-body');
            if(!tbody) return;
            
            const search = document.getElementById('price-search')?.value.toUpperCase() || '';
            tbody.innerHTML = '';

            const allItems = new Set([...Object.keys(warehouseStock), ...Object.keys(materialPrices)]);
            
            if(allItems.size === 0) {
                 tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-500 italic">Belum ada data bahan.</td></tr>';
                 return;
            }

            const sortedItems = Array.from(allItems).sort();
            let count = 0;

            sortedItems.forEach(name => {
                if(name.toUpperCase().includes(search)) {
                    const price = materialPrices[name] || 0;
                    const stock = warehouseStock[name] || 0;
                    
                    tbody.innerHTML += `
                        <tr class="border-b border-slate-700 hover:bg-slate-700/50">
                            <td class="p-3 text-sm font-bold text-slate-200">${name}</td>
                            <td class="p-3 text-sm text-right font-mono text-emerald-400">Rp ${price.toLocaleString()}</td>
                            <td class="p-3 text-xs text-right text-slate-400">${stock.toLocaleString()} Unit</td>
                            <td class="p-3 text-center">
                                <div class="flex justify-center gap-2">
                                    <button onclick="openEditPriceModal('${name}', ${price})" class="text-blue-400 hover:text-white" title="Edit Harga">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteMaterialPrice('${name}')" class="text-rose-400 hover:text-white" title="Hapus Harga">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    count++;
                }
            });

            if(count === 0) tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-500 italic">Tidak ditemukan.</td></tr>';
        };

        window.openEditPriceModal = (name, currentPrice) => {
            document.getElementById('edit-price-name').value = name;
            document.getElementById('edit-price-value').value = currentPrice;
            document.getElementById('editPriceModal').classList.remove('hidden');
        };

        window.closeEditPriceModal = () => {
            document.getElementById('editPriceModal').classList.add('hidden');
        };

        window.savePriceUpdate = async () => {
            const name = document.getElementById('edit-price-name').value;
            const price = parseFloat(document.getElementById('edit-price-value').value);

            if(!name || isNaN(price) || price < 0) {
                return showAlert("Error", "Harga tidak valid", "error");
            }

            try {
                const newPrices = { ...materialPrices };
                newPrices[name] = price;
                
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'material_prices', 'main_prices'), newPrices);
                showAlert("Sukses", `Harga <b>${name}</b> berhasil diupdate!`, "success");
                closeEditPriceModal();
            } catch(err) {
                console.error(err);
                showAlert("Error", "Gagal update harga: " + err.message, "error");
            }
        };

        window.deleteMaterialPrice = (name) => {
            showConfirm("Hapus Harga?", `Yakin ingin menghapus data harga untuk <b>${name}</b>? Stok gudang tidak akan terhapus.`, async () => {
                try {
                    const newPrices = { ...materialPrices };
                    delete newPrices[name];
                    
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'material_prices', 'main_prices'), newPrices);
                    showAlert("Sukses", `Data harga ${name} dihapus.`, "success");
                } catch(err) {
                    console.error(err);
                    showAlert("Error", "Gagal menghapus harga: " + err.message, "error");
                }
            }, "danger");
        };

        window.importPriceExcel = async (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if (jsonData.length === 0) return showAlert("File Kosong", "Data tidak ditemukan.", "warning");

                    const newPrices = { ...materialPrices };
                    let updatedCount = 0;

                    jsonData.forEach(row => {
                        // Flexible key matching
                        const nameKey = Object.keys(row).find(k => k.toLowerCase().includes('nama') || k.toLowerCase().includes('bahan'));
                        const priceKey = Object.keys(row).find(k => k.toLowerCase().includes('harga') || k.toLowerCase().includes('price') || k.toLowerCase().includes('modal'));

                        if (nameKey && priceKey) {
                            const name = String(row[nameKey]).trim().toUpperCase();
                            const price = parseFloat(row[priceKey]);
                            
                            if (name && !isNaN(price)) {
                                newPrices[name] = price;
                                updatedCount++;
                            }
                        }
                    });

                    if (updatedCount > 0) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'material_prices', 'main_prices'), newPrices);
                        showAlert("Sukses", `Berhasil memperbarui harga <b>${updatedCount}</b> bahan!`, "success");
                    } else {
                        showAlert("Gagal", "Tidak ada kolom 'Nama Bahan' atau 'Harga' yang valid.", "error");
                    }
                    input.value = '';
                } catch (err) {
                    console.error(err);
                    showAlert("Error", "Gagal membaca Excel: " + err.message, "error");
                }
            };
            reader.readAsArrayBuffer(file);
        };

        window.renderWarehouseTable = () => {
            const tbody = document.getElementById('wh-table-body');
            const searchInput = document.getElementById('wh-list-search');
            const filter = searchInput ? searchInput.value.toUpperCase() : '';
            
            tbody.innerHTML = '';
            
            const items = Object.entries(warehouseStock)
                .filter(([name]) => name.toUpperCase().includes(filter))
                .sort();
            
            if (Object.keys(warehouseStock).length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-slate-500 italic">Gudang kosong.</td></tr>`;
                return;
            }

            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-slate-500">Tidak ada barang yang cocok.</td></tr>`;
                return;
            }

            items.forEach(([name, qty]) => {
                let rowClass = "border-b border-slate-700/50 hover:bg-slate-700/30 transition duration-150";
                let qtyClass = "text-emerald-400";
                
                if(qty <= 0) {
                    qtyClass = "text-rose-500 font-bold";
                    rowClass += " bg-rose-900/10";
                } else if(qty < 10) {
                    qtyClass = "text-yellow-400 font-bold";
                }

                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="p-3 align-middle">
                            <div class="font-bold text-slate-200 text-sm">${name}</div>
                        </td>
                        <td class="p-3 text-right align-middle">
                            <span class="font-mono text-sm ${qtyClass}">${qty.toLocaleString()}</span>
                        </td>
                        <td class="p-3 text-center align-middle">
                            <div class="flex justify-center gap-1">
                                <button onclick="openActionModal('DP', '${name}')" class="w-7 h-7 rounded bg-emerald-600/20 text-emerald-400 hover:bg-emerald-600 hover:text-white transition flex items-center justify-center border border-emerald-600/30" title="Deposit">
                                    <i class="fas fa-plus text-[10px]"></i>
                                </button>
                                <button onclick="openActionModal('WD', '${name}')" class="w-7 h-7 rounded bg-orange-600/20 text-orange-400 hover:bg-orange-600 hover:text-white transition flex items-center justify-center border border-orange-600/30" title="Withdraw">
                                    <i class="fas fa-minus text-[10px]"></i>
                                </button>
                                <button onclick="openActionModal('EDIT', '${name}')" class="w-7 h-7 rounded bg-blue-600/20 text-blue-400 hover:bg-blue-600 hover:text-white transition flex items-center justify-center border border-blue-600/30" title="Edit">
                                    <i class="fas fa-edit text-[10px]"></i>
                                </button>
                                <button onclick="openActionModal('DELETE', '${name}')" class="w-7 h-7 rounded bg-rose-600/20 text-rose-400 hover:bg-rose-600 hover:text-white transition flex items-center justify-center border border-rose-600/30" title="Hapus">
                                    <i class="fas fa-trash text-[10px]"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        };

        window.openBulkModal = () => {
            const tbody = document.getElementById('bulkItemsBody');
            tbody.innerHTML = '';
            const items = Object.entries(warehouseStock).sort();
            if(items.length === 0) return showAlert("Gudang Kosong", "Tidak ada item untuk diupdate.", "warning");

            items.forEach(([name, qty]) => {
                tbody.innerHTML += `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="p-3 text-sm text-gray-800 font-bold">${name}</td>
                        <td class="p-3 text-center">
                            <span class="px-2 py-1 rounded bg-gray-200 text-gray-700 text-xs font-bold border border-gray-300">${qty}</span>
                        </td>
                        <td class="p-3">
                            <select class="bulk-action w-full bg-white text-gray-800 text-xs border border-gray-300 rounded p-2 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                                <option value="DEPOSIT">Masuk (+)</option>
                                <option value="WITHDRAW">Keluar (-)</option>
                            </select>
                        </td>
                        <td class="p-3">
                            <input type="number" min="0" placeholder="0" data-name="${name}" data-stock="${qty}" class="bulk-input w-full bg-white text-gray-800 text-xs border border-gray-300 rounded p-2 text-center outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition font-bold">
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('bulkImage').value = '';
            document.getElementById('file-status-indicator').classList.add('hidden');
            
            document.getElementById('bulkUpdateModal').classList.remove('hidden');
        };

        window.filterBulkItems = () => {
            const input = document.getElementById('bulkSearchInput').value.toUpperCase();
            const rows = document.querySelectorAll('#bulkItemsBody tr');
            rows.forEach(row => {
                const name = row.cells[0].innerText.toUpperCase();
                row.style.display = name.includes(input) ? '' : 'none';
            });
        };
        
        window.handleFileSelect = (input) => {
            const indicator = document.getElementById('file-status-indicator');
            const fileNameSpan = document.getElementById('file-name-display');
            if(input.files && input.files[0]) {
                indicator.classList.remove('hidden');
                fileNameSpan.textContent = input.files[0].name;
            } else {
                indicator.classList.add('hidden');
            }
        };

        window.handleBulkSubmit = async () => {
            const rows = document.querySelectorAll('#bulkItemsBody tr');
            const pic = document.getElementById('bulkPIC').value || 'Batch Admin';
            const desc = document.getElementById('bulkDesc').value || 'Update Massal';
            
            const updates = [];
            const details = [];
            let updatedStock = { ...warehouseStock };

            for(let row of rows) {
                const input = row.querySelector('.bulk-input');
                const select = row.querySelector('.bulk-action');
                const amount = parseFloat(input.value);
                const name = input.dataset.name;
                const currentStock = parseFloat(input.dataset.stock);

                if(!isNaN(amount) && amount > 0) {
                    const type = select.value; 
                    let newStock = currentStock;
                    let symbol = '';

                    if(type === 'WITHDRAW') {
                        if(amount > currentStock) {
                            showAlert("Stok Kurang", `Stok <b>${name}</b> tidak cukup untuk dikurangi ${amount}.`, "error");
                            input.focus();
                            return;
                        }
                        newStock -= amount;
                        symbol = '-';
                    } else {
                        newStock += amount;
                        symbol = '+';
                    }

                    updatedStock[name] = newStock;
                    updates.push({ name, type, amount, before: currentStock, after: newStock });
                    details.push(`${name}: ${symbol}${amount}`);
                }
            }

            if(updates.length === 0) return showAlert("Data Kosong", "Tidak ada item yang diisi jumlahnya.", "warning");

            const btn = document.getElementById('btnBulkConfirm');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Memproses...';
            btn.disabled = true;

            try {
                let imgData = null;
                const imgInput = document.getElementById('bulkImage');
                if (imgInput.files[0]) {
                    imgData = await compressImage(imgInput.files[0]);
                }

                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), updatedStock);

                await addLog({
                    type: 'WAREHOUSE',
                    subtype: 'BATCH',
                    itemName: `Batch Update (${updates.length} Items)`,
                    desc: desc,
                    amount: 0,
                    pic: pic,
                    note: details.join(', '),
                    image: imgData,
                    details: updates
                });

                showAlert("Sukses", `Berhasil update <b>${updates.length}</b> item secara massal!`, "success");
                document.getElementById('bulkUpdateModal').classList.add('hidden');
                document.getElementById('bulkPIC').value = '';
                document.getElementById('bulkDesc').value = '';
                document.getElementById('bulkSearchInput').value = '';
                document.getElementById('bulkImage').value = '';
                document.getElementById('file-status-indicator').classList.add('hidden');

            } catch(err) {
                console.error(err);
                showAlert("Error", "Gagal melakukan update massal: " + err.message, "error");
            } finally {
                btn.innerHTML = 'Proses Semua';
                btn.disabled = false;
            }
        };

        // --- NEW FEATURE: DELETE ALL HISTORY ---
        window.deleteAllHistory = () => {
            if (warehouseSpecificHistory.length === 0) {
                return showAlert("Info", "Riwayat transaksi sudah kosong.", "info");
            }

            showConfirm(
                "Hapus Semua Riwayat?", 
                "Apakah Anda yakin ingin menghapus <b>SEMUA</b> catatan riwayat transaksi gudang? <br><br><span class='text-rose-500 font-bold'>PERINGATAN: Stok barang TIDAK akan berubah (hanya hapus log).</span>",
                async () => {
                    const btn = document.getElementById('btn-delete-all-hist');
                    const originalText = btn ? btn.innerHTML : '';
                    if(btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    
                    try {
                        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'global_history'));
                        const snapshot = await getDocs(q);
                        
                        const batch = writeBatch(db);
                        let count = 0;
                        
                        snapshot.docs.forEach((doc) => {
                            const data = doc.data();
                            if (data.type === 'WAREHOUSE') {
                                batch.delete(doc.ref);
                                count++;
                            }
                        });

                        if(count > 0) {
                             await batch.commit();
                             showAlert("Berhasil", `Berhasil menghapus <b>${count}</b> riwayat transaksi gudang.`, "success");
                        } else {
                             showAlert("Info", "Tidak ada riwayat gudang untuk dihapus.", "info");
                        }
                    } catch (err) {
                        console.error(err);
                        showAlert("Error", "Gagal menghapus riwayat: " + err.message, "error");
                    } finally {
                         if(btn) btn.innerHTML = originalText || '<i class="fas fa-trash-alt mr-2"></i> Hapus Semua';
                    }
                },
                "danger"
            );
        };

        // --- HISTORY & RECEIPT ---
        window.renderWarehouseSpecificHistory = () => {
            const tbody = document.getElementById('wh-history-body');
            if(!tbody) return;
            tbody.innerHTML = '';

            if(warehouseSpecificHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-slate-500 italic">Belum ada riwayat transaksi gudang.</td></tr>';
                return;
            }

            warehouseSpecificHistory.forEach(h => {
                let badge = '';
                if(h.subtype === 'DEPOSIT') badge = '<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-500/20 text-blue-400 border border-blue-500/30">DP</span>';
                else if(h.subtype === 'WITHDRAW') badge = '<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-orange-500/20 text-orange-400 border border-orange-500/30">WD</span>';
                else if(h.subtype === 'BATCH') badge = '<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-purple-500/20 text-purple-400 border border-purple-500/30">BATCH</span>';
                else badge = '<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-700 text-slate-400">LOG</span>';

                const dateStr = h.timestamp ? new Date(h.timestamp.seconds*1000).toLocaleString('id-ID', {day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit'}) : '-';
                const imgBtn = h.image ? `<button onclick="showImagePreview('${h.image}')" class="text-blue-400 hover:text-blue-300 transition"><i class="fas fa-image"></i></button>` : '<span class="text-slate-600">-</span>';

                tbody.innerHTML += `
                    <tr class="border-b border-slate-800 hover:bg-slate-800/30 text-xs transition duration-150">
                        <td class="p-3 text-slate-400 whitespace-nowrap">${dateStr}</td>
                        <td class="p-3 font-bold text-slate-200">${h.itemName || '-'}</td>
                        <td class="p-3 text-center">${badge}</td>
                        <td class="p-3 text-center font-mono ${h.subtype === 'DEPOSIT' ? 'text-emerald-400' : 'text-rose-400'}">${h.amount || 0}</td>
                        <td class="p-3 text-center text-slate-500">${h.before !== undefined ? h.before : '-'}</td>
                        <td class="p-3 text-center text-slate-300 font-bold">${h.after !== undefined ? h.after : '-'}</td>
                        <td class="p-3 text-slate-400">${h.pic || '-'}</td>
                        <td class="p-3 text-slate-500 italic truncate max-w-[100px]" title="${h.note || ''}">${h.note || '-'}</td>
                        <td class="p-3 text-center">${imgBtn}</td>
                        <td class="p-3 text-center flex justify-center gap-2">
                            <button onclick="takeRowScreenshot('${h.id}')" class="text-slate-500 hover:text-blue-400 transition" title="Print Struk"><i class="fas fa-print"></i></button>
                            <button onclick="rollbackLog('${h.id}')" class="text-slate-600 hover:text-rose-500 transition" title="Hapus & Rollback Stok"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            });
        };

        window.takeRowScreenshot = (id) => {
            const log = warehouseSpecificHistory.find(l => l.id === id);
            if (!log) return;

            const originalTpl = document.getElementById('receiptTemplate');
            // Clone dan siapkan template
            const tpl = originalTpl.cloneNode(true);
            
            // Populate Data SEBELUM menghapus ID agar mudah selector-nya
            const dateVal = log.timestamp ? new Date(log.timestamp.seconds*1000).toLocaleString('id-ID', {day: 'numeric', month: 'short', year:'numeric', hour: '2-digit', minute:'2-digit'}) : '-';
            
            tpl.querySelector('#recDate').textContent = dateVal;
            tpl.querySelector('#recPIC').textContent = log.pic || '-';
            tpl.querySelector('#recID').textContent = log.id.substring(0,8).toUpperCase();
            
            let cleanDesc = log.desc || '-';
            if (log.subtype === 'BATCH' && log.desc.includes('---')) cleanDesc = log.desc.split('---')[0];
            tpl.querySelector('#recDesc').textContent = cleanDesc;

            const recType = tpl.querySelector('#recType');
            const singleContainer = tpl.querySelector('#recSingleContainer');
            const batchContainer = tpl.querySelector('#recBatchContainer');
            
             if (log.subtype === 'BATCH') {
                recType.textContent = 'BATCH UPDATE';
                recType.className = 'inline-block px-3 py-1 rounded border-2 font-bold border-purple-500 text-purple-800 bg-purple-50';
                singleContainer.classList.add('hidden');
                batchContainer.classList.remove('hidden');

                const tbody = tpl.querySelector('#recBatchBody');
                tbody.innerHTML = '';

                if (log.details && log.details.length > 0) {
                    log.details.forEach(d => {
                        const isDepo = d.type === 'DEPOSIT';
                        const colorClass = isDepo ? 'text-green-600' : 'text-orange-600';
                        const sign = isDepo ? '+' : '-';
                        const badgeColor = isDepo ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800';
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="py-2 px-3">
                                <div class="font-bold text-gray-700">${d.name}</div>
                                <div class="text-[10px] text-gray-400 mt-0.5">Stok: ${d.before} <i class="fas fa-arrow-right mx-1"></i> <b>${d.after}</b></div>
                            </td>
                            <td class="py-2 px-3 text-right align-top">
                                <div class="font-bold text-lg ${colorClass}">${sign}${d.amount}</div>
                                <span class="text-[9px] font-bold uppercase px-1.5 py-0.5 rounded ${badgeColor}">${isDepo ? 'DP' : 'WD'}</span>
                            </td>`;
                        tbody.appendChild(tr);
                    });
                } else { tbody.innerHTML = `<tr><td colspan="2" class="p-3 text-center text-gray-400 italic">Detail item tidak tersedia.</td></tr>`; }
            } else {
                singleContainer.classList.remove('hidden');
                batchContainer.classList.add('hidden');
                let typeText = 'SETUP';
                let typeClass = 'border-gray-300 text-gray-700 bg-gray-50';
                let amountColor = 'text-gray-800';
                let amountSign = '';
                let badgeBg = 'bg-gray-400';

                if (log.subtype === 'DEPOSIT') { typeText = 'INBOUND (DP)'; typeClass = 'border-blue-500 text-blue-800 bg-blue-50'; amountColor = 'text-green-600'; amountSign = '+'; badgeBg = 'bg-blue-600'; }
                else if (log.subtype === 'WITHDRAW') { typeText = 'OUTBOUND (WD)'; typeClass = 'border-orange-500 text-orange-800 bg-orange-50'; amountColor = 'text-orange-600'; amountSign = '-'; badgeBg = 'bg-orange-600'; }
                
                recType.textContent = typeText;
                recType.className = `inline-block px-3 py-1 rounded border-2 font-bold ${typeClass}`;
                tpl.querySelector('#recItem').textContent = log.itemName;
                const amountEl = tpl.querySelector('#recAmount');
                amountEl.textContent = `${amountSign}${log.amount}`;
                amountEl.className = `block text-2xl font-bold ${amountColor}`;
                const badgeEl = tpl.querySelector('#recBadge');
                badgeEl.textContent = log.subtype || 'LOG';
                badgeEl.className = `block text-[10px] font-bold uppercase mt-1 px-2 py-0.5 rounded text-white ${badgeBg}`;
                tpl.querySelector('#recBefore').textContent = log.before !== undefined ? log.before : '-';
                tpl.querySelector('#recAfter').textContent = log.after !== undefined ? log.after : '-';
            }

            const imgCont = tpl.querySelector('#receiptImgCont');
            const imgEl = tpl.querySelector('#receiptImg');
            if (log.image) { imgCont.classList.remove('hidden'); imgEl.src = log.image; } else { imgCont.classList.add('hidden'); }

            // Tampilkan dan Bersihkan ID untuk menghindari konflik
            tpl.classList.remove('hidden');
            tpl.style.width = "100%"; 
            tpl.style.boxShadow = "none";
            
            // Hapus ID dari elemen di dalam clone agar tidak duplikat di DOM
            const allNodes = tpl.querySelectorAll('*');
            allNodes.forEach(node => {
                if(node.id) node.removeAttribute('id');
            });
            tpl.removeAttribute('id'); // Hapus ID container utama

            const container = document.getElementById('reportPreviewContainer');
            container.innerHTML = ''; 
            container.appendChild(tpl);
            
            // Set global variable untuk fungsi download
            currentReportElement = tpl; 
            document.getElementById('reportModal').classList.remove('hidden');
        };

        // PERBAIKAN LISTENER DOWNLOAD SCREENSHOT
        document.getElementById('btnDownloadReport').onclick = () => {
            if(!currentReportElement) return;
            const btn = document.getElementById('btnDownloadReport');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
            btn.disabled = true;
            
            html2canvas(currentReportElement, { 
                scale: 2, 
                backgroundColor: '#ffffff', 
                useCORS: true, 
                logging: false 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Struk_Transaksi_${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                showToast("Laporan berhasil diunduh!", "success");
            }).catch(err => { 
                console.error(err); 
                showAlert("Gagal Download", err.message, "error"); 
            }).finally(() => { 
                btn.innerHTML = originalText; 
                btn.disabled = false; 
            });
        };

        window.closeReportModal = () => document.getElementById('reportModal').classList.add('hidden');

        // PERBAIKAN FITUR DELETE / ROLLBACK
        window.rollbackLog = async (logId) => {
            const log = warehouseSpecificHistory.find(l => l.id === logId);
            if(!log) return;

            showConfirm(
                "Hapus & Rollback?", 
                `Apakah Anda yakin ingin menghapus transaksi ini? <br><br><span class='text-rose-500 font-bold'>PERINGATAN: Stok '${log.itemName}' akan dikembalikan (Rollback).</span>`,
                async () => {
                     try {
                        const batch = writeBatch(db);
                        const logRef = doc(db, 'artifacts', appId, 'public', 'data', 'global_history', logId);
                        
                        // Hapus Log
                        batch.delete(logRef);

                        // Proses Rollback Stok jika bukan Batch
                        if (log.subtype !== 'BATCH') {
                            const currentItemStock = warehouseStock[log.itemName] || 0;
                            let revertedStock = currentItemStock;

                            if (log.subtype === 'DEPOSIT') {
                                revertedStock -= log.amount; 
                            } else if (log.subtype === 'WITHDRAW') {
                                revertedStock += log.amount;
                            }

                            if (revertedStock < 0) revertedStock = 0;
                            
                            // Update Stok Utama
                            // Kita update warehouseStock lokal dulu lalu kirim full object (cara sederhana app ini)
                            const updatedStock = { ...warehouseStock, [log.itemName]: revertedStock };
                            const stockRef = doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock');
                            batch.set(stockRef, updatedStock);
                        } else {
                            // Jika Batch, hanya hapus log (user diperingatkan)
                            // Jika ingin implementasi rollback batch, perlu logic kompleks per item
                        }

                        await batch.commit();
                        showAlert("Berhasil", "Transaksi dihapus & stok dikembalikan.", "success");
                    } catch (err) {
                        console.error(err);
                        showAlert("Error", "Gagal rollback: " + err.message, "error");
                    }
                },
                "danger"
            );
        };

        window.showImagePreview = (src) => { document.getElementById('preview-img-content').src = src; document.getElementById('image-preview-modal').classList.remove('hidden'); };
        window.closeImagePreview = () => document.getElementById('image-preview-modal').classList.add('hidden');

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 500;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        // --- COMMON MODAL ACTIONS ---
        window.openActionModal = (action, itemName) => {
            currentAction = action;
            currentTargetItem = itemName;
            const modal = document.getElementById('universal-modal');
            const title = document.getElementById('modal-title');
            const desc = document.getElementById('modal-desc');
            const groupName = document.getElementById('input-group-name');
            const groupQty = document.getElementById('input-group-qty');
            const groupPic = document.getElementById('input-group-pic');
            const groupImg = document.getElementById('input-group-img');
            const inputName = document.getElementById('modal-input-name');
            const inputQty = document.getElementById('modal-input-qty');
            const btnConfirm = document.getElementById('btn-modal-confirm');

            modal.classList.remove('hidden');
            inputName.value = itemName;
            inputQty.value = '';
            document.getElementById('modal-input-pic').value = '';
            document.getElementById('modal-input-note').value = '';
            document.getElementById('modal-input-img').value = '';
            
            desc.classList.add('hidden');
            groupPic.classList.add('hidden');
            groupImg.classList.add('hidden');
            
            if (action === 'DP') {
                title.innerText = `Deposit (Masuk): ${itemName}`;
                groupName.classList.add('hidden');
                groupQty.classList.remove('hidden');
                groupPic.classList.remove('hidden');
                groupImg.classList.remove('hidden');
                btnConfirm.innerText = "Tambah Stok";
                btnConfirm.className = "flex-1 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-500 font-bold";
            } else if (action === 'WD') {
                title.innerText = `Withdraw (Keluar): ${itemName}`;
                groupName.classList.add('hidden');
                groupQty.classList.remove('hidden');
                groupPic.classList.remove('hidden');
                groupImg.classList.remove('hidden');
                btnConfirm.innerText = "Kurangi Stok";
                btnConfirm.className = "flex-1 py-2 bg-orange-600 text-white rounded hover:bg-orange-500 font-bold";
            } else if (action === 'EDIT') {
                title.innerText = `Edit Resource: ${itemName}`;
                groupName.classList.remove('hidden');
                groupQty.classList.remove('hidden');
                document.getElementById('label-qty').innerText = "Stok Baru (Opname)";
                inputQty.value = warehouseStock[itemName]; 
                btnConfirm.innerText = "Simpan Perubahan";
                btnConfirm.className = "flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 font-bold";
            } else if (action === 'DELETE') {
                title.innerText = `Hapus Resource: ${itemName}`;
                desc.innerText = "Tindakan ini permanen. Stok akan dihapus dari sistem.";
                desc.classList.remove('hidden');
                groupName.classList.add('hidden');
                groupQty.classList.add('hidden');
                btnConfirm.innerText = "Ya, Hapus";
                btnConfirm.className = "flex-1 py-2 bg-rose-600 text-white rounded hover:bg-rose-500 font-bold";
            }
        };

        window.closeModal = () => {
            document.getElementById('universal-modal').classList.add('hidden');
            currentAction = null;
            currentTargetItem = null;
        };

        window.confirmModalAction = async () => {
            const name = currentTargetItem;
            const inputNameVal = document.getElementById('modal-input-name').value.trim().toUpperCase();
            const qtyVal = parseFloat(document.getElementById('modal-input-qty').value);
            const picVal = document.getElementById('modal-input-pic').value || '-';
            const noteVal = document.getElementById('modal-input-note').value || '-';
            const imgInput = document.getElementById('modal-input-img');
            const currentQty = warehouseStock[name] || 0;

            const btn = document.getElementById('btn-modal-confirm');
            const originalText = btn.innerText;
            btn.innerText = "Processing...";
            btn.disabled = true;

            try {
                let imgData = null;
                if (imgInput.files[0]) imgData = await compressImage(imgInput.files[0]);

                if (currentAction === 'DELETE') {
                    showConfirm("Konfirmasi Hapus", `Yakin ingin menghapus <b>${name}</b> permanen?`, async () => {
                         const updated = { ...warehouseStock };
                        delete updated[name];
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), updated);
                        await addLog({ type: 'WAREHOUSE', subtype: 'DELETE', itemName: name, desc: `Hapus Bahan`, amount: 0, before: currentQty, after: 0, pic: 'Admin' });
                        showAlert("Sukses", `Item ${name} berhasil dihapus.`, "success");
                        closeModal();
                    }, "danger");
                } 
                else if (currentAction === 'DP') {
                    if (isNaN(qtyVal) || qtyVal <= 0) throw new Error("Jumlah harus > 0");
                    const newStock = { ...warehouseStock, [name]: currentQty + qtyVal };
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), newStock);
                    await addLog({ type: 'WAREHOUSE', subtype: 'DEPOSIT', itemName: name, desc: `Deposit Manual`, amount: qtyVal, before: currentQty, after: currentQty + qtyVal, pic: picVal, note: noteVal, image: imgData });
                    showAlert("Sukses", "Stok berhasil ditambahkan.", "success");
                    closeModal();
                } 
                else if (currentAction === 'WD') {
                    if (isNaN(qtyVal) || qtyVal <= 0) throw new Error("Jumlah harus > 0");
                    if (qtyVal > currentQty) throw new Error("Stok tidak cukup!");
                    const newStock = { ...warehouseStock, [name]: currentQty - qtyVal };
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), newStock);
                    await addLog({ type: 'WAREHOUSE', subtype: 'WITHDRAW', itemName: name, desc: `Withdraw Manual`, amount: qtyVal, before: currentQty, after: currentQty - qtyVal, pic: picVal, note: noteVal, image: imgData });
                    showAlert("Sukses", "Stok berhasil dikurangi.", "success");
                    closeModal();
                }
                else if (currentAction === 'EDIT') {
                    if (!inputNameVal) throw new Error("Nama tidak boleh kosong");
                    if (isNaN(qtyVal) || qtyVal < 0) throw new Error("Stok tidak valid");
                    const updated = { ...warehouseStock };
                    if (inputNameVal !== name) delete updated[name];
                    updated[inputNameVal] = qtyVal;
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), updated);
                    await addLog({ type: 'WAREHOUSE', subtype: 'EDIT', itemName: inputNameVal, desc: `Opname Stok`, amount: 0, before: currentQty, after: qtyVal, pic: 'Admin' });
                    showAlert("Sukses", "Data resource berhasil diperbarui.", "success");
                    closeModal();
                }
            } catch (err) {
                showAlert("Error", err.message, "error");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        // Helper: Calculate cost price from recipe
        window.calculateCostFromRecipe = (productName) => {
            const recipe = recipes[productName];
            if (!recipe || !recipe.requirements) return 0;
            
            let totalCost = 0;
            Object.entries(recipe.requirements).forEach(([material, qty]) => {
                const materialPrice = materialPrices[material] || 0;
                totalCost += materialPrice * qty;
            });
            
            return totalCost;
        };

        // ==========================================
        // MODULE 6: INVENTORY MANAGEMENT
        // ==========================================
        
        window.renderInventoryTable = () => {
            const tbody = document.getElementById('inventory-table-body');
            const searchInput = document.getElementById('inventory-search');
            const filterClass = document.getElementById('inventory-filter-class');
            const filterStock = document.getElementById('inventory-filter-stock');
            
            if(!tbody) return;
            
            let filtered = productStock;
            
            // Filter by search
            if(searchInput && searchInput.value) {
                const search = searchInput.value.toUpperCase();
                filtered = filtered.filter(p => p.name.toUpperCase().includes(search));
            }
            
            // Filter by class
            if(filterClass && filterClass.value && filterClass.value !== 'SEMUA') {
                filtered = filtered.filter(p => (p.weaponClass || p.category) === filterClass.value);
            }
            
            // Filter by stock status
            if(filterStock && filterStock.value && filterStock.value !== 'SEMUA') {
                const stockFilter = filterStock.value;
                if(stockFilter === 'READY') filtered = filtered.filter(p => p.stock > 0);
                else if(stockFilter === 'EMPTY') filtered = filtered.filter(p => p.stock === 0);
                else if(stockFilter === 'LOW') filtered = filtered.filter(p => p.stock > 0 && p.stock < 5);
            }
            
            // Calculate stats
            let totalTypes = filtered.length;
            let totalStock = 0;
            let totalCostValue = 0;
            let totalSellValue = 0;
            
            if(filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-slate-500 italic">Tidak ada produk.</td></tr>';
                updateInventoryStats(0, 0, 0, 0);
                return;
            }
            
            try {
                tbody.innerHTML = filtered.map(p => {
                    const wClass = p.weaponClass || p.category || 'Umum';
                    let badgeColor = 'bg-slate-700 text-slate-300';
                    
                    if(wClass === 'KELAS 1') badgeColor = 'bg-red-900/50 text-red-300 border border-red-700';
                    else if(wClass === 'KELAS 2') badgeColor = 'bg-orange-900/50 text-orange-300 border border-orange-700';
                    else if(wClass === 'KELAS 3') badgeColor = 'bg-yellow-900/50 text-yellow-300 border border-yellow-700';
                    else if(wClass === 'KELAS 4') badgeColor = 'bg-green-900/50 text-green-300 border border-green-700';
                    else if(wClass === 'AKSESORIS') badgeColor = 'bg-purple-900/50 text-purple-300 border border-purple-700';
                    
                    // Calculate cost from recipe
                    const calculatedCost = calculateCostFromRecipe(p.name);
                    const displayCost = calculatedCost > 0 ? calculatedCost : (p.costPrice || 0);
                    const profit = p.sellingPrice - displayCost;
                    const totalValue = displayCost * p.stock;
                    const totalSell = p.sellingPrice * p.stock;
                    
                    // Update stats
                    totalStock += p.stock;
                    totalCostValue += totalValue;
                    totalSellValue += totalSell;
                    
                    // Stock status styling
                    let stockClass = 'text-emerald-400';
                    if(p.stock === 0) stockClass = 'text-rose-500 font-bold';
                    else if(p.stock < 5) stockClass = 'text-yellow-400 font-bold';
                    
                    return `
                        <tr class="border-b border-slate-700 hover:bg-slate-700/30 transition">
                            <td class="p-3">
                                <div class="font-bold text-slate-200">${p.name}</div>
                            </td>
                            <td class="p-3 text-center">
                                <span class="text-[9px] ${badgeColor} px-2 py-1 rounded font-bold uppercase">${wClass}</span>
                            </td>
                            <td class="p-3 text-right font-mono ${stockClass}">${p.stock.toLocaleString()}</td>
                            <td class="p-3 text-right font-mono text-yellow-400">Rp ${displayCost.toLocaleString()}</td>
                            <td class="p-3 text-right font-mono text-emerald-400">Rp ${p.sellingPrice.toLocaleString()}</td>
                            <td class="p-3 text-right font-mono ${profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}">Rp ${profit.toLocaleString()}</td>
                            <td class="p-3 text-right font-mono text-slate-300">Rp ${totalValue.toLocaleString()}</td>
                            <td class="p-3 text-center">
                                <button onclick="deleteInventoryProduct('${p.id}', '${p.name}')" class="text-rose-400 hover:text-white transition p-2 rounded hover:bg-rose-600/20" title="Hapus Produk">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                updateInventoryStats(totalTypes, totalStock, totalCostValue, totalSellValue);
            } catch(err) {
                console.error('Error rendering inventory:', err);
                tbody.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-rose-500">Error menampilkan data. Cek console.</td></tr>';
            }
        };
        
        const updateInventoryStats = (types, stock, cost, sell) => {
            document.getElementById('inv-total-types').textContent = types.toLocaleString();
            document.getElementById('inv-total-stock').textContent = stock.toLocaleString();
            document.getElementById('inv-total-cost').textContent = 'Rp ' + cost.toLocaleString();
            document.getElementById('inv-total-potential').textContent = 'Rp ' + sell.toLocaleString();
        };
        
        window.deleteInventoryProduct = (productId, productName) => {
            showConfirm(
                "Hapus Produk dari Inventori?",
                `Apakah Anda yakin ingin menghapus <b>${productName}</b> dari inventori?<br><br>` +
                `<span class='text-rose-500 font-bold'>PERINGATAN:</span><br>` +
                `<ul class='list-disc list-inside text-left mt-2 space-y-1 text-sm'>` +
                `<li>Produk akan dihapus dari sistem</li>` +
                `<li>Produk akan hilang dari Toko Senjata (POS)</li>` +
                `<li>Resep produksi tetap tersimpan</li>` +
                `<li>Riwayat transaksi tetap tersimpan</li>` +
                `</ul>`,
                async () => {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', productId));
                        
                        // Immediately update local state to reflect deletion
                        productStock = productStock.filter(p => p.id !== productId);
                        
                        // Re-render both views
                        renderInventoryTable();
                        renderPosGrid();
                        
                        showAlert("Berhasil", `Produk ${productName} berhasil dihapus dari inventori.`, "success");
                    } catch(err) {
                        console.error(err);
                        showAlert("Error", "Gagal menghapus produk: " + err.message, "error");
                    }
                },
                "danger"
            );
        };
        
        window.downloadInventoryReport = async () => {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating...';
            btn.disabled = true;

            try {
                const exportContainer = document.createElement('div');
                exportContainer.style.position = 'absolute';
                exportContainer.style.top = '-9999px';
                exportContainer.style.left = '-9999px';
                exportContainer.style.width = '800px';
                exportContainer.style.backgroundColor = '#1e293b';
                exportContainer.style.color = '#fff';
                exportContainer.style.padding = '30px';
                exportContainer.style.borderRadius = '12px';
                exportContainer.style.fontFamily = 'Inter, sans-serif';
                
                const date = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });
                
                // Calculate totals
                let totalTypes = productStock.length;
                let totalStock = 0;
                let totalCost = 0;
                let totalSell = 0;
                
                let rows = '';
                if(totalTypes === 0) {
                    rows = '<tr><td colspan="6" class="p-4 text-center text-slate-500 italic">Tidak ada produk</td></tr>';
                } else {
                    rows = productStock.map(p => {
                        const calculatedCost = calculateCostFromRecipe(p.name);
                        const displayCost = calculatedCost > 0 ? calculatedCost : (p.costPrice || 0);
                        const profit = p.sellingPrice - displayCost;
                        const totalValue = displayCost * p.stock;
                        
                        totalStock += p.stock;
                        totalCost += totalValue;
                        totalSell += p.sellingPrice * p.stock;
                        
                        return `
                            <tr class="border-b border-slate-600/50">
                                <td class="py-2 px-3 font-bold text-slate-200">${p.name}</td>
                                <td class="py-2 px-3 text-center text-xs text-slate-400">${p.weaponClass || 'Umum'}</td>
                                <td class="py-2 px-3 text-right font-mono text-emerald-400">${p.stock}</td>
                                <td class="py-2 px-3 text-right font-mono text-yellow-400 text-xs">Rp ${displayCost.toLocaleString()}</td>
                                <td class="py-2 px-3 text-right font-mono text-slate-300 text-xs">Rp ${p.sellingPrice.toLocaleString()}</td>
                                <td class="py-2 px-3 text-right font-mono ${profit >= 0 ? 'text-emerald-400' : 'text-rose-400'} text-xs">Rp ${profit.toLocaleString()}</td>
                            </tr>
                        `;
                    }).join('');
                }

                exportContainer.innerHTML = `
                    <div class="mb-6 border-b-2 border-blue-500 pb-4 flex justify-between items-start">
                        <div>
                            <h2 class="text-3xl font-bold text-white tracking-tight">Laporan Inventori Senjata</h2>
                            <p class="text-sm text-blue-400 font-medium mt-1">Vikrama ERP System</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-400 uppercase font-bold">Waktu Generate</div>
                            <div class="text-sm text-white font-mono">${date}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-slate-800 p-3 rounded border border-slate-700">
                            <div class="text-xs text-slate-500 uppercase mb-1">Total Jenis</div>
                            <div class="text-xl font-bold text-white">${totalTypes}</div>
                        </div>
                        <div class="bg-slate-800 p-3 rounded border border-slate-700">
                            <div class="text-xs text-slate-500 uppercase mb-1">Total Unit</div>
                            <div class="text-xl font-bold text-white">${totalStock}</div>
                        </div>
                        <div class="bg-slate-800 p-3 rounded border border-slate-700">
                            <div class="text-xs text-slate-500 uppercase mb-1">Nilai Modal</div>
                            <div class="text-sm font-bold text-yellow-400">Rp ${totalCost.toLocaleString()}</div>
                        </div>
                        <div class="bg-slate-800 p-3 rounded border border-slate-700">
                            <div class="text-xs text-slate-500 uppercase mb-1">Potensi Jual</div>
                            <div class="text-sm font-bold text-emerald-400">Rp ${totalSell.toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-900/50 rounded-lg overflow-hidden border border-slate-700">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-700 text-xs text-slate-300 uppercase font-bold">
                                <tr>
                                    <th class="py-3 px-3 text-left">Nama Senjata</th>
                                    <th class="py-3 px-3 text-center">Kelas</th>
                                    <th class="py-3 px-3 text-right">Stok</th>
                                    <th class="py-3 px-3 text-right">H. Modal</th>
                                    <th class="py-3 px-3 text-right">H. Jual</th>
                                    <th class="py-3 px-3 text-right">Profit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-6 flex justify-between items-end text-[10px] text-slate-500 font-mono border-t border-slate-700 pt-4">
                        <span>Generated by Vikrama ERP - Inventory Module</span>
                        <span>Authorized Document</span>
                    </div>
                `;

                document.body.appendChild(exportContainer);

                const canvas = await html2canvas(exportContainer, {
                    backgroundColor: '#0f172a',
                    scale: 2,
                    logging: false
                });

                document.body.removeChild(exportContainer);
                const link = document.createElement('a');
                link.download = `Laporan_Inventori_Senjata_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast("Laporan inventori berhasil diunduh!", "success");

            } catch (err) {
                console.error(err);
                showAlert("Gagal", "Terjadi kesalahan: " + err.message, "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
        // ==========================================
        // MODULE 2: CRAFTING (PERAKITAN)
        // ==========================================
        
        window.renderCraftingInputs = () => {
            const container = document.getElementById('cr-inputs');
            if(!container) return; // Safety check if element doesn't exist yet

            if(Object.keys(warehouseStock).length === 0) {
                container.innerHTML = '<p class="text-xs text-slate-500 col-span-2">Belum ada bahan di Gudang. Input di menu Warehouse dulu.</p>';
                return;
            }
            container.innerHTML = Object.keys(warehouseStock).sort().map(mat => `
                <div class="flex flex-col">
                    <label class="text-[10px] text-slate-400 font-bold mb-1">${mat}</label>
                    <input type="number" step="any" min="0" data-material="${mat}" placeholder="Butuh brp?" 
                        class="recipe-input bg-slate-800 border border-slate-700 rounded p-2 text-xs focus:border-blue-500 outline-none text-white">
                </div>
            `).join('');
        };

        window.saveRecipe = async (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('cr-name');
            const name = nameInput.value.trim().toUpperCase();
            const isEditing = nameInput.getAttribute('data-editing') === 'true';
            const originalName = nameInput.getAttribute('data-original-name');
            
            const sellPrice = 0; // Default to 0 since input is removed
            const inputs = document.querySelectorAll('.recipe-input');
            const requirements = {};
            
            inputs.forEach(input => {
                const val = parseFloat(input.value);
                if(val > 0) requirements[input.dataset.material] = val;
            });

            if(!name) return showAlert("Validasi", "Nama produk harus diisi!", "warning");
            if(Object.keys(requirements).length === 0) return showAlert("Validasi", "Pilih minimal 1 bahan!", "warning");

            try {
                // If editing and name changed, delete old recipe
                if(isEditing && originalName && originalName !== name) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'recipes', originalName));
                }
                
                // Save/update recipe
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'recipes', name), {
                    requirements,
                    sellingPrice: sellPrice
                });
                
                document.getElementById('cr-form').reset();
                nameInput.removeAttribute('data-editing');
                nameInput.removeAttribute('data-original-name');
                
                showAlert("Sukses", `Resep ${name} berhasil ${isEditing ? 'diupdate' : 'disimpan'}.`, "success");
                closeRecipeModal();
            } catch(err) {
                console.error(err);
                showAlert("Error", "Gagal menyimpan resep: " + err.message, "error");
            }
        };

        window.renderRecipeTable = () => {
             const container = document.getElementById('cr-recipe-list');
             if(!container) return;

             const keys = Object.keys(recipes);
             if (keys.length === 0) {
                 container.innerHTML = '<div class="text-center text-slate-500 text-xs py-8 italic border-2 border-dashed border-slate-700 rounded-lg">Belum ada resep aktif.</div>';
             } else {
                container.innerHTML = keys.map(name => {
                    const rec = recipes[name];
                    const reqs = Object.entries(rec.requirements).map(([m,q]) => {
                        const currentStock = warehouseStock[m] || 0;
                        const isEnough = currentStock >= q;
                        const stockColor = isEnough ? 'text-slate-400' : 'text-rose-500 font-bold';
                        
                        return `<div class="flex justify-between items-center text-xs text-slate-400 border-b border-slate-700/50 pb-1 mb-1 last:border-0 last:mb-0 last:pb-0">
                            <span>${m}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] ${stockColor} mr-1" title="Stok Gudang">${currentStock}</span>
                                <span class="font-mono text-emerald-400 font-bold bg-slate-900 px-1.5 rounded" title="Butuh per unit">${q}</span>
                            </div>
                        </div>`;
                    }).join('');

                    return `
                        <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 hover:border-purple-500/50 transition group shadow-sm recipe-card">
                            <div class="flex justify-between items-start mb-3 pb-2 border-b border-slate-700">
                                <h4 class="font-bold text-white text-sm uppercase tracking-wide flex items-center">
                                    <i class="fas fa-box-open text-purple-500 mr-2"></i> ${name}
                                </h4>
                                <div class="flex gap-1 recipe-card-actions">
                                    <button onclick='editRecipe("${name}")' class="text-slate-600 hover:text-blue-400 transition p-1.5 rounded hover:bg-slate-700" title="Edit Resep">
                                        <i class="fas fa-edit text-xs"></i>
                                    </button>
                                    <button onclick='deleteRecipe("${name}")' class="text-slate-600 hover:text-rose-500 transition p-1.5 rounded hover:bg-slate-700" title="Hapus Resep">
                                        <i class="fas fa-trash-alt text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="bg-slate-900/50 rounded p-2 border border-slate-800/50">
                                <div class="flex justify-between items-center mb-2 border-b border-slate-800 pb-1">
                                    <p class="text-[10px] uppercase font-bold text-slate-500">Komposisi Bahan</p>
                                    <p class="text-[9px] text-slate-500 italic">(Punya / Butuh)</p>
                                </div>
                                <div class="space-y-1">
                                    ${reqs}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('recipeListModal').classList.remove('hidden');
        };

        // --- NEW FEATURE: EDIT RECIPE ---
        window.editRecipe = (name) => {
            const rec = recipes[name];
            if (!rec) return;

            // Pastikan input bahan sudah dirender
            renderCraftingInputs();
            
            // Tunggu sebentar agar DOM sudah ready
            setTimeout(() => {
                // 1. Isi Nama Produk
                const nameInput = document.getElementById('cr-name');
                if(nameInput) {
                    nameInput.value = name;
                    // Make readonly to prevent rename confusion
                    nameInput.setAttribute('data-editing', 'true');
                    nameInput.setAttribute('data-original-name', name);
                }
                
                // 2. Reset semua input bahan
                document.querySelectorAll('.recipe-input').forEach(inp => inp.value = '');
                
                // 3. Isi input bahan sesuai resep
                Object.entries(rec.requirements).forEach(([mat, qty]) => {
                    const input = document.querySelector(`.recipe-input[data-material="${mat}"]`);
                    if(input) input.value = qty;
                });

                // 4. Buka Modal
                openRecipeModal("Edit Resep: " + name);
            }, 100);
        };

         window.deleteRecipe = async (name) => {
            showConfirm(
                "Hapus Resep?", 
                `Yakin ingin menghapus resep <b>${name}</b>? Produk yang sudah dibuat tidak akan terhapus.`, 
                async () => {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'recipes', name));
                        showAlert("Sukses", `Resep ${name} berhasil dihapus.`, "success");
                    } catch(err) {
                        console.error(err);
                        showAlert("Error", "Gagal menghapus resep: " + err.message, "error");
                    }
                }, 
                "danger"
            );
        };
        
        // --- NEW FEATURE: IMPORT RECIPE FROM EXCEL ---
        window.importRecipeExcel = async (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if (jsonData.length === 0) {
                        showAlert("File Kosong", "File Excel tidak berisi data.", "warning");
                        return;
                    }

                    // Structure: { "ProductName": { sellingPrice: 0, requirements: { "Mat": Qty } } }
                    const recipeMap = {};
                    let successCount = 0;

                    jsonData.forEach(row => {
                        // Flexible key matching
                        const prodName = (row['Nama Produk'] || row['Product'] || row['Name'])?.toString().trim().toUpperCase();
                        // Harga Jual diabaikan/diset 0 sesuai request
                        const price = 0; 
                        const matName = (row['Nama Bahan'] || row['Material'] || row['Bahan'])?.toString().trim().toUpperCase();
                        const matQty = parseFloat(row['Jumlah Bahan'] || row['Qty'] || row['Amount']) || 0;

                        if (prodName && matName && matQty > 0) {
                            if (!recipeMap[prodName]) {
                                recipeMap[prodName] = { requirements: {}, sellingPrice: price };
                            }
                            
                            recipeMap[prodName].requirements[matName] = matQty;
                        }
                    });

                    const batch = writeBatch(db);
                    const recipesToSave = Object.entries(recipeMap);

                    if(recipesToSave.length === 0) {
                        showAlert("Format Salah", "Tidak ada data resep valid. Pastikan kolom: 'Nama Produk', 'Nama Bahan', 'Jumlah Bahan'.", "error");
                        return;
                    }

                    recipesToSave.forEach(([name, data]) => {
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'recipes', name);
                        batch.set(ref, data);
                        successCount++;
                    });

                    await batch.commit();
                    
                    showAlert("Sukses", `Berhasil mengimport <b>${successCount}</b> resep produk!`, "success");
                    input.value = ''; // Reset input

                } catch (err) {
                    console.error(err);
                    showAlert("Gagal Import", "Gagal membaca file Excel resep: " + err.message, "error");
                }
            };
            reader.readAsArrayBuffer(file);
        };

        window.renderProductDropdown = () => {
            const options = '<option value="">-- Pilih Produk --</option>' + 
                Object.keys(recipes).map(r => `<option value="${r}">${r}</option>`).join('');
            
            // Dropdown untuk Produksi Massal
            const s1 = document.getElementById('cr-select-product');
            if(s1) s1.innerHTML = options;
        };

        window.renderGroupDropdown = () => {
            const select = document.getElementById('pos-group-select');
            if(!select) return;
            
            const options = '<option value="">-- Pilih Kelompok --</option>' + 
                groupDatabase.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            
            select.innerHTML = options;
        };
        // OPEN GROUP MANAGER MODAL
window.openGroupManager = () => {
    document.getElementById('groupManagerModal').classList.remove('hidden');
    
    // Render after modal animation
    setTimeout(() => {
        renderGroupTable();
    }, 100);
};

window.closeGroupManager = () => {
    document.getElementById('groupManagerModal').classList.add('hidden');
};

// RENDER GROUP TABLE
window.renderGroupTable = () => {
    const tbody = document.getElementById('group-table-body');
    if(!tbody) return;
    
    // Show loading state briefly
    tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-slate-400"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat data...</td></tr>';
    
    // Small delay to show data smoothly
    setTimeout(() => {
        if(groupDatabase.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-500 italic">Belum ada kelompok terdaftar. Klik "Tambah Kelompok" untuk memulai.</td></tr>';
            return;
        }
    
    tbody.innerHTML = groupDatabase.map(g => {
        const startDate = g.weekStart ? new Date(g.weekStart).toLocaleDateString('id-ID') : '-';
        const endDate = g.weekEnd ? new Date(g.weekEnd).toLocaleDateString('id-ID') : '-';
        
        // Calculate remaining limits with safety checks
        const remainingK1 = (g.limitKelas1 || 0) - (g.usedKelas1 || 0);
        const remainingK2 = (g.limitKelas2 || 0) - (g.usedKelas2 || 0);
        const remainingK3 = (g.limitKelas3 || 0) - (g.usedKelas3 || 0);
        const remainingK4 = (g.limitKelas4 || 0) - (g.usedKelas4 || 0);
        const remainingAcc = (g.limitAksesoris || 0) - (g.usedAksesoris || 0);
        
        return `
            <tr class="border-b border-slate-700 hover:bg-slate-700/30 transition text-xs">
                <td class="p-3 font-bold text-slate-200">${g.name}</td>
                <td class="p-3 text-slate-400">${startDate}</td>
                <td class="p-3 text-slate-400">${endDate}</td>
                <td class="p-3 text-center">
                    <span class="text-red-300">${remainingK1}/${g.limitKelas1 || 0}</span>
                </td>
                <td class="p-3 text-center">
                    <span class="text-orange-300">${remainingK2}/${g.limitKelas2 || 0}</span>
                </td>
                <td class="p-3 text-center">
                    <span class="text-yellow-300">${remainingK3}/${g.limitKelas3 || 0}</span>
                </td>
                <td class="p-3 text-center">
                    <div class="flex justify-center gap-2">
                        <button onclick="openEditGroupModal('${g.id}')" class="text-blue-400 hover:text-white transition" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteGroup('${g.id}', '${g.name}')" class="text-rose-400 hover:text-white transition" title="Hapus">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    }, 100); // Penutup setTimeout
};

// OPEN ADD GROUP MODAL
window.openAddGroupModal = () => {
    document.getElementById('group-form').reset();
    document.getElementById('group-modal-title').textContent = 'Tambah Kelompok Baru';
    document.getElementById('group-id-input').value = '';
    document.getElementById('addGroupModal').classList.remove('hidden');
    
    // Initialize date pickers after modal is shown
    setTimeout(() => {
        initGroupDatePickers();
    }, 100);
};

window.closeAddGroupModal = () => {
    document.getElementById('addGroupModal').classList.add('hidden');
};

// Initialize Date Pickers
window.initGroupDatePickers = () => {
    // Flatpickr for Start Date
    flatpickr("#group-week-start", {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d F Y",
        locale: {
            firstDayOfWeek: 1,
            weekdays: {
                shorthand: ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'],
                longhand: ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu']
            },
            months: {
                shorthand: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'],
                longhand: ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember']
            }
        },
        onChange: function(selectedDates, dateStr, instance) {
            // Auto-set end date to 7 days after start date
            if(selectedDates.length > 0) {
                const endDatePicker = document.getElementById('group-week-end')._flatpickr;
                const startDate = selectedDates[0];
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6); // 7 days period (including start date)
                
                endDatePicker.set('minDate', startDate);
                endDatePicker.setDate(endDate);
            }
        }
    });
    
    // Flatpickr for End Date
    flatpickr("#group-week-end", {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d F Y",
        locale: {
            firstDayOfWeek: 1,
            weekdays: {
                shorthand: ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'],
                longhand: ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu']
            },
            months: {
                shorthand: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'],
                longhand: ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember']
            }
        }
    });
};

// SAVE GROUP
window.saveGroupData = async (e) => {
    e.preventDefault();
    
    const groupId = document.getElementById('group-id-input').value;
    const name = document.getElementById('group-name').value.trim();

    // Get date values from Flatpickr
    const startPicker = document.getElementById('group-week-start')._flatpickr;
    const endPicker = document.getElementById('group-week-end')._flatpickr;

    const weekStart = startPicker.selectedDates.length > 0 ? 
        startPicker.formatDate(startPicker.selectedDates[0], 'Y-m-d') : '';
    const weekEnd = endPicker.selectedDates.length > 0 ? 
        endPicker.formatDate(endPicker.selectedDates[0], 'Y-m-d') : '';


    const limitKelas1 = parseInt(document.getElementById('group-limit-k1').value) || 0;
    const limitKelas2 = parseInt(document.getElementById('group-limit-k2').value) || 0;
    const limitKelas3 = parseInt(document.getElementById('group-limit-k3').value) || 0;
    const limitKelas4 = parseInt(document.getElementById('group-limit-k4').value) || 0;
    const limitAksesoris = parseInt(document.getElementById('group-limit-acc').value) || 0;
    
    if(!name) return showAlert("Error", "Nama kelompok harus diisi!", "warning");
    if(!weekStart || !weekEnd) return showAlert("Error", "Periode limit harus diisi!", "warning");
    
    try {
        const groupData = {
            name,
            weekStart,
            weekEnd,
            limitKelas1,
            limitKelas2,
            limitKelas3,
            limitKelas4,
            limitAksesoris,
            usedKelas1: 0,
            usedKelas2: 0,
            usedKelas3: 0,
            usedKelas4: 0,
            usedAksesoris: 0
        };
        
        if(groupId) {
    // Update - preserve existing usage
    const existingGroup = groupDatabase.find(g => g.id === groupId);
    if(existingGroup) {
        groupData.usedKelas1 = existingGroup.usedKelas1 || 0;
        groupData.usedKelas2 = existingGroup.usedKelas2 || 0;
        groupData.usedKelas3 = existingGroup.usedKelas3 || 0;
        groupData.usedKelas4 = existingGroup.usedKelas4 || 0;
        groupData.usedAksesoris = existingGroup.usedAksesoris || 0;
    }
    
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', groupId), groupData);
    showAlert("Berhasil", "Data kelompok berhasil diupdate!", "success");
} else {
    // Add new
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'groups'), groupData);
    showAlert("Berhasil", "Kelompok baru berhasil ditambahkan!", "success");
}

closeAddGroupModal();

// TAMBAHKAN INI - Auto refresh table after save
setTimeout(() => {
    renderGroupTable();
}, 500);
    } catch(err) {
        console.error(err);
        showAlert("Error", "Gagal menyimpan data: " + err.message, "error");
    }
};

// EDIT GROUP
window.openEditGroupModal = (groupId) => {
    const group = groupDatabase.find(g => g.id === groupId);
    if(!group) return;
    
    document.getElementById('group-modal-title').textContent = 'Edit Data Kelompok';
    document.getElementById('group-id-input').value = groupId;
    document.getElementById('group-name').value = group.name;
    
    document.getElementById('group-limit-k1').value = group.limitKelas1 || 0;
    document.getElementById('group-limit-k2').value = group.limitKelas2 || 0;
    document.getElementById('group-limit-k3').value = group.limitKelas3 || 0;
    document.getElementById('group-limit-k4').value = group.limitKelas4 || 0;
    document.getElementById('group-limit-acc').value = group.limitAksesoris || 0;
    
    document.getElementById('addGroupModal').classList.remove('hidden');
    
    // Initialize and set date picker values
    setTimeout(() => {
        initGroupDatePickers();
        
        if(group.weekStart) {
            document.getElementById('group-week-start')._flatpickr.setDate(group.weekStart);
        }
        if(group.weekEnd) {
            document.getElementById('group-week-end')._flatpickr.setDate(group.weekEnd);
        }
    }, 100);
};

// DELETE GROUP
window.deleteGroup = (groupId, groupName) => {
    showConfirm("Hapus Kelompok?", `Yakin ingin menghapus kelompok <b>${groupName}</b>?`, async () => {
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', groupId));
            showAlert("Berhasil", "Kelompok berhasil dihapus.", "success");
            
            // TAMBAHKAN INI - Auto refresh table after delete
            setTimeout(() => {
                renderGroupTable();
            }, 500);
        } catch(err) {
            console.error(err);
            showAlert("Error", "Gagal menghapus: " + err.message, "error");
        }
    }, "danger");
};

        // NEW FUNCTION: GENERIC ELEMENT SCREENSHOT
        window.takeElementScreenshot = async (elementId, fileNamePrefix) => {
            const element = document.getElementById(elementId);
            if (!element) return;

            try {
                // Visual feedback (cursor wait)
                document.body.style.cursor = 'wait';
                
                const canvas = await html2canvas(element, {
                    backgroundColor: '#1e293b', // Match dark theme slate-800
                    scale: 2, 
                    logging: false,
                    ignoreElements: (el) => el.tagName === 'BUTTON' // Optional: Hide buttons in screenshot
                });

                const link = document.createElement('a');
                link.download = `${fileNamePrefix}_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast("Screenshot berhasil disimpan!", "success");
            } catch (err) {
                console.error(err);
                showAlert("Gagal", "Screenshot error: " + err.message, "error");
            } finally {
                document.body.style.cursor = 'default';
            }
        };

        // --- NEW CRAFTING QUEUE LOGIC ---
        
        window.addToCraftQueue = () => {
            const prod = document.getElementById('cr-select-product').value;
            const qty = parseInt(document.getElementById('cr-qty').value) || 1;
            
            if(!prod) return showAlert("Error", "Pilih produk terlebih dahulu.", "warning");
            if(qty <= 0) return showAlert("Error", "Jumlah harus minimal 1.", "warning");

            // Check if item already in queue
            const existingItem = craftQueue.find(item => item.name === prod);
            if(existingItem) {
                existingItem.qty += qty;
            } else {
                craftQueue.push({ name: prod, qty: qty });
            }
            
            renderCraftQueue();
            // Reset quantity input but keep product selected
            document.getElementById('cr-qty').value = 1;
        };

        window.removeFromCraftQueue = (index) => {
            craftQueue.splice(index, 1);
            renderCraftQueue();
        };

        window.resetCraftQueue = () => {
            craftQueue = [];
            renderCraftQueue();
        };

        window.renderCraftQueue = () => {
            const listContainer = document.getElementById('cr-queue-list');
            const wrapper = document.getElementById('total-estimation-wrapper'); // Gunakan wrapper utama
            const btnProcess = document.getElementById('btn-process-queue');
            
            // --- 1. RENDER QUEUE LIST ---
            if (craftQueue.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-slate-500 text-xs italic py-4">Antrean kosong. Tambahkan produk.</div>';
                
                // Render Empty Summary
                if(wrapper) {
                    wrapper.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-[11px] font-bold text-slate-400 uppercase flex items-center gap-2">
                                <i class="fas fa-calculator"></i> Total Estimasi Bahan
                            </h4>
                            <button class="text-slate-600 cursor-not-allowed rounded px-2 py-1 transition">
                                <i class="fas fa-camera text-xs"></i>
                            </button>
                        </div>
                        <div class="text-center text-slate-500 text-xs italic">Belum ada estimasi.</div>
                    `;
                }

                btnProcess.disabled = true;
                btnProcess.className = "w-full bg-slate-700 text-slate-500 font-bold p-3 rounded cursor-not-allowed";
                btnProcess.innerHTML = "ANTREAN KOSONG";
                return;
            }

            // Tampilkan resep terpisah per item di antrean
            listContainer.innerHTML = craftQueue.map((item, idx) => {
                const rec = recipes[item.name];
                let ingredientsHtml = '';
                
                if (rec) {
                    ingredientsHtml = '<div class="mt-2 pt-2 border-t border-slate-600/50 grid grid-cols-2 gap-x-4 gap-y-1">';
                    Object.entries(rec.requirements).forEach(([mat, baseReq]) => {
                        const totalReqItem = baseReq * item.qty;
                        ingredientsHtml += `
                            <div class="flex justify-between items-center text-[10px]">
                                <span class="text-slate-400">${mat}</span>
                                <span class="font-mono text-purple-300 font-bold">${totalReqItem}</span>
                            </div>
                        `;
                    });
                    ingredientsHtml += '</div>';
                }

                return `
                <div id="queue-item-${idx}" class="bg-slate-700/40 p-3 rounded-lg border border-slate-600 mb-3 relative group hover:border-purple-500/50 transition">
                    <button onclick="removeFromCraftQueue(${idx})" class="absolute top-2 right-2 text-slate-500 hover:text-rose-500 transition" title="Hapus dari antrean">
                        <i class="fas fa-times"></i>
                    </button>
                    <button onclick="takeElementScreenshot('queue-item-${idx}', 'Rincian_${item.name}')" class="absolute top-2 right-8 text-slate-400 hover:text-white transition" title="Screenshot Kartu Ini">
                        <i class="fas fa-camera text-xs"></i>
                    </button>
                    <div class="flex items-baseline gap-2 mb-1">
                        <h4 class="font-bold text-white text-sm uppercase text-blue-400">${item.name}</h4>
                        <span class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-bold">x${item.qty}</span>
                    </div>
                    ${ingredientsHtml}
                </div>
            `;}).join('');

            // --- 2. CALCULATE RESOURCES ---
            const totalResources = {};
            craftQueue.forEach(item => {
                const rec = recipes[item.name];
                if(rec) {
                    Object.entries(rec.requirements).forEach(([mat, req]) => {
                        const totalReq = req * item.qty;
                        totalResources[mat] = (totalResources[mat] || 0) + totalReq;
                    });
                }
            });

            // --- 3. RENDER RESOURCE SUMMARY ---
            let allAvailable = true;
            let summaryHTML = '<div class="grid grid-cols-1 gap-2">'; 
            
            Object.entries(totalResources).forEach(([mat, req]) => {
                const stock = warehouseStock[mat] || 0;
                const isEnough = stock >= req;
                if(!isEnough) allAvailable = false;
                
                const colorClass = isEnough ? 'text-emerald-400' : 'text-rose-500 font-bold';
                const statusIcon = isEnough ? '<i class="fas fa-check-circle text-emerald-500"></i>' : '<i class="fas fa-exclamation-triangle text-rose-500"></i>';
                
                summaryHTML += `
                    <div class="flex justify-between items-center text-xs bg-slate-800 p-2.5 rounded border border-slate-700">
                        <div class="flex items-center gap-2">
                            ${statusIcon}
                            <span class="text-slate-300 font-bold">${mat}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="text-right">
                                <div class="text-[9px] text-slate-500 uppercase">Stok</div>
                                <div class="text-slate-300 font-mono">${stock}</div>
                            </div>
                            <div class="h-6 w-px bg-slate-600 mx-1"></div>
                            <div class="text-right">
                                <div class="text-[9px] text-slate-500 uppercase">Butuh</div>
                                <div class="${colorClass} font-mono text-sm">${req}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            summaryHTML += '</div>';
            
            if(!allAvailable) {
                summaryHTML += `<div class="mt-4 text-xs text-rose-200 font-bold text-center bg-rose-900/50 border border-rose-500/50 p-3 rounded-lg flex items-center justify-center gap-2 animate-pulse">
                    <i class="fas fa-hand-paper"></i> Stok tidak mencukupi untuk memproses semua antrean!
                </div>`;
            }

            // Update Summary Wrapper (Single point of update to prevent ID loss)
            if(wrapper) {
                wrapper.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-[11px] font-bold text-slate-400 uppercase flex items-center gap-2">
                            <i class="fas fa-calculator"></i> Total Estimasi Bahan
                        </h4>
                        <button onclick="takeElementScreenshot('total-estimation-wrapper', 'Estimasi_Total_Produksi')" class="text-slate-400 hover:text-white bg-slate-700 hover:bg-slate-600 rounded px-2 py-1 transition" title="Screenshot Total">
                            <i class="fas fa-camera text-xs"></i>
                        </button>
                    </div>
                    ${summaryHTML}
                `;
            }

            // Enable/Disable Process Button
            btnProcess.disabled = !allAvailable;
            btnProcess.className = `w-full mt-6 p-4 rounded-lg font-bold transition shadow-lg text-sm uppercase tracking-wider ${allAvailable ? 'bg-emerald-600 hover:bg-emerald-500 text-white shadow-emerald-900/20' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`;
            btnProcess.innerHTML = allAvailable ? `<i class="fas fa-industry mr-2"></i>PROSES PRODUKSI (${craftQueue.length} Jenis)` : `<i class="fas fa-ban mr-2"></i>BAHAN KURANG`;
        };

        window.processCraftQueue = async () => {
            if(craftQueue.length === 0) return;

            showConfirm("Konfirmasi Produksi", `Yakin ingin merakit <b>${craftQueue.length} jenis produk</b> sekaligus?`, async () => {
                try {
                    const batch = writeBatch(db);
                    const newWhStock = { ...warehouseStock };
                    const historyDetails = [];
                    const logDataPayload = []; // For structured history
                    // TAMBAHKAN INI - Store material usage before/after
                    const materialUsageBefore = { ...warehouseStock };
                    const materialUsageDetail = {}; // Track what was used

                    // 1. Calculate Deductions & Updates
                    craftQueue.forEach(item => {
                        const rec = recipes[item.name];
                        const matUsed = {};
                        
                        // Deduct Materials
                        Object.entries(rec.requirements).forEach(([mat, req]) => {
                            const totalNeeded = req * item.qty;
                            newWhStock[mat] -= totalNeeded;
                            matUsed[mat] = totalNeeded;
                            
                            // TAMBAHKAN INI - Track total material usage
                            if(!materialUsageDetail[mat]) {
                                materialUsageDetail[mat] = {
                                    before: materialUsageBefore[mat] || 0,
                                    used: 0,
                                    after: 0
                                };
                            }
                            materialUsageDetail[mat].used += totalNeeded;
                        });
                        // Update Product Stock
                        const existingProd = productStock.find(p => p.name === item.name);
                        
                        // Find weapon data for pricing
                        const weaponData = weaponDatabase.find(w => w.name === item.name);
                        const sellingPrice = weaponData ? weaponData.sellingPrice : rec.sellingPrice;
                        const weaponClass = weaponData ? weaponData.weaponClass : 'Senjata';
                        
                        if(existingProd) {
                            const prodRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', existingProd.id);
                            batch.update(prodRef, { 
                                stock: (existingProd.stock || 0) + item.qty,
                                sellingPrice: sellingPrice,
                                weaponClass: weaponClass
                            });
                        } else {
                            const newProdRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'products'));
                            batch.set(newProdRef, {
                                name: item.name,
                                category: weaponClass,
                                weaponClass: weaponClass,
                                stock: item.qty,
                                sellingPrice: sellingPrice,
                                costPrice: 0
                            });
                        }
                        
                        historyDetails.push(`${item.name} (x${item.qty})`);
                        logDataPayload.push({
                            name: item.name,
                            qty: item.qty,
                            materials: matUsed
                        });
                    });

                    // 2. Set Updated Warehouse Stock
                    batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), newWhStock);

                    // 3. Create Log with Detailed Payload
                    const logRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'global_history'));
                    batch.set(logRef, {
                        type: 'CRAFTING',
                        desc: `Produksi Massal: ${historyDetails.join(', ')}`,
                        timestamp: serverTimestamp(),
                        pic: 'Operator (Batch)',
                        details: logDataPayload // Storing structured data here
                    });

                    // 4. Commit
                    await batch.commit();

                        // TAMBAHKAN INI - Finalize material usage report
                        Object.keys(materialUsageDetail).forEach(mat => {
                            materialUsageDetail[mat].after = newWhStock[mat] || 0;
                        });

                        lastCraftingReport = {
                            timestamp: new Date(),
                            products: craftQueue.map(item => ({
                                name: item.name,
                                qty: item.qty
                            })),
                            materialUsage: materialUsageDetail
                        };

                        resetCraftQueue();

                        // Show success with option to view report
                        showConfirm(
                            "Produksi Berhasil! ",
                            `Produksi <b>${craftQueue.length} jenis produk</b> berhasil diselesaikan.<br><br>` +
                            `Apakah Anda ingin melihat laporan penggunaan bahan?`,
                            () => {
                                openCraftingReportModal();
                            },
                            "success"
                        );

                } catch(err) {
                    console.error(err);
                    showAlert("Error", "Gagal memproses antrean: " + err.message, "error");
                }
            }, "info");
        };

        // --- NEW: CRAFTING HISTORY LOGIC ---
        window.openCraftingHistory = () => {
            renderCraftingHistory();
            document.getElementById('craftingHistoryModal').classList.remove('hidden');
        };

        window.closeCraftingHistory = () => {
            document.getElementById('craftingHistoryModal').classList.add('hidden');
        };

        window.renderCraftingHistory = () => {
            const container = document.getElementById('craftingHistoryContent');
            if(!container) return;

            if (craftingHistory.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 text-sm py-10 italic">Belum ada riwayat produksi.</div>';
                return;
            }

            container.innerHTML = craftingHistory.map((log, index) => {
                const date = log.timestamp ? new Date(log.timestamp.seconds*1000).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) : '-';
                
                let detailsHtml = '';
                
                // Jika log memiliki struktur detail baru (details array)
                if (log.details && Array.isArray(log.details)) {
                     detailsHtml = log.details.map(item => {
                        let matsHtml = '';
                        if(item.materials) {
                            matsHtml = Object.entries(item.materials).map(([mat, qty]) => 
                                `<span class="text-xs text-slate-400 bg-slate-800 px-1.5 py-0.5 rounded border border-slate-700">${mat}: ${qty}</span>`
                            ).join(' ');
                        }

                        return `
                            <div class="mb-2 pb-2 border-b border-slate-700/50 last:border-0">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-emerald-400 text-sm">${item.name}</span>
                                    <span class="bg-blue-900/50 text-blue-300 text-xs px-2 py-0.5 rounded font-bold">x${item.qty}</span>
                                </div>
                                <div class="mt-1">
                                    <p class="text-[9px] text-slate-500 mb-1 font-bold uppercase">Bahan Digunakan:</p>
                                    <div class="flex flex-wrap gap-1">
                                        ${matsHtml}
                                    </div>
                                </div>
                            </div>
                        `;
                     }).join('');
                } else {
                    // Fallback untuk log lama (hanya deskripsi string)
                    detailsHtml = `<p class="text-slate-400 text-xs italic">${log.desc}</p>`;
                }

                return `
                    <div id="craft-log-${index}" class="bg-slate-800 border border-slate-700 rounded-lg p-4 mb-4 relative group">
                        <div class="flex justify-between items-start mb-3 border-b border-slate-700 pb-2">
                            <div>
                                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Waktu Produksi</p>
                                <p class="text-sm text-white font-mono">${date}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Operator</p>
                                <p class="text-xs text-slate-300">${log.pic || '-'}</p>
                            </div>
                        </div>
                        
                        <div class="bg-slate-900/50 rounded p-3 mb-2">
                            ${detailsHtml}
                        </div>

                        <div class="flex justify-end pt-2 gap-2">
                             <button onclick="deleteGlobalLog('${log.id}')" class="text-xs flex items-center bg-rose-900/20 hover:bg-rose-600 text-rose-500 hover:text-white border border-rose-800/50 px-3 py-1.5 rounded transition">
                                <i class="fas fa-trash-alt mr-2"></i> Hapus
                            </button>
                            <button onclick="takeElementScreenshot('craft-log-${index}', 'Log_Produksi_${index}')" class="text-xs flex items-center bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1.5 rounded transition">
                                <i class="fas fa-camera mr-2"></i> Simpan Bukti
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        };

        // --- NEW: MATERIAL STOCK PREVIEW ---
        window.renderMaterialStockPreview = () => {
            const container = document.getElementById('material-stock-preview');
            if(!container) return;
            
            if(Object.keys(warehouseStock).length === 0) {
                container.innerHTML = '<span class="text-slate-500 text-xs">Belum ada stok bahan.</span>';
                return;
            }

            container.innerHTML = Object.entries(warehouseStock).sort().map(([name, qty]) => `
                <div class="flex items-center space-x-2 bg-slate-800/50 px-3 py-1.5 rounded border border-slate-700/50">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">${name}</span>
                    <span class="text-xs font-bold text-emerald-400">${qty}</span>
                </div>
            `).join('');
        };

        // SALES REPORT MODAL
window.openSalesReportModal = () => {
    if(!lastSalesTransaction) {
        return showAlert("Error", "Tidak ada data transaksi untuk ditampilkan.", "warning");
    }
    
    renderSalesReport();
    document.getElementById('salesReportModal').classList.remove('hidden');
};

// CRAFTING MATERIAL USAGE REPORT
window.openCraftingReportModal = () => {
    if(allCraftingReports.length === 0) {
        return showAlert("Error", "Tidak ada data produksi untuk ditampilkan.", "warning");
    }
     // Update title
    const title = document.querySelector('#craftingReportModal h3');
    if(title) {
        title.innerHTML = `<i class="fas fa-industry mr-2 text-purple-400"></i> Riwayat Lengkap Produksi (${allCraftingReports.length} Laporan)`;
    }
    
    renderAllCraftingReports();
    document.getElementById('craftingReportModal').classList.remove('hidden');
};

window.renderAllCraftingReports = () => {
    const container = document.getElementById('craftingReportContent');
    if(!container) return;
    
    if(allCraftingReports.length === 0) {
        container.innerHTML = '<div class="text-center text-slate-500 py-10 italic">Belum ada riwayat produksi.</div>';
        return;
    }
    
    container.innerHTML = allCraftingReports.map((report, idx) => {
        const date = report.timestamp.toLocaleString('id-ID', { 
            dateStyle: 'medium', 
            timeStyle: 'short' 
        });
        
        const totalProducts = report.products.reduce((sum, p) => sum + p.qty, 0);
        const totalMaterialTypes = Object.keys(report.materialUsage).length;
        const totalUsed = Object.values(report.materialUsage).reduce((sum, data) => sum + data.used, 0);
        
        return `
            <div class="bg-slate-800 border border-slate-700 rounded-lg mb-3 overflow-hidden">
                <!-- Header (Always Visible) -->
                <div onclick="toggleCraftingReport(${idx})" 
                     class="p-4 cursor-pointer hover:bg-slate-700/50 transition flex justify-between items-center">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-1">
                            <h4 class="font-bold text-purple-400">Laporan Produksi #${allCraftingReports.length - idx}</h4>
                            <span class="text-xs bg-purple-900/50 text-purple-300 px-2 py-0.5 rounded">
                                ${report.products.length} Jenis  ${totalProducts} Unit
                            </span>
                        </div>
                        <p class="text-xs text-slate-400">
                            <i class="fas fa-clock mr-1"></i> ${date}
                        </p>
                        <div class="flex gap-4 mt-2 text-xs">
                            <span class="text-slate-500">
                                <i class="fas fa-boxes text-blue-400 mr-1"></i> ${totalMaterialTypes} Bahan
                            </span>
                            <span class="text-slate-500">
                                <i class="fas fa-arrow-down text-rose-400 mr-1"></i> ${totalUsed.toLocaleString()} Unit Terpakai
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="event.stopPropagation(); takeElementScreenshot('craft-report-detail-${idx}', 'Laporan_Produksi_${idx}')" 
                                class="text-slate-400 hover:text-white bg-slate-700 hover:bg-slate-600 rounded px-3 py-2 transition text-xs">
                            <i class="fas fa-camera"></i>
                        </button>
                        <i id="icon-${idx}" class="fas fa-chevron-down text-slate-500 transition-transform"></i>
                    </div>
                </div>
                
                <!-- Detail (Collapsible) -->
                <div id="craft-report-detail-${idx}" class="hidden">
                    <div class="p-4 pt-0 border-t border-slate-700">
                        <!-- Stats Cards -->
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="bg-blue-900/20 border border-blue-700/50 rounded p-3 text-center">
                                <div class="text-2xl font-bold text-blue-400">${report.products.length}</div>
                                <div class="text-xs text-slate-500 uppercase mt-1">Jenis Produk</div>
                            </div>
                            <div class="bg-purple-900/20 border border-purple-700/50 rounded p-3 text-center">
                                <div class="text-2xl font-bold text-purple-400">${totalMaterialTypes}</div>
                                <div class="text-xs text-slate-500 uppercase mt-1">Jenis Bahan</div>
                            </div>
                            <div class="bg-rose-900/20 border border-rose-700/50 rounded p-3 text-center">
                                <div class="text-2xl font-bold text-rose-400">${totalUsed.toLocaleString()}</div>
                                <div class="text-xs text-slate-500 uppercase mt-1">Total Terpakai</div>
                            </div>
                        </div>
                        
                        <!-- Products List -->
                        <div class="mb-4">
                            <h5 class="text-xs font-bold text-slate-400 uppercase mb-2">
                                <i class="fas fa-boxes mr-1"></i> Produk yang Dibuat
                            </h5>
                            <div class="bg-slate-900/50 border border-slate-700 rounded p-3">
                                ${report.products.map(p => 
                                    `<span class="inline-block bg-blue-900/50 text-blue-300 border border-blue-700/50 px-3 py-1 rounded-full text-xs font-bold mr-2 mb-2">
                                        ${p.name} <span class="text-blue-400">${p.qty}</span>
                                    </span>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <!-- Materials Table -->
                        <div>
                            <h5 class="text-xs font-bold text-slate-400 uppercase mb-2">
                                <i class="fas fa-list mr-1"></i> Bahan yang Digunakan
                            </h5>
                            <div class="border border-slate-700 rounded overflow-hidden bg-slate-900/30">
                                <table class="w-full">
                                    <thead class="bg-slate-800 text-xs text-slate-500 uppercase">
                                        <tr>
                                            <th class="p-2 text-left">Nama Bahan</th>
                                            <th class="p-2 text-center">Digunakan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.entries(report.materialUsage).map(([mat, data]) => `
                                            <tr class="border-b border-slate-700 hover:bg-slate-700/30 transition text-xs">
                                                <td class="p-2 font-bold text-slate-200">${mat}</td>
                                                <td class="p-2 text-center">
                                                    <div class="font-mono text-rose-400 font-bold">-${data.used.toLocaleString()}</div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
};

window.toggleCraftingReport = (idx) => {
    const detail = document.getElementById(`craft-report-detail-${idx}`);
    const icon = document.getElementById(`icon-${idx}`);
    
    if(!detail || !icon) return;
    
    const isHidden = detail.classList.contains('hidden');
    
    if(isHidden) {
        // Expand
        detail.classList.remove('hidden');
        detail.style.animation = 'slideDown 0.3s ease-out';
        icon.style.transform = 'rotate(180deg)';
    } else {
        // Collapse
        detail.style.animation = 'slideUp 0.3s ease-out';
        setTimeout(() => {
            detail.classList.add('hidden');
        }, 250);
        icon.style.transform = 'rotate(0deg)';
    }
};

window.toggleAllCraftingReports = (expand) => {
    allCraftingReports.forEach((_, idx) => {
        const detail = document.getElementById(`craft-report-detail-${idx}`);
        const icon = document.getElementById(`icon-${idx}`);
        
        if(!detail || !icon) return;
        
        if(expand) {
            // Expand all
            detail.classList.remove('hidden');
            detail.style.animation = 'slideDown 0.3s ease-out';
            icon.style.transform = 'rotate(180deg)';
        } else {
            // Collapse all
            detail.classList.add('hidden');
            icon.style.transform = 'rotate(0deg)';
        }
    });
};

window.closeCraftingReportModal = () => {
    document.getElementById('craftingReportModal').classList.add('hidden');
};

window.renderCraftingReport = () => {
    const container = document.getElementById('craftingReportContent');
    if(!container || !lastCraftingReport) return;
    
    const report = lastCraftingReport;
    const date = report.timestamp.toLocaleString('id-ID', { 
        dateStyle: 'full', 
        timeStyle: 'short' 
    });
    
    // Build products summary
    const productsHtml = report.products.map(p => 
        `<span class="inline-block bg-blue-900/50 text-blue-300 border border-blue-700/50 px-3 py-1 rounded-full text-xs font-bold mr-2 mb-2">
            ${p.name} <span class="text-blue-400">${p.qty}</span>
        </span>`
    ).join('');
    
    // Build material usage table
    const materialsHtml = Object.entries(report.materialUsage).map(([mat, data]) => {
        const percentUsed = ((data.used / data.before) * 100).toFixed(1);
        
        return `
            <tr class="border-b border-slate-700 hover:bg-slate-700/30 transition">
                <td class="p-3 font-bold text-slate-200">${mat}</td>
                <td class="p-3 text-center">
                    <div class="font-mono text-slate-400 text-sm">${data.before.toLocaleString()}</div>
                </td>
                <td class="p-3 text-center">
                    <div class="font-mono text-rose-400 font-bold text-sm">-${data.used.toLocaleString()}</div>
                    <div class="text-[9px] text-slate-600">${percentUsed}% terpakai</div>
                </td>
                <td class="p-3 text-center">
                    <div class="font-mono text-emerald-400 font-bold text-sm">${data.after.toLocaleString()}</div>
                </td>
                <td class="p-3 text-center">
                    <div class="w-full bg-slate-800 rounded-full h-2 overflow-hidden">
                        <div class="bg-gradient-to-r from-rose-500 to-emerald-500 h-full transition-all" 
                             style="width: ${((data.after / data.before) * 100).toFixed(1)}%"></div>
                    </div>
                    <div class="text-[9px] text-slate-500 mt-1">${((data.after / data.before) * 100).toFixed(1)}% tersisa</div>
                </td>
            </tr>
        `;
    }).join('');
    
    const totalMaterialTypes = Object.keys(report.materialUsage).length;
    const totalUsed = Object.values(report.materialUsage).reduce((sum, data) => sum + data.used, 0);
    
    container.innerHTML = `
        <div class="bg-gradient-to-br from-purple-900/50 to-pink-900/50 p-6 rounded-t-xl border-b border-slate-700">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold text-white mb-1">LAPORAN PENGGUNAAN BAHAN</h2>
                    <p class="text-purple-300 text-sm">Vikrama ERP - Production Report</p>
                </div>
                <div class="text-right">
                    <div class="text-xs text-slate-400 uppercase font-bold">Waktu Produksi</div>
                    <div class="text-sm text-white font-mono">${date}</div>
                </div>
            </div>
        </div>
        
        <div class="p-6 space-y-6">
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-blue-900/20 border border-blue-700/50 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-blue-400">${report.products.length}</div>
                    <div class="text-xs text-slate-500 uppercase mt-1">Jenis Produk</div>
                </div>
                <div class="bg-purple-900/20 border border-purple-700/50 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-purple-400">${totalMaterialTypes}</div>
                    <div class="text-xs text-slate-500 uppercase mt-1">Jenis Bahan</div>
                </div>
                <div class="bg-rose-900/20 border border-rose-700/50 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-rose-400">${totalUsed.toLocaleString()}</div>
                    <div class="text-xs text-slate-500 uppercase mt-1">Total Terpakai</div>
                </div>
            </div>
            
            <div>
                <h4 class="text-sm font-bold text-slate-400 uppercase mb-3 flex items-center">
                    <i class="fas fa-boxes mr-2"></i> Produk yang Dibuat
                </h4>
                <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-4">
                    ${productsHtml}
                </div>
            </div>
            
            <div>
                <h4 class="text-sm font-bold text-slate-400 uppercase mb-3 flex items-center">
                    <i class="fas fa-chart-line mr-2"></i> Detail Penggunaan Bahan (Before  After)
                </h4>
                <div class="border border-slate-700 rounded-lg overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-800 text-xs text-slate-400 uppercase">
                            <tr>
                                <th class="p-3 text-left">Nama Bahan</th>
                                <th class="p-3 text-center">Stok Awal</th>
                                <th class="p-3 text-center">Digunakan</th>
                                <th class="p-3 text-center">Stok Akhir</th>
                                <th class="p-3 text-center">Visual</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${materialsHtml}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-yellow-900/20 border border-yellow-700/50 rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <i class="fas fa-info-circle text-yellow-400 text-xl"></i>
                    <div class="text-xs text-slate-300">
                        <p class="font-bold text-yellow-400 mb-1">Informasi Laporan</p>
                        <p>Laporan ini menampilkan perbandingan stok bahan sebelum dan sesudah proses produksi. Gunakan data ini untuk monitoring inventory dan perencanaan produksi berikutnya.</p>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-slate-800 pt-4 flex justify-between items-end text-[10px] text-slate-600">
                <span>Generated by Vikrama ERP - Production Module</span>
                <span>*** DOKUMEN INTERNAL ***</span>
            </div>
        </div>
    `;
};

window.downloadCraftingReport = async () => {
    const btn = document.getElementById('btnDownloadCraftingReport');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
    btn.disabled = true;
    
    try {
        const element = document.getElementById('craftingReportContent');
        const canvas = await html2canvas(element, {
            backgroundColor: '#0f172a',
            scale: 2,
            logging: false
        });
        
        const link = document.createElement('a');
        link.download = `Laporan_Produksi_${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        showToast("Laporan produksi berhasil disimpan!", "success");
    } catch(err) {
        console.error(err);
        showAlert("Error", "Gagal menyimpan laporan: " + err.message, "error");
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
};

window.closeSalesReportModal = () => {
    document.getElementById('salesReportModal').classList.add('hidden');
};

window.renderSalesReport = () => {
    const container = document.getElementById('salesReportContent');
    if(!container || !lastSalesTransaction) return;
    
    const tx = lastSalesTransaction;
    const date = tx.timestamp.toLocaleString('id-ID', { 
        dateStyle: 'full', 
        timeStyle: 'short' 
    });
    
    // Build items table with stock info
    let itemsHtml = tx.items.map(item => {
        let classColor = 'bg-slate-700 text-slate-300';
        if(item.weaponClass === 'KELAS 1') classColor = 'bg-red-900/50 text-red-300';
        else if(item.weaponClass === 'KELAS 2') classColor = 'bg-orange-900/50 text-orange-300';
        else if(item.weaponClass === 'KELAS 3') classColor = 'bg-yellow-900/50 text-yellow-300';
        else if(item.weaponClass === 'KELAS 4') classColor = 'bg-green-900/50 text-green-300';
        else if(item.weaponClass === 'AKSESORIS') classColor = 'bg-purple-900/50 text-purple-300';
        
        // Calculate stock before/after
        const stockAfter = item.stockAfter || 0;
        const stockBefore = item.stockBefore || (stockAfter + item.qty);
        
        return `
            <tr class="border-b border-slate-700">
                <td class="p-3">
                    <div class="font-bold text-slate-200">${item.name}</div>
                    <span class="text-[9px] ${classColor} px-2 py-0.5 rounded font-bold uppercase mt-1 inline-block">${item.weaponClass || 'Umum'}</span>
                </td>
                <td class="p-3 text-center font-mono text-slate-300">${item.qty}</td>
                <td class="p-3 text-center">
                    <div class="flex items-center justify-center gap-1 text-xs">
                        <span class="font-mono text-slate-400">${stockBefore}</span>
                        <i class="fas fa-arrow-right text-slate-600"></i>
                        <span class="font-mono text-rose-400 font-bold">${stockAfter}</span>
                    </div>
                </td>
                <td class="p-3 text-right font-mono text-slate-400">Rp ${item.price.toLocaleString()}</td>
                <td class="p-3 text-right font-mono text-emerald-400 font-bold">Rp ${item.subtotal.toLocaleString()}</td>
            </tr>
        `;
    }).join('');
    
    // Build limit usage summary
    const limitHtml = `
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-xs">
            <div class="bg-red-900/20 border border-red-700/50 rounded p-2 text-center">
                <div class="text-red-300 font-bold">${tx.limitUsed.kelas1}</div>
                <div class="text-slate-500 text-[9px]">Kelas 1</div>
            </div>
            <div class="bg-orange-900/20 border border-orange-700/50 rounded p-2 text-center">
                <div class="text-orange-300 font-bold">${tx.limitUsed.kelas2}</div>
                <div class="text-slate-500 text-[9px]">Kelas 2</div>
            </div>
            <div class="bg-yellow-900/20 border border-yellow-700/50 rounded p-2 text-center">
                <div class="text-yellow-300 font-bold">${tx.limitUsed.kelas3}</div>
                <div class="text-slate-500 text-[9px]">Kelas 3</div>
            </div>
            <div class="bg-green-900/20 border border-green-700/50 rounded p-2 text-center">
                <div class="text-green-300 font-bold">${tx.limitUsed.kelas4}</div>
                <div class="text-slate-500 text-[9px]">Kelas 4</div>
            </div>
            <div class="bg-purple-900/20 border border-purple-700/50 rounded p-2 text-center">
                <div class="text-purple-300 font-bold">${tx.limitUsed.aksesoris}</div>
                <div class="text-slate-500 text-[9px]">Aksesoris</div>
            </div>
        </div>
    `;
    
    container.innerHTML = `
        <div class="bg-gradient-to-br from-blue-900/50 to-purple-900/50 p-6 rounded-t-xl border-b border-slate-700">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold text-white mb-1">BUKTI TRANSAKSI PENJUALAN</h2>
                    <p class="text-blue-300 text-sm">Vikrama ERP - Gun Store System</p>
                </div>
                <div class="text-right">
                    <div class="text-xs text-slate-400 uppercase font-bold">Waktu Transaksi</div>
                    <div class="text-sm text-white font-mono">${date}</div>
                </div>
            </div>
        </div>
        
        <div class="p-6 space-y-6">
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <p class="text-slate-500 text-xs uppercase mb-1">Seller (PIC)</p>
                    <p class="font-bold text-white">${tx.pic}</p>
                </div>
                <div>
                    <p class="text-slate-500 text-xs uppercase mb-1">Kelompok Pembeli</p>
                    <p class="font-bold text-white">${tx.groupName}</p>
                </div>
            </div>
            
            <div>
                <h4 class="text-sm font-bold text-slate-400 uppercase mb-3 flex items-center">
                    <i class="fas fa-shopping-cart mr-2"></i> Detail Pembelian
                </h4>
                <div class="border border-slate-700 rounded-lg overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-800 text-xs text-slate-400 uppercase">
                            <tr>
                                <th class="p-3 text-left">Produk</th>
                                <th class="p-3 text-center">Qty</th>
                                <th class="p-3 text-center">Stok (BeforeAfter)</th>
                                <th class="p-3 text-right">Harga</th>
                                <th class="p-3 text-right">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-emerald-900/20 border border-emerald-700/50 rounded-lg p-4">
                <div class="flex justify-between items-center">
                    <span class="text-slate-400 font-bold uppercase text-sm">Total Pembayaran</span>
                    <span class="text-3xl font-bold text-emerald-400">Rp ${tx.totalAmount.toLocaleString()}</span>
                </div>
            </div>
            
            <div>
                <h4 class="text-sm font-bold text-slate-400 uppercase mb-3 flex items-center">
                    <i class="fas fa-chart-bar mr-2"></i> Pemakaian Limit Kelompok
                </h4>
                ${limitHtml}
            </div>
            
            <div class="border-t border-slate-800 pt-4 flex justify-between items-end text-[10px] text-slate-600">
                <span>Generated by Vikrama ERP</span>
                <span>*** DOKUMEN SAH ***</span>
            </div>
        </div>
    `;
};

window.downloadSalesReport = async () => {
    const btn = document.getElementById('btnDownloadSalesReport');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
    btn.disabled = true;
    
    try {
        const element = document.getElementById('salesReportContent');
        const canvas = await html2canvas(element, {
            backgroundColor: '#0f172a',
            scale: 2,
            logging: false
        });
        
        const link = document.createElement('a');
        link.download = `Transaksi_Penjualan_${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        showToast("Laporan transaksi berhasil disimpan!", "success");
    } catch(err) {
        console.error(err);
        showAlert("Error", "Gagal menyimpan laporan: " + err.message, "error");
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
};

        // --- NEW FEATURE: STOCK SCREENSHOT ---
        window.downloadStockScreenshot = async () => {
            const btn = document.getElementById('btn-stock-screenshot');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // 1. Buat Container Invisible untuk Render Report
                const exportContainer = document.createElement('div');
                exportContainer.style.position = 'absolute';
                exportContainer.style.top = '-9999px';
                exportContainer.style.left = '-9999px';
                exportContainer.style.width = '600px';
                exportContainer.style.backgroundColor = '#1e293b'; // slate-800 context
                exportContainer.style.color = '#fff';
                exportContainer.style.padding = '30px';
                exportContainer.style.borderRadius = '12px';
                exportContainer.style.fontFamily = 'Inter, sans-serif';
                
                // 2. Isi Konten Laporan
                const date = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });
                const totalItems = Object.keys(warehouseStock).length;
                
                let rows = '';
                if(totalItems === 0) {
                    rows = '<tr><td colspan="2" class="p-4 text-center text-slate-500 italic">Gudang Kosong</td></tr>';
                } else {
                    rows = Object.entries(warehouseStock).sort().map(([name, qty]) => `
                        <tr class="border-b border-slate-600/50">
                            <td class="py-2 px-3 font-bold text-slate-200">${name}</td>
                            <td class="py-2 px-3 text-right font-mono text-emerald-400 font-bold">${qty.toLocaleString()}</td>
                        </tr>
                    `).join('');
                }

                exportContainer.innerHTML = `
                    <div class="mb-6 border-b-2 border-emerald-500 pb-4 flex justify-between items-start">
                        <div>
                            <h2 class="text-3xl font-bold text-white tracking-tight">Laporan Stok Gudang</h2>
                            <p class="text-sm text-emerald-400 font-medium mt-1">Vikrama ERP System</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-400 uppercase font-bold">Waktu Generate</div>
                            <div class="text-sm text-white font-mono">${date}</div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-900/50 rounded-lg overflow-hidden border border-slate-700">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-700 text-xs text-slate-300 uppercase font-bold">
                                <tr>
                                    <th class="py-3 px-3 text-left">Nama Material</th>
                                    <th class="py-3 px-3 text-right">Jumlah Stok</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-6 flex justify-between items-end text-[10px] text-slate-500 font-mono border-t border-slate-700 pt-4">
                        <span>Total Item: ${totalItems}</span>
                        <span>Authorized Document</span>
                    </div>
                `;

                document.body.appendChild(exportContainer);

                // 3. Generate Canvas
                const canvas = await html2canvas(exportContainer, {
                    backgroundColor: '#0f172a', // Background body slate-900
                    scale: 2, // High resolution
                    logging: false
                });

                // 4. Download
                document.body.removeChild(exportContainer);
                const link = document.createElement('a');
                link.download = `Stok_Gudang_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast("Laporan stok berhasil diunduh!", "success");

            } catch (err) {
                console.error(err);
                showAlert("Gagal", "Terjadi kesalahan saat mengambil screenshot: " + err.message, "error");
            } finally {
                btn.innerHTML = originalIcon;
                btn.disabled = false;
            }
        };

        // --- NEW FEATURE: RECIPE SCREENSHOT ---
        window.downloadRecipeScreenshot = async () => {
            const btn = document.getElementById('btn-recipe-screenshot');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // 1. Buat Container Invisible
                const exportContainer = document.createElement('div');
                exportContainer.style.position = 'absolute';
                exportContainer.style.top = '-9999px';
                exportContainer.style.left = '-9999px';
                exportContainer.style.width = '800px'; // Lebih lebar untuk grid resep
                exportContainer.style.backgroundColor = '#1e293b'; 
                exportContainer.style.color = '#fff';
                exportContainer.style.padding = '30px';
                exportContainer.style.borderRadius = '12px';
                exportContainer.style.fontFamily = 'Inter, sans-serif';
                
                const date = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });
                const totalRecipes = Object.keys(recipes).length;
                
                let content = '';
                if(totalRecipes === 0) {
                    content = '<div class="p-8 text-center text-slate-500 italic">Belum ada resep aktif.</div>';
                } else {
                    // Grid Layout untuk Resep
                    content = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">';
                    Object.entries(recipes).forEach(([name, data]) => {
                        const reqs = Object.entries(data.requirements).map(([m, q]) => 
                            `<div style="display: flex; justify-content: space-between; border-bottom: 1px solid rgba(148, 163, 184, 0.2); padding-bottom: 4px; margin-bottom: 4px; font-size: 11px;">
                                <span style="color: #cbd5e1;">${m}</span>
                                <span style="font-weight: bold; color: #34d399;">${q}</span>
                            </div>`
                        ).join('');

                        content += `
                            <div style="background-color: rgba(30, 41, 59, 0.5); border: 1px solid #475569; border-radius: 8px; padding: 15px;">
                                <h4 style="font-weight: bold; color: #c084fc; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; border-bottom: 2px solid #c084fc; padding-bottom: 5px;">${name}</h4>
                                <div>${reqs}</div>
                            </div>
                        `;
                    });
                    content += '</div>';
                }

                exportContainer.innerHTML = `
                    <div style="margin-bottom: 20px; border-bottom: 2px solid #c084fc; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h2 style="font-size: 24px; font-weight: bold; margin: 0;">Laporan Resep Produksi</h2>
                            <p style="font-size: 12px; color: #a78bfa; margin: 5px 0 0 0;">Vikrama ERP System - Crafting Module</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 10px; color: #94a3b8; text-transform: uppercase; font-weight: bold;">Waktu Generate</div>
                            <div style="font-size: 12px; font-family: monospace;">${date}</div>
                        </div>
                    </div>
                    
                    ${content}

                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: flex-end; font-size: 10px; color: #64748b; border-top: 1px solid #334155; padding-top: 15px;">
                        <span>Total Resep: ${totalRecipes}</span>
                        <span>Authorized Document</span>
                    </div>
                `;

                document.body.appendChild(exportContainer);

                // 3. Generate Canvas
                const canvas = await html2canvas(exportContainer, {
                    backgroundColor: '#0f172a',
                    scale: 2, 
                    logging: false
                });

                // 4. Download
                document.body.removeChild(exportContainer);
                const link = document.createElement('a');
                link.download = `Resep_Produksi_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast("Laporan resep berhasil diunduh!", "success");

            } catch (err) {
                console.error(err);
                showAlert("Gagal", "Screenshot error: " + err.message, "error");
            } finally {
                btn.innerHTML = originalIcon;
                btn.disabled = false;
            }
        };

        // --- NEW FEATURE: PREVIEW STOCK SCREENSHOT ---
        window.downloadPreviewScreenshot = async () => {
            const btn = document.getElementById('btn-preview-screenshot');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // 1. Buat Container Invisible
                const exportContainer = document.createElement('div');
                exportContainer.style.position = 'absolute';
                exportContainer.style.top = '-9999px';
                exportContainer.style.left = '-9999px';
                exportContainer.style.width = '600px';
                exportContainer.style.backgroundColor = '#1e293b'; 
                exportContainer.style.color = '#fff';
                exportContainer.style.padding = '30px';
                exportContainer.style.borderRadius = '12px';
                exportContainer.style.fontFamily = 'Inter, sans-serif';
                
                const date = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });
                
                let content = '';
                if(Object.keys(warehouseStock).length === 0) {
                    content = '<div style="text-align: center; color: #64748b; font-style: italic; padding: 20px;">Belum ada stok bahan.</div>';
                } else {
                    // Render as chips to match preview style
                    const chips = Object.entries(warehouseStock).sort().map(([name, qty]) => `
                        <div style="display: inline-flex; align-items: center; background-color: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 4px; padding: 6px 12px; margin: 4px;">
                            <span style="font-size: 10px; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-right: 8px;">${name}</span>
                            <span style="font-size: 12px; font-weight: bold; color: #34d399;">${qty}</span>
                        </div>
                    `).join('');
                    content = `<div style="display: flex; flex-wrap: wrap; gap: 8px;">${chips}</div>`;
                }

                exportContainer.innerHTML = `
                    <div style="margin-bottom: 20px; border-bottom: 2px solid #34d399; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h2 style="font-size: 20px; font-weight: bold; margin: 0;">Preview Stok Bahan</h2>
                            <p style="font-size: 12px; color: #6ee7b7; margin: 5px 0 0 0;">Vikrama ERP - Crafting Module</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 10px; color: #94a3b8; text-transform: uppercase; font-weight: bold;">Waktu Generate</div>
                            <div style="font-size: 12px; font-family: monospace;">${date}</div>
                        </div>
                    </div>
                    
                    ${content}

                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: flex-end; font-size: 10px; color: #64748b; border-top: 1px solid #334155; padding-top: 15px;">
                        <span>Total Item: ${Object.keys(warehouseStock).length}</span>
                        <span>Authorized Document</span>
                    </div>
                `;

                document.body.appendChild(exportContainer);

                // 3. Generate Canvas
                const canvas = await html2canvas(exportContainer, {
                    backgroundColor: '#0f172a',
                    scale: 2, 
                    logging: false
                });

                // 4. Download
                document.body.removeChild(exportContainer);
                const link = document.createElement('a');
                link.download = `Preview_Stok_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast("Screenshot preview stok berhasil!", "success");

            } catch (err) {
                console.error(err);
                showAlert("Gagal", "Screenshot error: " + err.message, "error");
            } finally {
                btn.innerHTML = originalIcon;
                btn.disabled = false;
            }
        };

        // --- NEW: RECIPE MODAL FUNCTIONS ---
        window.openRecipeModal = (title = "Buat Resep Baru") => {
            document.getElementById('recipeModalTitle').textContent = title;
            document.getElementById('recipeModal').classList.remove('hidden');
        };

        window.closeRecipeModal = () => {
            document.getElementById('recipeModal').classList.add('hidden');
            document.getElementById('cr-form').reset();
            
            // Clear editing attributes
            const nameInput = document.getElementById('cr-name');
            if(nameInput) {
                nameInput.removeAttribute('data-editing');
                nameInput.removeAttribute('data-original-name');
            }
            
            // Reset title back to default
            setTimeout(() => document.getElementById('recipeModalTitle').textContent = "Buat Resep Baru", 300);
        };

        // --- NEW: LIST RESEP MODAL FUNCTION ---
        window.openRecipeListModal = () => {
            const container = document.getElementById('recipeListModalContent');
            if(!container) return;

            const keys = Object.keys(recipes);
            if (keys.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 text-xs py-8 italic border-2 border-dashed border-slate-700 rounded-lg">Belum ada resep aktif.</div>';
            } else {
                container.innerHTML = keys.map(name => {
                    const rec = recipes[name];
                    const reqs = Object.entries(rec.requirements).map(([m,q]) => {
                        const currentStock = warehouseStock[m] || 0;
                        const isEnough = currentStock >= q;
                        const stockColor = isEnough ? 'text-slate-400' : 'text-rose-500 font-bold';
                        
                        return `<div class="flex justify-between items-center text-xs text-slate-400 border-b border-slate-700/50 pb-1 mb-1 last:border-0 last:mb-0 last:pb-0">
                            <span>${m}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] ${stockColor} mr-1" title="Stok Gudang">${currentStock}</span>
                                <span class="font-mono text-emerald-400 font-bold bg-slate-900 px-1.5 rounded" title="Butuh per unit">${q}</span>
                            </div>
                        </div>`;
                    }).join('');

                    return `
                        <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 hover:border-purple-500/50 transition group shadow-sm recipe-card">
                            <div class="flex justify-between items-start mb-3 pb-2 border-b border-slate-700">
                                <h4 class="font-bold text-white text-sm uppercase tracking-wide flex items-center">
                                    <i class="fas fa-box-open text-purple-500 mr-2"></i> ${name}
                                </h4>
                                <div class="flex gap-1 recipe-card-actions">
                                    <button onclick='editRecipe("${name}")' class="text-slate-600 hover:text-blue-400 transition p-1.5 rounded hover:bg-slate-700" title="Edit Resep">
                                        <i class="fas fa-edit text-xs"></i>
                                    </button>
                                    <button onclick='deleteRecipe("${name}")' class="text-slate-600 hover:text-rose-500 transition p-1.5 rounded hover:bg-slate-700" title="Hapus Resep">
                                        <i class="fas fa-trash-alt text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="bg-slate-900/50 rounded p-2 border border-slate-800/50">
                                <div class="flex justify-between items-center mb-2 border-b border-slate-800 pb-1">
                                    <p class="text-[10px] uppercase font-bold text-slate-500">Komposisi Bahan</p>
                                    <p class="text-[9px] text-slate-500 italic">(Punya / Butuh)</p>
                                </div>
                                <div class="space-y-1">
                                    ${reqs}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('recipeListModal').classList.remove('hidden');
        };

        window.closeRecipeListModal = () => {
            document.getElementById('recipeListModal').classList.add('hidden');
        };

        // --- DEPRECATED SINGLE CRAFT (KEPT FOR REFERENCE OR REMOVED) ---
        // calculateCraft and doCraft removed in favor of queue system for the main panel
        window.calculateCraft = () => {}; // Dummy to prevent error if called
        window.doCraft = async () => {}; // Dummy

        // --- NEW: PRODUCT CLASS MANAGER ---
        window.openProductClassManager = () => {
            renderProductClassTable();
            document.getElementById('productClassModal').classList.remove('hidden');
        };

        window.closeProductClassModal = () => {
            document.getElementById('productClassModal').classList.add('hidden');
        };

         window.renderProductClassTable = () => {
            const tbody = document.getElementById('product-class-table-body');
            const searchInput = document.getElementById('product-class-search');
            const filter = searchInput ? searchInput.value.toUpperCase() : '';
            
            if(!tbody) return;
            
            if(productStock.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-slate-500 italic">Belum ada produk. Lakukan Crafting terlebih dahulu.</td></tr>';
                return;
            }
            
            const filtered = productStock.filter(p => p.name.toUpperCase().includes(filter));
            
            if(filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-slate-500 italic">Tidak ada produk yang cocok.</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(w => {
                const wClass = w.weaponClass || w.category || 'BELUM DISET';
                let badgeColor = 'bg-slate-700 text-slate-300';
                
                if(wClass === 'KELAS 1') badgeColor = 'bg-red-900/50 text-red-300 border border-red-700';
                else if(wClass === 'KELAS 2') badgeColor = 'bg-orange-900/50 text-orange-300 border border-orange-700';
                else if(wClass === 'KELAS 3') badgeColor = 'bg-yellow-900/50 text-yellow-300 border border-yellow-700';
                else if(wClass === 'KELAS 4') badgeColor = 'bg-green-900/50 text-green-300 border border-green-700';
                else if(wClass === 'AKSESORIS') badgeColor = 'bg-purple-900/50 text-purple-300 border border-purple-700';
                
                // Calculate cost from recipe if available
                const calculatedCost = calculateCostFromRecipe(w.name);
                const displayCost = calculatedCost > 0 ? calculatedCost : (w.costPrice || 0);
                const isAutoCalculated = calculatedCost > 0;
                
                return `
                    <tr class="border-b border-slate-700 hover:bg-slate-700/30 transition">
                        <td class="p-3">
                            <div class="font-bold text-slate-200 text-sm">${w.name}</div>
                            <div class="text-xs text-slate-500 mt-0.5">Stok: ${w.stock} | Harga: Rp ${w.sellingPrice.toLocaleString()}</div>
                        </td>
                        <td class="p-3 text-center">
                            <span class="text-[9px] ${badgeColor} px-3 py-1 rounded font-bold uppercase">${wClass}</span>
                        </td>
                        <td class="p-3 text-center">
                            <button onclick="openEditProductClass('${w.id}', '${w.name}', '${wClass}')" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs font-bold transition">
                                <i class="fas fa-edit mr-1"></i> Ubah
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        window.openEditProductClass = (productId, productName, currentClass) => {
            document.getElementById('edit-class-product-id').value = productId;
            document.getElementById('edit-class-product-name').textContent = productName;
            document.getElementById('edit-class-select').value = currentClass === 'BELUM DISET' ? '' : currentClass;
            document.getElementById('editProductClassModal').classList.remove('hidden');
        };

        window.closeEditProductClassModal = () => {
            document.getElementById('editProductClassModal').classList.add('hidden');
        };

             window.saveProductClass = async () => {
            const productId = document.getElementById('edit-class-product-id').value;
            const productName = document.getElementById('edit-class-product-name').textContent;
            const newClass = document.getElementById('edit-class-select').value;
            
            if(!newClass) {
                return showAlert("Error", "Pilih kelas produk terlebih dahulu!", "warning");
            }
            
            try {
                const productRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', productId);
                await updateDoc(productRef, {
                    weaponClass: newClass,
                    category: newClass
                });
                
                // Update local state immediately
                const productIndex = productStock.findIndex(p => p.id === productId);
                if(productIndex !== -1) {
                    productStock[productIndex].weaponClass = newClass;
                    productStock[productIndex].category = newClass;
                }
                
                // Re-render all views that depend on product class
                renderProductClassTable();
                renderPosGrid();
                renderInventoryTable();
                
                showAlert("Berhasil", `Kelas produk <b>${productName}</b> berhasil diupdate menjadi <b>${newClass}</b>!`, "success");
                closeEditProductClassModal();
            } catch(err) {
                console.error(err);
                showAlert("Error", "Gagal mengupdate kelas produk: " + err.message, "error");
            }
        };

         // Helper: Calculate cost price from recipe
        window.calculateCostFromRecipe = (productName) => {
            const recipe = recipes[productName];
            if (!recipe || !recipe.requirements) return 0;
            
            let totalCost = 0;
            Object.entries(recipe.requirements).forEach(([material, qty]) => {
                const materialPrice = materialPrices[material] || 0;
                totalCost += materialPrice * qty;
            });
            
            return totalCost;
        };

        // ==========================================
        // MODULE 5: WEAPON DATABASE
        // ==========================================
        
        
        // Sync weapon data to products
        window.syncWeaponToProducts = async () => {
            if(productStock.length === 0) {
                return showAlert("Info", "Belum ada produk untuk disync. Lakukan crafting terlebih dahulu.", "info");
            }
            
            showConfirm(
                "Sync Harga ke POS?",
                "Apakah Anda yakin ingin menyinkronkan harga dari Database Senjata ke produk POS?",
                async () => {
                    try {
                        const batch = writeBatch(db);
                        let syncCount = 0;
                        
                        productStock.forEach(prod => {
                            const weaponData = weaponDatabase.find(w => w.name === prod.name);
                            
                            if(weaponData) {
                                const prodRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', prod.id);
                                batch.update(prodRef, {
                                    sellingPrice: weaponData.sellingPrice || 0,
                                    weaponClass: weaponData.weaponClass || prod.category,
                                    category: weaponData.weaponClass || prod.category
                                });
                                syncCount++;
                            }
                        });
                        
                        if(syncCount > 0) {
                            await batch.commit();
                            showAlert("Berhasil", `Berhasil sync ${syncCount} produk dengan Database Senjata!`, "success");
                        } else {
                            showAlert("Info", "Tidak ada produk yang perlu disync.", "info");
                        }
                    } catch(err) {
                        console.error(err);
                        showAlert("Error", "Gagal sync: " + err.message, "error");
                    }
                },
                "info"
            );
        };
        window.renderWeaponDatabase = () => {
            const tbody = document.getElementById('weapon-db-table-body');
            const searchInput = document.getElementById('weapon-db-search');
            const filterClass = document.getElementById('weapon-db-filter-class');
            
            if(!tbody) return;
            
            // DEBUG: Log untuk cek data
            console.log('Weapon Database:', weaponDatabase);
            console.log('Material Prices:', materialPrices);
            console.log('Recipes:', recipes);
            
            let filtered = weaponDatabase;
            
            // Filter by search
            if(searchInput && searchInput.value) {
                const search = searchInput.value.toUpperCase();
                filtered = filtered.filter(w => w.name.toUpperCase().includes(search));
            }
            
            // Filter by class
            if(filterClass && filterClass.value && filterClass.value !== 'SEMUA') {
                filtered = filtered.filter(w => w.weaponClass === filterClass.value);
            }
            
            if(filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-slate-500 italic">Tidak ada data senjata. Import Excel untuk menambahkan.</td></tr>';
                return;
            }
            
            try {
                tbody.innerHTML = filtered.map(w => {
                    const wClass = w.weaponClass || 'Umum';
                    let badgeColor = 'bg-slate-700 text-slate-300';
                    
                    if(wClass === 'KELAS 1') badgeColor = 'bg-red-900/50 text-red-300 border border-red-700';
                    else if(wClass === 'KELAS 2') badgeColor = 'bg-orange-900/50 text-orange-300 border border-orange-700';
                    else if(wClass === 'KELAS 3') badgeColor = 'bg-yellow-900/50 text-yellow-300 border border-yellow-700';
                    else if(wClass === 'KELAS 4') badgeColor = 'bg-green-900/50 text-green-300 border border-green-700';
                    else if(wClass === 'AKSESORIS') badgeColor = 'bg-purple-900/50 text-purple-300 border border-purple-700';
                    
                    // Calculate cost from recipe if available
                    let calculatedCost = 0;
                    let displayCost = 0;
                    let isAutoCalculated = false;
                    
                    try {
                        calculatedCost = calculateCostFromRecipe(w.name);
                        displayCost = calculatedCost > 0 ? calculatedCost : (w.costPrice || 0);
                        isAutoCalculated = calculatedCost > 0;
                    } catch(err) {
                        console.error('Error calculating cost for', w.name, err);
                        displayCost = w.costPrice || 0;
                    }
                    
                    return `
                        <tr class="border-b border-slate-700 hover:bg-slate-700/30 transition">
                            <td class="p-3">
                                <div class="font-bold text-slate-200 text-sm">${w.name}</div>
                                ${isAutoCalculated ? '<div class="text-[9px] text-blue-400 mt-1"><i class="fas fa-calculator mr-1"></i>Auto-calculated</div>' : ''}
                            </td>
                            <td class="p-3 text-center">
                                <span class="text-[9px] ${badgeColor} px-2 py-1 rounded font-bold uppercase">${wClass}</span>
                            </td>
                            <td class="p-3 text-right font-mono ${isAutoCalculated ? 'text-blue-400' : 'text-yellow-400'}">Rp ${displayCost.toLocaleString()}</td>
                            <td class="p-3 text-right font-mono text-emerald-400">Rp ${(w.sellingPrice || 0).toLocaleString()}</td>
                            <td class="p-3 text-center">
                                <div class="flex justify-center gap-2">
                                    <button onclick="editWeaponData('${w.id}')" class="text-blue-400 hover:text-white transition" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteWeaponData('${w.id}', '${w.name}')" class="text-rose-400 hover:text-white transition" title="Hapus">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch(err) {
                console.error('Error rendering weapon database:', err);
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-rose-500">Error menampilkan data. Cek console.</td></tr>';
            }
        };
        
        window.importWeaponDatabase = async (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if (jsonData.length === 0) {
                        return showAlert("File Kosong", "File Excel tidak berisi data.", "warning");
                    }

                    const batch = writeBatch(db);
                    let successCount = 0;

                    jsonData.forEach(row => {
                        const name = (row['Nama Senjata'] || row['Name'] || row['Nama'])?.toString().trim().toUpperCase();
                        const weaponClass = (row['Kelas'] || row['Class'] || row['Kategori'])?.toString().trim().toUpperCase();
                        const costPrice = parseFloat(row['Harga Modal'] || row['Cost Price'] || row['Modal'] || 0);
                        const sellingPrice = parseFloat(row['Harga Jual'] || row['Selling Price'] || row['Jual'] || 0);

                        if (name) {
                            const weaponRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'weapon_database'));
                            batch.set(weaponRef, {
                                name,
                                weaponClass: weaponClass || 'Umum',
                                costPrice,
                                sellingPrice
                            });
                            successCount++;
                        }
                    });

                    if (successCount > 0) {
                        await batch.commit();
                        showAlert("Berhasil", `Berhasil mengimport <b>${successCount}</b> data senjata!`, "success");
                    } else {
                        showAlert("Gagal", "Tidak ada data valid untuk diimport. Pastikan ada kolom 'Nama Senjata'.", "error");
                    }
                    
                    input.value = '';
                } catch (err) {
                    console.error(err);
                    showAlert("Error", "Gagal membaca Excel: " + err.message, "error");
                }
            };
            reader.readAsArrayBuffer(file);
        };
        
        window.openAddWeaponModal = () => {
            document.getElementById('weapon-form').reset();
            document.getElementById('weapon-modal-title').textContent = 'Tambah Senjata Baru';
            document.getElementById('weapon-id-input').value = '';
            document.getElementById('addWeaponModal').classList.remove('hidden');
        };
        
        window.closeAddWeaponModal = () => {
            document.getElementById('addWeaponModal').classList.add('hidden');
        };
        
        window.saveWeaponData = async (e) => {
            e.preventDefault();
            
            const weaponId = document.getElementById('weapon-id-input').value;
            const name = document.getElementById('weapon-name').value.trim().toUpperCase();
            const weaponClass = document.getElementById('weapon-class').value;
            const costPrice = parseFloat(document.getElementById('weapon-cost').value) || 0;
            const sellingPrice = parseFloat(document.getElementById('weapon-sell').value) || 0;
            
            if(!name) return showAlert("Error", "Nama senjata harus diisi!", "warning");
            if(!weaponClass) return showAlert("Error", "Pilih kelas senjata!", "warning");
            
            try {
                const weaponData = { name, weaponClass, costPrice, sellingPrice };
                
                if(weaponId) {
                    // Update existing
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'weapon_database', weaponId), weaponData);
                    showAlert("Berhasil", "Data senjata berhasil diupdate!", "success");
                } else {
                    // Add new
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'weapon_database'), weaponData);
                    showAlert("Berhasil", "Senjata baru berhasil ditambahkan!", "success");
                }
                
                closeAddWeaponModal();
            } catch(err) {
                console.error(err);
                showAlert("Error", "Gagal menyimpan data: " + err.message, "error");
            }
        };
        
        window.editWeaponData = (weaponId) => {
            const weapon = weaponDatabase.find(w => w.id === weaponId);
            if(!weapon) return;
            
            document.getElementById('weapon-modal-title').textContent = 'Edit Data Senjata';
            document.getElementById('weapon-id-input').value = weaponId;
            document.getElementById('weapon-name').value = weapon.name;
            document.getElementById('weapon-class').value = weapon.weaponClass;
            document.getElementById('weapon-cost').value = weapon.costPrice || 0;
            document.getElementById('weapon-sell').value = weapon.sellingPrice || 0;
            
            document.getElementById('addWeaponModal').classList.remove('hidden');
        };
        
        window.deleteWeaponData = (weaponId, weaponName) => {
            showConfirm("Hapus Data Senjata?", `Yakin ingin menghapus <b>${weaponName}</b> dari database?`, async () => {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'weapon_database', weaponId));
                    showAlert("Berhasil", "Data senjata berhasil dihapus.", "success");
                } catch(err) {
                    console.error(err);
                    showAlert("Error", "Gagal menghapus: " + err.message, "error");
                }
            }, "danger");
        };
        
        window.deleteAllWeaponDatabase = () => {
            if(weaponDatabase.length === 0) {
                return showAlert("Info", "Database senjata sudah kosong.", "info");
            }
            
            showConfirm(
                "Hapus Semua Database?",
                `Apakah Anda yakin ingin menghapus <b>SEMUA ${weaponDatabase.length} data senjata</b>?<br><br><span class='text-rose-500 font-bold'>PERINGATAN: Aksi ini tidak dapat dibatalkan!</span>`,
                async () => {
                    try {
                        const batch = writeBatch(db);
                        weaponDatabase.forEach(w => {
                            batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'weapon_database', w.id));
                        });
                        
                        await batch.commit();
                        showAlert("Berhasil", `Berhasil menghapus ${weaponDatabase.length} data senjata.`, "success");
                    } catch(err) {
                        console.error(err);
                        showAlert("Error", "Gagal menghapus database: " + err.message, "error");
                    }
                },
                "danger"
            );
        };

        // ==========================================
        // MODULE 3: GUN POS (PENJUALAN)
        // ==========================================
        let cart = [];

        window.renderPosGrid = () => {
    const grid = document.getElementById('pos-grid');
    
    // Filter products based on selected class
    let filtered = productStock;
    if(posFilterClass !== 'SEMUA') {
        filtered = productStock.filter(p => (p.weaponClass || p.category) === posFilterClass);
    }
    
    if(filtered.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center text-slate-500 py-20">Tidak ada produk di kategori ini.</div>';
        return;
    }
    
    grid.innerHTML = filtered.map(p => {
        const inStock = p.stock > 0;
        const wClass = p.weaponClass || p.category || 'Umum';

         // Calculate cost from recipe
        const calculatedCost = calculateCostFromRecipe(p.name);
        const displayCost = calculatedCost > 0 ? calculatedCost : (p.costPrice || 0);
        const profit = p.sellingPrice - displayCost;
        const profitMargin = displayCost > 0 ? ((profit / displayCost) * 100).toFixed(1) : 0;
        
        // Dynamic badge color based on class
        let badgeColor = 'bg-slate-700 text-slate-300';
        if(wClass === 'KELAS 1') badgeColor = 'bg-red-900/50 text-red-300 border border-red-700';
        else if(wClass === 'KELAS 2') badgeColor = 'bg-orange-900/50 text-orange-300 border border-orange-700';
        else if(wClass === 'KELAS 3') badgeColor = 'bg-yellow-900/50 text-yellow-300 border border-yellow-700';
        else if(wClass === 'KELAS 4') badgeColor = 'bg-green-900/50 text-green-300 border border-green-700';
        else if(wClass === 'AKSESORIS') badgeColor = 'bg-purple-900/50 text-purple-300 border border-purple-700';
        
        return `
        <div onclick="${inStock ? `addToCart('${p.id}')` : ''}" 
            class="bg-slate-800 border ${inStock ? 'border-slate-700 hover:border-blue-500 cursor-pointer' : 'border-rose-900/50 opacity-60'} rounded-lg p-4 relative group transition">
            <div class="flex justify-between items-start mb-2">
                <h4 class="font-bold text-white text-sm">${p.name}</h4>
                <span class="text-[9px] ${badgeColor} px-2 py-0.5 rounded font-bold uppercase">${wClass}</span>
            </div>
            <div class="mb-2">
                <div class="text-[9px] text-slate-500 mb-0.5">Modal: <span class="text-yellow-400 font-mono">Rp ${displayCost.toLocaleString()}</span></div>
                <div class="text-[9px] text-slate-500">Profit: <span class="text-emerald-400 font-mono">Rp ${profit.toLocaleString()} (${profitMargin}%)</span></div>
            </div>
            <div class="flex justify-between items-end">
                <span class="text-xs text-slate-400">Stok: ${p.stock}</span>
                <span class="text-emerald-400 font-bold text-sm">Rp ${p.sellingPrice.toLocaleString()}</span>
            </div>
            ${!inStock ? '<div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-lg text-rose-500 font-bold text-xs">HABIS</div>' : ''}
        </div>`;
    }).join('');
};

        window.addToCart = (id) => {
            const prod = productStock.find(p => p.id === id);
            const item = cart.find(c => c.id === id);
            
            if(item) {
                if(item.qty < prod.stock) item.qty++;
                else showToast('Stok tidak cukup', 'error');
            } else {
                cart.push({ ...prod, qty: 1 });
            }
            renderCart();
        };

        window.renderCart = () => {
            const container = document.getElementById('pos-cart-items');
            let total = 0;
            let totalProfit = 0;
            
            container.innerHTML = cart.map((c, idx) => {
                const sub = c.qty * c.sellingPrice;
                total += sub;
                
                // Calculate cost and profit
                const calculatedCost = calculateCostFromRecipe(c.name);
                const displayCost = calculatedCost > 0 ? calculatedCost : (c.costPrice || 0);
                const itemProfit = (c.sellingPrice - displayCost) * c.qty;
                totalProfit += itemProfit;
                return `
                <div class="flex justify-between items-center bg-slate-800 p-2 rounded mb-2 text-sm border border-slate-700">
                    <div class="flex-1">
                        <div class="font-bold text-slate-200">${c.name}</div>
                        <div class="text-xs text-slate-500">@ ${c.sellingPrice.toLocaleString()}</div>
                        <div class="text-[9px] text-emerald-400">Profit: Rp ${itemProfit.toLocaleString()}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateCart(${idx}, -1)" class="w-6 h-6 bg-slate-700 rounded text-xs">-</button>
                        <span class="font-bold w-4 text-center text-white">${c.qty}</span>
                        <button onclick="updateCart(${idx}, 1)" class="w-6 h-6 bg-blue-600 rounded text-xs">+</button>
                    </div>
                </div>`;
            }).join('');

             // Add profit summary
            if(cart.length > 0) {
                container.innerHTML += `
                    <div class="mt-3 p-2 bg-emerald-900/20 border border-emerald-700/50 rounded text-xs">
                        <div class="flex justify-between text-emerald-400">
                            <span>Total Profit Transaksi:</span>
                            <span class="font-bold font-mono">Rp ${totalProfit.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('pos-total').innerText = `Rp ${total.toLocaleString()}`;
            document.getElementById('btn-checkout').disabled = cart.length === 0;
        };

        window.updateCart = (idx, delta) => {
            const item = cart[idx];
            const prod = productStock.find(p => p.id === item.id);
            const newQty = item.qty + delta;
            if(newQty > prod.stock) return showToast('Melebihi stok gudang', 'error');
            if(newQty <= 0) cart.splice(idx, 1);
            else item.qty = newQty;
            renderCart();
        };

    window.checkout = async () => {
    if(cart.length === 0) return;
    
    const pic = document.getElementById('pos-pic').value.trim();
    const groupId = document.getElementById('pos-group-select').value;
    
    // Validation
    if(!pic) return showAlert("Error", "Nama PIC harus diisi!", "warning");
    if(!groupId) return showAlert("Error", "Pilih kelompok pembeli!", "warning");
    
    // Get group data
    const group = groupDatabase.find(g => g.id === groupId);
    if(!group) return showAlert("Error", "Data kelompok tidak ditemukan!", "error");
    
    // Calculate cart by class
    const cartByClass = {
        'KELAS 1': 0,
        'KELAS 2': 0,
        'KELAS 3': 0,
        'KELAS 4': 0,
        'AKSESORIS': 0
    };
    
    cart.forEach(item => {
        const wClass = item.weaponClass || item.category || 'KELAS 4';
        cartByClass[wClass] = (cartByClass[wClass] || 0) + item.qty;
    });
    
    // Check limits
    const usedK1 = group.usedKelas1 || 0;
    const usedK2 = group.usedKelas2 || 0;
    const usedK3 = group.usedKelas3 || 0;
    const usedK4 = group.usedKelas4 || 0;
    const usedAcc = group.usedAksesoris || 0;
    
    const limitK1 = group.limitKelas1 || 0;
    const limitK2 = group.limitKelas2 || 0;
    const limitK3 = group.limitKelas3 || 0;
    const limitK4 = group.limitKelas4 || 0;
    const limitAcc = group.limitAksesoris || 0;
    
    let limitExceeded = [];
    
    if(usedK1 + cartByClass['KELAS 1'] > limitK1) {
        limitExceeded.push(`Kelas 1 (Limit: ${limitK1}, Terpakai: ${usedK1}, Request: ${cartByClass['KELAS 1']})`);
    }
    if(usedK2 + cartByClass['KELAS 2'] > limitK2) {
        limitExceeded.push(`Kelas 2 (Limit: ${limitK2}, Terpakai: ${usedK2}, Request: ${cartByClass['KELAS 2']})`);
    }
    if(usedK3 + cartByClass['KELAS 3'] > limitK3) {
        limitExceeded.push(`Kelas 3 (Limit: ${limitK3}, Terpakai: ${usedK3}, Request: ${cartByClass['KELAS 3']})`);
    }
    if(usedK4 + cartByClass['KELAS 4'] > limitK4) {
        limitExceeded.push(`Kelas 4 (Limit: ${limitK4}, Terpakai: ${usedK4}, Request: ${cartByClass['KELAS 4']})`);
    }
    if(usedAcc + cartByClass['AKSESORIS'] > limitAcc) {
        limitExceeded.push(`Aksesoris (Limit: ${limitAcc}, Terpakai: ${usedAcc}, Request: ${cartByClass['AKSESORIS']})`);
    }
    
    if(limitExceeded.length > 0) {
        return showAlert("Limit Tercapai!", 
            `Transaksi melebihi batas limit kelompok <b>${group.name}</b>:<br><br>` +
            limitExceeded.map(l => ` ${l}`).join('<br>'), 
            "error");
    }
    
    // Proceed with transaction
    showConfirm('Proses Transaksi?', 
        `Kelompok: <b>${group.name}</b><br>PIC: <b>${pic}</b><br><br>` +
        `Lanjutkan transaksi?`, 
        async () => {
            const batch = writeBatch(db);
            let totalSales = 0;
            const descItems = [];

            // Update group usage
            const groupRef = doc(db, 'artifacts', appId, 'public', 'data', 'groups', groupId);
            batch.update(groupRef, {
                usedKelas1: usedK1 + cartByClass['KELAS 1'],
                usedKelas2: usedK2 + cartByClass['KELAS 2'],
                usedKelas3: usedK3 + cartByClass['KELAS 3'],
                usedKelas4: usedK4 + cartByClass['KELAS 4'],
                usedAksesoris: usedAcc + cartByClass['AKSESORIS']
            });

// Create detailed log with before/after stock
// Update product stock & prepare detailed items
const itemsDetail = [];
cart.forEach(item => {
    const prod = productStock.find(p => p.id === item.id);
    const stockBefore = prod.stock;
    const stockAfter = prod.stock - item.qty;
    const remaining = stockAfter;
    
    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'products', item.id);
    batch.update(ref, { stock: remaining });
    
    totalSales += (item.qty * item.sellingPrice);
    descItems.push(`${item.name} (${item.qty})`);
    
    // Store detailed item info
    itemsDetail.push({
        name: item.name,
        weaponClass: item.weaponClass || item.category || 'Umum',
        qty: item.qty,
        price: item.sellingPrice,
        subtotal: item.qty * item.sellingPrice,
        stockBefore: stockBefore,
        stockAfter: stockAfter
    });
});
const logRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'global_history'));
batch.set(logRef, {
    type: 'SALES',
    desc: `Penjualan ke ${group.name}: ${descItems.join(', ')}`,
    amount: totalSales,
    pic: pic,
    groupName: group.name,
    groupId: groupId,
    timestamp: serverTimestamp(),
    itemsDetail: itemsDetail, // NEW: Detailed items with stock info
    limitUsed: {
        kelas1: cartByClass['KELAS 1'],
        kelas2: cartByClass['KELAS 2'],
        kelas3: cartByClass['KELAS 3'],
        kelas4: cartByClass['KELAS 4'],
        aksesoris: cartByClass['AKSESORIS']
    }
});

            await batch.commit();

// Save transaction details for report with stock info
lastSalesTransaction = {
    timestamp: new Date(),
    groupName: group.name,
    groupId: groupId,
    pic: pic,
    items: cart.map(item => {
        const prod = productStock.find(p => p.id === item.id);
        return {
            name: item.name,
            qty: item.qty,
            price: item.sellingPrice,
            subtotal: item.qty * item.sellingPrice,
            weaponClass: item.weaponClass || item.category,
            stockBefore: prod.stock,
            stockAfter: prod.stock - item.qty
        };
    }),
    totalAmount: totalSales,
    limitUsed: {
        kelas1: cartByClass['KELAS 1'],
        kelas2: cartByClass['KELAS 2'],
        kelas3: cartByClass['KELAS 3'],
        kelas4: cartByClass['KELAS 4'],
        aksesoris: cartByClass['AKSESORIS']
    }
};

cart = [];
renderCart();
document.getElementById('pos-pic').value = '';
document.getElementById('pos-group-select').value = '';

// Show success with option to view report
showConfirm(
    "Transaksi Berhasil! ",
    `Transaksi penjualan berhasil diproses.<br><br>` +
    `<b>Total: Rp ${totalSales.toLocaleString()}</b><br><br>` +
    `Apakah Anda ingin melihat laporan transaksi?`,
    () => {
        openSalesReportModal();
    },
    "success"
);
    }, 'info');
};

window.renderSalesHistory = () => {
    const container = document.getElementById('sales-history-container');
    if(!container) return;
    
    if(salesHistory.length === 0) {
        container.innerHTML = '<div class="text-center text-slate-500 py-10 italic">Belum ada transaksi penjualan.</div>';
        return;
    }
    
    container.innerHTML = salesHistory.map((sale, idx) => {
        const date = sale.timestamp ? 
            new Date(sale.timestamp.seconds*1000).toLocaleString('id-ID', { 
                dateStyle: 'medium', 
                timeStyle: 'short' 
            }) : '-';
        
        // Calculate totals
        const totalItems = sale.itemsDetail ? sale.itemsDetail.reduce((sum, item) => sum + item.qty, 0) : 0;
        
        // Build items table
        const itemsHtml = sale.itemsDetail ? sale.itemsDetail.map(item => {
            let classColor = 'bg-slate-700 text-slate-300';
            if(item.weaponClass === 'KELAS 1') classColor = 'bg-red-900/50 text-red-300';
            else if(item.weaponClass === 'KELAS 2') classColor = 'bg-orange-900/50 text-orange-300';
            else if(item.weaponClass === 'KELAS 3') classColor = 'bg-yellow-900/50 text-yellow-300';
            else if(item.weaponClass === 'KELAS 4') classColor = 'bg-green-900/50 text-green-300';
            else if(item.weaponClass === 'AKSESORIS') classColor = 'bg-purple-900/50 text-purple-300';
            
            return `
                <tr class="border-b border-slate-700/50 text-xs">
                    <td class="p-2">
                        <div class="font-bold text-slate-200">${item.name}</div>
                        <span class="text-[8px] ${classColor} px-1.5 py-0.5 rounded mt-1 inline-block">${item.weaponClass || 'Umum'}</span>
                    </td>
                    <td class="p-2 text-center font-mono text-slate-300">${item.qty}</td>
                    <td class="p-2 text-center">
                        <div class="flex items-center justify-center gap-1 text-slate-400">
                            <span class="font-mono">${item.stockBefore}</span>
                            <i class="fas fa-arrow-right text-[8px]"></i>
                            <span class="font-mono text-rose-400 font-bold">${item.stockAfter}</span>
                        </div>
                    </td>
                    <td class="p-2 text-right font-mono text-emerald-400">Rp ${(item.subtotal || 0).toLocaleString()}</td>
                </tr>
            `;
        }).join('') : '<tr><td colspan="4" class="p-3 text-center text-slate-500 italic">Detail tidak tersedia</td></tr>';
        
        return `
            <div class="bg-slate-800 border border-slate-700 rounded-lg mb-3 overflow-hidden">
                <!-- Header (Always Visible) - Clickable -->
                <div onclick="toggleSalesDetail(${idx})" 
                     class="p-4 cursor-pointer hover:bg-slate-700/50 transition flex justify-between items-center">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-1">
                            <h4 class="font-bold text-emerald-400">Transaksi #${salesHistory.length - idx}</h4>
                            <span class="text-xs bg-emerald-900/50 text-emerald-300 px-2 py-0.5 rounded border border-emerald-700/50">
                                ${sale.groupName}
                            </span>
                        </div>
                        <p class="text-xs text-slate-400">
                            <i class="fas fa-clock mr-1"></i> ${date}
                        </p>
                        <div class="flex gap-4 mt-2 text-xs">
                            <span class="text-slate-500">
                                <i class="fas fa-user text-blue-400 mr-1"></i> ${sale.pic}
                            </span>
                            <span class="text-slate-500">
                                <i class="fas fa-boxes text-purple-400 mr-1"></i> ${totalItems} Unit
                            </span>
                            <span class="text-slate-500">
                                <i class="fas fa-money-bill-wave text-emerald-400 mr-1"></i> Rp ${(sale.amount || 0).toLocaleString()}
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="event.stopPropagation(); takeElementScreenshot('sales-detail-${idx}', 'Transaksi_${idx}')" 
                                class="text-slate-400 hover:text-white bg-slate-700 hover:bg-slate-600 rounded px-3 py-2 transition text-xs">
                            <i class="fas fa-camera"></i>
                        </button>
                        <i id="sales-icon-${idx}" class="fas fa-chevron-down text-slate-500 transition-transform"></i>
                    </div>
                </div>
                
                <!-- Detail (Collapsible) -->
                <div id="sales-detail-${idx}" class="hidden">
                    <div class="p-4 pt-0 border-t border-slate-700">
                        <div class="mb-3">
                            <h5 class="text-xs font-bold text-slate-400 uppercase mb-2">
                                <i class="fas fa-list mr-1"></i> Detail Pembelian
                            </h5>
                            <div class="border border-slate-700 rounded overflow-hidden bg-slate-900/30">
                                <table class="w-full text-left">
                                    <thead class="bg-slate-800 text-[10px] text-slate-500 uppercase">
                                        <tr>
                                            <th class="p-2">Produk</th>
                                            <th class="p-2 text-center">Qty</th>
                                            <th class="p-2 text-center">Stok (BeforeAfter)</th>
                                            <th class="p-2 text-right">Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${itemsHtml}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center bg-emerald-900/20 border border-emerald-700/50 rounded p-3">
                            <span class="text-slate-400 font-bold text-sm uppercase">Total Pembayaran</span>
                            <span class="text-xl font-bold text-emerald-400">Rp ${(sale.amount || 0).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
};

window.toggleSalesDetail = (idx) => {
    const detail = document.getElementById(`sales-detail-${idx}`);
    const icon = document.getElementById(`sales-icon-${idx}`);
    
    if(!detail || !icon) return;
    
    const isHidden = detail.classList.contains('hidden');
    
    if(isHidden) {
        // Expand
        detail.classList.remove('hidden');
        detail.style.animation = 'slideDown 0.3s ease-out';
        icon.style.transform = 'rotate(180deg)';
    } else {
        // Collapse
        detail.style.animation = 'slideUp 0.3s ease-out';
        setTimeout(() => {
            detail.classList.add('hidden');
        }, 250);
        icon.style.transform = 'rotate(0deg)';
    }
};

        // ==========================================
        // MODULE 4: HISTORY & GLOBAL
        // ==========================================

        window.addLog = async (data) => {
            const logData = { timestamp: serverTimestamp(), ...data };
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'global_history'), logData);
        };
        
        // --- NEW: DELETE & VIEW DETAILS GLOBAL HISTORY ---
        window.deleteGlobalLog = (id) => {
            showConfirm("Hapus Riwayat?", "Apakah Anda yakin ingin menghapus catatan riwayat ini? Stok tidak akan berubah.", async () => {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'global_history', id));
                    showToast("Riwayat berhasil dihapus.", "success");
                } catch(err) {
                    console.error(err);
                    showAlert("Error", "Gagal menghapus riwayat: " + err.message, "error");
                }
            }, "danger");
        };

        window.viewLogDetails = (id) => {
            const log = warehouseHistory.find(l => l.id === id);
            if (!log) return;
            
            const modal = document.getElementById('transactionDetailModal');
            const title = document.getElementById('td-title');
            const content = document.getElementById('td-content');
            
            title.textContent = `Detail Transaksi: ${log.type}`;
            let html = '';
            
            // Format Content based on log type
            if (log.details && Array.isArray(log.details)) {
                // Crafting details structure
                html = log.details.map(item => {
                    let matsHtml = '';
                    if(item.materials) {
                        matsHtml = Object.entries(item.materials).map(([mat, qty]) => 
                            `<div class="flex justify-between text-xs text-slate-400 border-b border-slate-700/30 pb-1 mb-1 last:border-0">
                                <span>${mat}</span>
                                <span class="font-mono text-emerald-400">${qty}</span>
                             </div>`
                        ).join('');
                    }
                    return `
                        <div class="bg-slate-800 p-3 rounded mb-3 border border-slate-700">
                            <div class="flex justify-between items-center mb-2 border-b border-slate-600 pb-2">
                                <span class="font-bold text-white">${item.name}</span>
                                <span class="text-xs bg-blue-900 text-blue-300 px-2 py-0.5 rounded">x${item.qty}</span>
                            </div>
                            <div>
                                <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Bahan Digunakan:</p>
                                ${matsHtml || '<span class="text-xs text-slate-500 italic">Tidak ada detail bahan</span>'}
                            </div>
                        </div>
                    `;
                }).join('');
            } else if (log.note) {
                 html = `<div class="p-4 bg-slate-800 rounded text-slate-300 text-sm">${log.note}</div>`;
            } else {
                 html = `<div class="p-4 bg-slate-800 rounded text-slate-300 text-sm">${log.desc}</div>`;
            }
            
            content.innerHTML = html;
            modal.classList.remove('hidden');
        };

        window.closeTransactionDetailModal = () => {
            document.getElementById('transactionDetailModal').classList.add('hidden');
        };

        window.renderHistoryTable = () => {
            const tbody = document.getElementById('hist-table-body');
            tbody.innerHTML = warehouseHistory.map(h => {
                let color = 'text-slate-400';
                if(h.type === 'SALES') color = 'text-emerald-400';
                if(h.type === 'CRAFTING') color = 'text-blue-400';
                if(h.type === 'WAREHOUSE') color = 'text-orange-400';

                // Check if details exist to show view button
                const showDetail = (h.details && h.details.length > 0) || h.note;
                const viewBtn = showDetail ? 
                    `<button onclick="viewLogDetails('${h.id}')" class="text-blue-400 hover:text-white mr-2" title="Lihat Detail"><i class="fas fa-eye"></i></button>` : 
                    `<span class="text-slate-700 mr-2"><i class="fas fa-eye-slash"></i></span>`;

                return `
                <tr class="border-b border-slate-800 text-xs hover:bg-slate-800/30">
                    <td class="p-3 text-slate-500">${h.timestamp ? new Date(h.timestamp.seconds*1000).toLocaleString() : '-'}</td>
                    <td class="p-3 font-bold ${color}">${h.type}</td>
                    <td class="p-3 text-slate-300">${h.desc}</td>
                    <td class="p-3 text-right font-mono">${h.amount && h.type === 'SALES' ? 'Rp '+h.amount.toLocaleString() : '-'}</td>
                    <td class="p-3 text-slate-500">${h.pic || '-'}</td>
                    <td class="p-3 text-center">
                        ${viewBtn}
                        <button onclick="deleteGlobalLog('${h.id}')" class="text-rose-400 hover:text-white" title="Hapus"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
        };

        // UI HELPERS
 window.switchTab = (tabId) => {
    document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    
    document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
    document.getElementById(`btn-${tabId}`).classList.add('active');
    
    // Auto-render when switching to POS
    if(tabId === 'pos') {
        setTimeout(() => {
            renderSalesHistory();
        }, 100);
    }
};
        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.innerHTML = msg;
            t.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-xl text-white font-bold transition transform duration-300 z-[110] ${type === 'error' ? 'bg-rose-600' : 'bg-emerald-600'}`;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        initApp();

    </script>
</head>

<body class="flex h-screen bg-slate-900">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col z-20 shrink-0">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div
                class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-900/50">
                <i class="fas fa-network-wired text-white"></i>
            </div>
            <div>
                <h1 class="font-bold text-white text-lg tracking-tight">VIKRAMA ERP</h1>
                <p id="connection-status" class="text-[10px] text-slate-500 font-mono">Connecting...</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <div id="btn-warehouse" onclick="switchTab('warehouse')"
                class="sidebar-item active px-6 py-3 text-slate-400 font-medium flex items-center gap-3">
                <i class="fas fa-warehouse w-5 text-center"></i>
                <span>Gudang Bahan</span>
            </div>
            <div id="btn-crafting" onclick="switchTab('crafting')"
                class="sidebar-item px-6 py-3 text-slate-400 font-medium flex items-center gap-3">
                <i class="fas fa-hammer w-5 text-center"></i>
                <span>Perakitan (Craft)</span>
            </div>
            <div id="btn-pos" onclick="switchTab('pos')"
                class="sidebar-item px-6 py-3 text-slate-400 font-medium flex items-center gap-3">
                <i class="fas fa-cash-register w-5 text-center"></i>
                <span>Toko Senjata (POS)</span>
            </div>
            <div id="btn-weapon-db" onclick="switchTab('weapon-db')"
                class="sidebar-item px-6 py-3 text-slate-400 font-medium flex items-center gap-3">
                <i class="fas fa-database w-5 text-center"></i>
                <span>Database Senjata</span>
            </div>
            <div id="btn-inventory" onclick="switchTab('inventory')"
                class="sidebar-item px-6 py-3 text-slate-400 font-medium flex items-center gap-3">
                <i class="fas fa-boxes w-5 text-center"></i>
                <span>Inventori Senjata</span>
            </div>
                        <div id="btn-history" onclick="switchTab('history')"
                class="sidebar-item px-6 py-3 text-slate-400 font-medium flex items-center gap-3">
                <i class="fas fa-history w-5 text-center"></i>
                <span>Riwayat Global</span>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-800 text-xs text-slate-600 text-center">
            v5.0 Recipe Import<br>
            &copy; 2025 Vikrama Kulapati
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-hidden relative bg-slate-900 text-slate-200">
        <div class="absolute inset-0 overflow-y-auto p-8 custom-scrollbar">

            <!-- 1. WAREHOUSE VIEW -->
            <section id="warehouse" class="page-section active w-full max-w-[95%] mx-auto">
                <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">Gudang Material</h2>
                        <p class="text-slate-400">Kelola stok bahan mentah untuk keperluan produksi.</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="openPriceModal()"
                            class="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-tags mr-2"></i> Harga Bahan
                        </button>
                        <button onclick="document.getElementById('wh-import-input').click()"
                            class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-file-excel mr-2"></i> Import Excel
                        </button>
                        <button onclick="openBulkModal()"
                            class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-layer-group mr-2"></i> Update Massal
                        </button>
                        <input type="file" id="wh-import-input" accept=".xlsx, .xls" class="hidden"
                            onchange="importWarehouseExcel(this)">
                    </div>
                </header>

                <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
                    <!-- INPUT FORM -->
                    <div class="xl:col-span-1 glass-panel p-6 rounded-xl h-fit">
                        <h3 class="text-lg font-bold text-blue-400 mb-4 flex items-center"><i
                                class="fas fa-plus-circle mr-2"></i>Input Material</h3>
                        <form id="wh-form" onsubmit="saveResource(event)" class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Nama Bahan</label>
                                <input type="text" id="wh-name" placeholder="Contoh: BESI, KAYU"
                                    class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:border-blue-500 outline-none uppercase font-bold">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Jumlah Masuk</label>
                                <input type="number" id="wh-qty" placeholder="0"
                                    class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:border-blue-500 outline-none">
                            </div>
                            <button type="submit"
                                class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2.5 rounded-lg transition shadow-lg shadow-blue-900/20">
                                SIMPAN STOK
                            </button>
                        </form>
                    </div>

                    <div class="xl:col-span-3 space-y-8">
                        <!-- TABEL STOK COMPACT -->
                        <div class="glass-panel p-6 rounded-xl flex flex-col h-[600px]">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-white flex items-center">
                                    <span><i class="fas fa-boxes mr-2 text-slate-500"></i>Stok Saat Ini</span>
                                </h3>
                                <div class="flex gap-2">
                                    <button id="btn-stock-screenshot" onclick="downloadStockScreenshot()"
                                        class="w-9 h-9 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300 flex items-center justify-center transition border border-slate-600"
                                        title="Ambil Screenshot Stok">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                    <div class="relative w-64">
                                        <i class="fas fa-search absolute left-3 top-3 text-slate-500 text-xs"></i>
                                        <input type="text" id="wh-list-search" onkeyup="renderWarehouseTable()"
                                            placeholder="Cari barang..."
                                            class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-9 p-2 text-sm text-white focus:border-blue-500 outline-none">
                                    </div>
                                </div>
                            </div>

                            <div
                                class="flex-1 overflow-y-auto custom-scrollbar border border-slate-700 rounded-lg bg-slate-900/30">
                                <table class="w-full text-left text-sm relative">
                                    <thead
                                        class="text-xs text-slate-400 uppercase bg-slate-800/90 sticky top-0 z-10 shadow-sm backdrop-blur-sm">
                                        <tr>
                                            <th class="p-3 text-left">Nama Resource</th>
                                            <th class="p-3 text-right">Stok</th>
                                            <th class="p-3 text-center w-32">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wh-table-body" class="divide-y divide-slate-700/50">
                                        <tr>
                                            <td colspan="3" class="p-8 text-center text-slate-500 italic"><i
                                                    class="fas fa-circle-notch fa-spin mr-2"></i>Memuat data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- TABEL RIWAYAT TRANSAKSI -->
                        <div class="glass-panel p-6 rounded-xl border-t-4 border-slate-700">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-white flex items-center">
                                    <i class="fas fa-history mr-2 text-slate-500"></i>Riwayat Transaksi Gudang
                                </h3>
                                <button id="btn-delete-all-hist" onclick="deleteAllHistory()"
                                    class="text-xs bg-rose-600/20 text-rose-400 hover:bg-rose-600 hover:text-white px-3 py-1.5 rounded-lg border border-rose-600/30 transition flex items-center">
                                    <i class="fas fa-trash-alt mr-2"></i> Hapus Semua
                                </button>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm whitespace-nowrap">
                                    <thead class="text-xs text-slate-500 uppercase bg-slate-800/50">
                                        <tr>
                                            <th class="p-3 rounded-l-lg">Tanggal</th>
                                            <th class="p-3">Resource</th>
                                            <th class="p-3 text-center">Tipe</th>
                                            <th class="p-3 text-center">Jml</th>
                                            <th class="p-3 text-center">Awal</th>
                                            <th class="p-3 text-center">Akhir</th>
                                            <th class="p-3">PIC</th>
                                            <th class="p-3">Ket</th>
                                            <th class="p-3 text-center">Bukti</th>
                                            <th class="p-3 text-center rounded-r-lg">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wh-history-body">
                                        <tr>
                                            <td colspan="10" class="p-4 text-center text-slate-500 italic">Memuat
                                                riwayat...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. CRAFTING VIEW -->
            <section id="crafting" class="page-section max-w-7xl mx-auto">
                <!-- NEW HEADER WITH STOCK PREVIEW -->
                <div class="mb-6 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-xs font-bold text-slate-400 uppercase flex items-center">
                            <i class="fas fa-cubes mr-2"></i>Stok Bahan Saat Ini (Preview)
                        </h4>
                        <button id="btn-preview-screenshot" onclick="downloadPreviewScreenshot()"
                            class="w-6 h-6 rounded bg-slate-700 hover:bg-slate-600 text-slate-300 flex items-center justify-center transition border border-slate-600"
                            title="Ambil Screenshot Preview">
                            <i class="fas fa-camera text-[10px]"></i>
                        </button>
                    </div>
                    <div id="material-stock-preview"
                        class="flex flex-wrap gap-2 max-h-24 overflow-y-auto custom-scrollbar">
                        <!-- Injected via JS -->
                        <span class="text-slate-500 text-xs italic">Memuat stok...</span>
                    </div>
                </div>

                <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">Pabrik Perakitan</h2>
                        <p class="text-slate-400">Ubah bahan mentah menjadi produk senjata siap jual.</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <!-- Tombol Daftar Resep Dipindahkan ke Sini -->
                        <button onclick="openRecipeListModal()"
                            class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-clipboard-list mr-2"></i> Daftar Resep
                        </button>
                        <button onclick="openRecipeModal()"
                            class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-plus-circle mr-2"></i> Buat Resep Baru
                        </button>
                        <button onclick="document.getElementById('recipe-import-input').click()"
                            class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-file-excel mr-2"></i> Import Resep (Excel)
                        </button>
                        <button onclick="openCraftingReportModal()"
                            class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95"><i
                                class="fas fa-chart-bar mr-2"></i> Lihat Laporan Produksi Terakhir</button>
                        <input type="file" id="recipe-import-input" accept=".xlsx, .xls" class="hidden"
                            onchange="importRecipeExcel(this)">

                        <!-- NEW CRAFTING HISTORY BUTTON -->
                        <button onclick="openCraftingHistory()"
                            class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-history mr-2"></i> Riwayat Produksi
                        </button>

                    </div>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <!-- RIGHT COLUMN: PRODUCTION PANEL -->
                    <div class="lg:col-span-12">
                        <div
                            class="glass-panel p-8 rounded-xl border-t-4 border-emerald-500 h-full flex flex-col relative overflow-hidden">
                            <div
                                class="absolute top-0 right-0 p-32 bg-emerald-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none">
                            </div>

                            <div class="text-center mb-6">
                                <i class="fas fa-industry text-6xl text-slate-700 mb-2"></i>
                                <h2 class="text-2xl font-bold text-white">Produksi Massal</h2>
                                <p class="text-xs text-slate-400">Tambahkan beberapa item ke antrean untuk dirakit
                                    sekaligus.</p>
                            </div>

                            <!-- Split Panel for Queue System -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10 flex-1 min-h-0">
                                <!-- INPUT SECTION -->
                                <div class="flex flex-col space-y-4">
                                    <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700 h-full">
                                        <h4
                                            class="text-sm font-bold text-emerald-400 mb-4 border-b border-slate-700 pb-2">
                                            1. Pilih Produk & Jumlah</h4>

                                        <div class="space-y-4">
                                            <div>
                                                <label
                                                    class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Produk</label>
                                                <select id="cr-select-product"
                                                    class="w-full bg-slate-900 border border-slate-600 rounded p-2.5 text-white font-bold outline-none focus:border-emerald-500 text-sm"></select>
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Jumlah
                                                    Unit</label>
                                                <input type="number" id="cr-qty" value="1" min="1"
                                                    class="w-full bg-slate-900 border border-slate-600 rounded p-2.5 text-white font-bold outline-none focus:border-emerald-500 text-sm text-center">
                                            </div>
                                            <button onclick="addToCraftQueue()"
                                                class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2.5 rounded-lg transition shadow-lg mt-2 flex items-center justify-center">
                                                <i class="fas fa-plus mr-2"></i> Tambahkan ke List
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- QUEUE & SUMMARY SECTION -->
                                <div class="flex flex-col h-full space-y-4">
                                    <!-- Queue List -->
                                    <div
                                        class="bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex-col min-h-0">
                                        <div
                                            class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                                            <h4 class="text-sm font-bold text-emerald-400">2. Antrean & Kebutuhan Per
                                                Item</h4>
                                            <button onclick="resetCraftQueue()"
                                                class="text-[10px] text-rose-400 hover:text-white hover:bg-rose-500 px-2 py-0.5 rounded transition">Reset</button>
                                        </div>
                                        <!-- List now accommodates detailed cards -->
                                        <div id="cr-queue-list" class="flex-1 space-y-2 mb-6">
                                            <div class="text-center text-slate-500 text-xs italic py-4">Antrean kosong.
                                            </div>
                                        </div>

                                        <!-- Resource Summary (Full, No Scroll) -->
                                        <div id="total-estimation-wrapper"
                                            class="bg-slate-900 p-4 rounded-lg border border-slate-800">
                                            <div class="flex justify-between items-center mb-3">
                                                <h4
                                                    class="text-[11px] font-bold text-slate-400 uppercase flex items-center gap-2">
                                                    <i class="fas fa-calculator"></i> Total Estimasi Bahan
                                                </h4>
                                                <button
                                                    onclick="takeElementScreenshot('total-estimation-wrapper', 'Estimasi_Total_Produksi')"
                                                    class="text-slate-400 hover:text-white bg-slate-700 hover:bg-slate-600 rounded px-2 py-1 transition"
                                                    title="Screenshot Total">
                                                    <i class="fas fa-camera text-xs"></i>
                                                </button>
                                            </div>
                                            <!-- Removed max-h classes to show full list -->
                                            <div id="cr-queue-summary" class="text-xs text-slate-400">
                                                <div class="text-center italic">Belum ada estimasi.</div>
                                            </div>
                                        </div>

                                        <button id="btn-process-queue" onclick="processCraftQueue()" disabled
                                            class="w-full bg-slate-700 text-slate-500 font-bold p-3 rounded cursor-not-allowed transition shadow-lg mt-4">
                                            ANTREAN KOSONG
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. GUN POS VIEW -->
            <section id="pos" class="page-section max-w-7xl mx-auto">
                <header class="mb-8 flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">Toko Senjata</h2>
                        <p class="text-slate-400">Penjualan produk jadi kepada pelanggan.</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="openSalesReportModal()"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition">
                            <i class="fas fa-file-invoice mr-2"></i> Lihat Transaksi Terakhir
                        </button>
                        <button onclick="openGroupManager()"
                            class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition">
                            <i class="fas fa-users mr-2"></i> Kelola Kelompok
                        </button>
                    </div>
                </header>
                <div class="glass-panel rounded-xl p-4 mb-6 border-l-4 border-blue-500">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-filter text-blue-400"></i>
                        <h4 class="text-sm font-bold text-slate-300 uppercase">Filter Kategori Senjata</h4>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterPosByClass('SEMUA')"
                            class="pos-filter-btn active-filter px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold transition border-2 border-transparent">
                            <i class="fas fa-th mr-1"></i> SEMUA
                        </button>
                        <button onclick="filterPosByClass('KELAS 1')"
                            class="pos-filter-btn px-4 py-2 rounded-lg bg-red-900/30 hover:bg-red-900/50 text-red-300 text-xs font-bold transition border-2 border-red-700/50">
                            KELAS 1
                        </button>
                        <button onclick="filterPosByClass('KELAS 2')"
                            class="pos-filter-btn px-4 py-2 rounded-lg bg-orange-900/30 hover:bg-orange-900/50 text-orange-300 text-xs font-bold transition border-2 border-orange-700/50">
                            KELAS 2
                        </button>
                        <button onclick="filterPosByClass('KELAS 3')"
                            class="pos-filter-btn px-4 py-2 rounded-lg bg-yellow-900/30 hover:bg-yellow-900/50 text-yellow-300 text-xs font-bold transition border-2 border-yellow-700/50">
                            KELAS 3
                        </button>
                        <button onclick="filterPosByClass('KELAS 4')"
                            class="pos-filter-btn px-4 py-2 rounded-lg bg-green-900/30 hover:bg-green-900/50 text-green-300 text-xs font-bold transition border-2 border-green-700/50">
                            KELAS 4
                        </button>
                        <button onclick="filterPosByClass('AKSESORIS')"
                            class="pos-filter-btn px-4 py-2 rounded-lg bg-purple-900/30 hover:bg-purple-900/50 text-purple-300 text-xs font-bold transition border-2 border-purple-700/50">
                            <i class="fas fa-puzzle-piece mr-1"></i> AKSESORIS
                        </button>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row gap-6 h-[calc(100vh-280px)]">
                    <div class="flex-1 glass-panel rounded-xl p-4 overflow-y-auto custom-scrollbar">
                        <div id="pos-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
                            <div class="col-span-full text-center text-slate-500 py-20">Belum ada stok barang jadi.
                                Lakukan Crafting dulu.</div>
                        </div>
                    </div>

                    <div class="w-full lg:w-96 glass-panel rounded-xl flex flex-col border-l-4 border-blue-500">
                        <div class="p-4 border-b border-slate-800 bg-slate-800/50">
                            <h3 class="font-bold text-white flex items-center"><i
                                    class="fas fa-shopping-cart mr-2"></i>Keranjang</h3>
                        </div>

                        <div id="pos-cart-items" class="flex-1 overflow-y-auto p-4 space-y-2">
                            <p class="text-center text-slate-500 text-sm mt-10">Keranjang kosong.</p>
                        </div>

                        <div class="p-4 bg-slate-800/80 mt-auto border-t border-slate-700">
                            <div class="mb-3">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Nama Seller (PIC)</label>
                                <input type="text" id="pos-pic" placeholder="Nama Anda"
                                    class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm text-white mt-1">
                            </div>
                            <div class="mb-3">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Kelompok Pembeli</label>
                                <select id="pos-group-select"
                                    class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm text-white mt-1">
                                    <option value="">-- Pilih Kelompok --</option>
                                </select>
                            </div>
                            <div class="flex justify-between items-end mb-4">
                                <span class="text-slate-400 text-sm">Total Tagihan:</span>
                                <span id="pos-total" class="text-2xl font-bold text-emerald-400">Rp 0</span>
                            </div>
                            <button id="btn-checkout" onclick="checkout()" disabled
                                class="w-full bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:text-slate-500 text-white font-bold py-3 rounded-lg shadow-lg transition">
                                PROSES TRANSAKSI
                            </button>
                        </div>
                    </div>
                </div>
                <!-- NEW: SALES HISTORY SECTION -->
                <div class="mt-8 glass-panel rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-white flex items-center">
                            <i class="fas fa-history mr-2 text-blue-400"></i>Riwayat Transaksi Penjualan
                        </h3>
                        <button onclick="renderSalesHistory()"
    class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-2 rounded-lg transition flex items-center">
    <i class="fas fa-sync-alt mr-2"></i> Refresh
</button>
                    </div>

                    <div id="sales-history-container" class="max-h-[600px] overflow-y-auto custom-scrollbar">
                        <div class="text-center text-slate-500 py-10 italic">Memuat riwayat...</div>
                    </div>
                </div>
            </section>

            <!-- 4. HISTORY VIEW -->
            <section id="history" class="page-section max-w-6xl mx-auto">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Jejak Aktivitas Global</h2>
                    <p class="text-slate-400">Log transaksi Gudang, Produksi, dan Penjualan.</p>
                </header>

                <div class="glass-panel rounded-xl overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-800 text-slate-400 text-xs uppercase font-bold">
                            <tr>
                                <th class="p-4">Waktu</th>
                                <th class="p-4">Tipe</th>
                                <th class="p-4">Aktivitas</th>
                                <th class="p-4 text-right">Nilai (Rp)</th>
                                <th class="p-4">PIC</th>
                                <th class="p-4 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="hist-table-body"></tbody>
                    </table>
                </div>
            </section>
            <!-- 5. WEAPON DATABASE VIEW -->
            <section id="weapon-db" class="page-section max-w-7xl mx-auto">
                <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">Database Senjata</h2>
                        <p class="text-slate-400">Kelola master data senjata: nama, kelas, harga modal & jual.</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="openAddWeaponModal()"
                            class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition">
                            <i class="fas fa-plus-circle mr-2"></i> Tambah Manual
                        </button>
                        <button onclick="openProductClassManager()"
                            class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition">
                            <i class="fas fa-layer-group mr-2"></i> Kelola Kelas
                        </button>
                        <button onclick="syncWeaponToProducts()"
                            class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition">
                            <i class="fas fa-sync mr-2"></i> Sync ke POS
                        </button>
                        <button onclick="document.getElementById('weapon-db-import').click()"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition">
                            <i class="fas fa-file-excel mr-2"></i> Import Excel
                        </button>
                        <input type="file" id="weapon-db-import" accept=".xlsx, .xls" class="hidden"
                            onchange="importWeaponDatabase(this)">
                    </div>
                </header>

                <!-- Filter & Search -->
                <div class="glass-panel p-4 rounded-xl mb-6 flex flex-col md:flex-row gap-3">
                    <div class="flex-1 relative">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-500 text-xs"></i>
                        <input type="text" id="weapon-db-search" onkeyup="renderWeaponDatabase()"
                            placeholder="Cari nama senjata..."
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-9 p-2.5 text-sm text-white focus:border-blue-500 outline-none">
                    </div>
                    <div class="w-full md:w-64">
                        <select id="weapon-db-filter-class" onchange="renderWeaponDatabase()"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white focus:border-blue-500 outline-none">
                            <option value="SEMUA"> Semua Kelas</option>
                            <option value="KELAS 1"> Kelas 1</option>
                            <option value="KELAS 2"> Kelas 2</option>
                            <option value="KELAS 3"> Kelas 3</option>
                            <option value="KELAS 4"> Kelas 4</option>
                            <option value="AKSESORIS"> Aksesoris</option>
                        </select>
                    </div>
                </div>

                <!-- Table -->
                <div class="glass-panel p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-white">Data Senjata</h3>
                        <button onclick="deleteAllWeaponDatabase()"
                            class="text-xs bg-rose-600/20 text-rose-400 hover:bg-rose-600 hover:text-white px-3 py-1.5 rounded-lg border border-rose-600/30 transition flex items-center">
                            <i class="fas fa-trash-alt mr-2"></i> Hapus Semua
                        </button>
                    </div>

                    <div class="overflow-x-auto border border-slate-700 rounded-lg">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-800 text-xs text-slate-400 uppercase font-bold">
                                <tr>
                                    <th class="p-3">Nama Senjata</th>
                                    <th class="p-3 text-center">Kelas</th>
                                    <th class="p-3 text-right">Harga Modal</th>
                                    <th class="p-3 text-right">Harga Jual</th>
                                    <th class="p-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="weapon-db-table-body">
                                <tr>
                                    <td colspan="6" class="p-8 text-center text-slate-500 italic">Memuat data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Info Panel -->
                <div class="mt-6 glass-panel p-4 rounded-xl border-l-4 border-cyan-500">
                    <h4 class="text-sm font-bold text-cyan-400 mb-2 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i> Integrasi Harga Otomatis
                    </h4>
                    <div class="text-xs text-slate-400 space-y-2">
                        <p> <b>Harga Modal Otomatis:</b></p>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>Harga modal dihitung otomatis dari <b>Resep Produksi</b>  <b>Harga Bahan</b></li>
                            <li>Data terintegrasi dengan modul Gudang Bahan dan POS</li>
                            <li>Perubahan harga bahan akan otomatis update perhitungan</li>
                            <li>Item dengan harga auto-calculated ditandai <span class="text-blue-400"><i
                                        class="fas fa-calculator"></i></span></li>
                        </ul>

                        <p class="mt-3"> <b>Format Excel untuk Import (Opsional):</b></p>
                        <ul class="list-disc list-inside ml-4 space-y-0.5">
                            <li><b>Nama Senjata</b> / Name / Nama</li>
                            <li><b>Kelas</b> / Class / Kategori</li>
                            <li><b>Harga Jual</b> / Selling Price / Jual</li>
                            <li><i>Harga Modal diabaikan (auto-calculated)</i></li>
                        </ul>
                    </div>
                </div>
            </section>
            <!-- 6. INVENTORY VIEW (NEW) -->
            <section id="inventory" class="page-section max-w-7xl mx-auto">
                <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">Inventori Senjata</h2>
                        <p class="text-slate-400">Kelola stok produk jadi yang siap dijual.</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="downloadInventoryReport()"
                            class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition">
                            <i class="fas fa-file-download mr-2"></i> Laporan Stok
                        </button>
                    </div>
                </header>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="glass-panel p-4 rounded-lg border-l-4 border-blue-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-slate-500 text-xs uppercase font-bold">Total Jenis</p>
                                <p id="inv-total-types" class="text-2xl font-bold text-white">0</p>
                            </div>
                            <i class="fas fa-layer-group text-3xl text-blue-500/30"></i>
                        </div>
                    </div>
                    <div class="glass-panel p-4 rounded-lg border-l-4 border-emerald-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-slate-500 text-xs uppercase font-bold">Total Unit</p>
                                <p id="inv-total-stock" class="text-2xl font-bold text-white">0</p>
                            </div>
                            <i class="fas fa-boxes text-3xl text-emerald-500/30"></i>
                        </div>
                    </div>
                    <div class="glass-panel p-4 rounded-lg border-l-4 border-yellow-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-slate-500 text-xs uppercase font-bold">Nilai Modal</p>
                                <p id="inv-total-cost" class="text-lg font-bold text-white">Rp 0</p>
                            </div>
                            <i class="fas fa-coins text-3xl text-yellow-500/30"></i>
                        </div>
                    </div>
                    <div class="glass-panel p-4 rounded-lg border-l-4 border-purple-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-slate-500 text-xs uppercase font-bold">Potensi Jual</p>
                                <p id="inv-total-potential" class="text-lg font-bold text-white">Rp 0</p>
                            </div>
                            <i class="fas fa-chart-line text-3xl text-purple-500/30"></i>
                        </div>
                    </div>
                </div>

                <!-- Filter & Search -->
                <div class="glass-panel p-4 rounded-xl mb-6 flex flex-col md:flex-row gap-3">
                    <div class="flex-1 relative">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-500 text-xs"></i>
                        <input type="text" id="inventory-search" onkeyup="renderInventoryTable()"
                            placeholder="Cari nama senjata..."
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-9 p-2.5 text-sm text-white focus:border-blue-500 outline-none">
                    </div>
                    <div class="w-full md:w-64">
                        <select id="inventory-filter-class" onchange="renderInventoryTable()"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white focus:border-blue-500 outline-none">
                            <option value="SEMUA"> Semua Kelas</option>
                            <option value="KELAS 1"> Kelas 1</option>
                            <option value="KELAS 2"> Kelas 2</option>
                            <option value="KELAS 3"> Kelas 3</option>
                            <option value="KELAS 4"> Kelas 4</option>
                            <option value="AKSESORIS"> Aksesoris</option>
                        </select>
                    </div>
                    <div class="w-full md:w-48">
                        <select id="inventory-filter-stock" onchange="renderInventoryTable()"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm text-white focus:border-blue-500 outline-none">
                            <option value="SEMUA"> Semua Stok</option>
                            <option value="READY"> Tersedia (>0)</option>
                            <option value="EMPTY"> Habis (=0)</option>
                            <option value="LOW"> Sedikit (<5)</option> </select> </div> </div> <!-- Table -->
                                    <div class="glass-panel p-6 rounded-xl">
                                        <div class="overflow-x-auto border border-slate-700 rounded-lg">
                                            <table class="w-full text-left text-sm">
                                                <thead
                                                    class="bg-slate-800 text-xs text-slate-400 uppercase font-bold sticky top-0 z-10">
                                                    <tr>
                                                        <th class="p-3">Nama Senjata</th>
                                                        <th class="p-3 text-center">Kelas</th>
                                                        <th class="p-3 text-right">Stok</th>
                                                        <th class="p-3 text-right">Harga Modal</th>
                                                        <th class="p-3 text-right">Harga Jual</th>
                                                        <th class="p-3 text-right">Profit/Unit</th>
                                                        <th class="p-3 text-right">Nilai Total</th>
                                                        <th class="p-3 text-center">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="inventory-table-body">
                                                    <tr>
                                                        <td colspan="8" class="p-8 text-center text-slate-500 italic">
                                                            Memuat data...</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Info Panel -->
                                    <div class="mt-6 glass-panel p-4 rounded-xl border-l-4 border-rose-500">
                                        <h4 class="text-sm font-bold text-rose-400 mb-2 flex items-center">
                                            <i class="fas fa-exclamation-triangle mr-2"></i> Peringatan
                                        </h4>
                                        <p class="text-xs text-slate-400">
                                            <b>Menghapus produk dari Inventori Senjata:</b>
                                        </p>
                                        <ul class="list-disc list-inside ml-4 text-xs text-slate-400 mt-2 space-y-1">
                                            <li>Akan menghapus produk secara permanen dari sistem</li>
                                            <li>Produk akan hilang dari <b>Toko Senjata (POS)</b></li>
                                            <li>Resep produksi tetap tersimpan dan bisa diproduksi ulang</li>
                                            <li>Riwayat transaksi penjualan tetap tersimpan</li>
                                        </ul>
                                    </div>
            </section>
        </div>
    </main>

    <!-- NEW UNIVERSAL MODAL -->
    <div id="universal-modal"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-100">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4">Action</h3>
            <p id="modal-desc" class="text-slate-400 text-sm mb-4 hidden"></p>

            <div id="modal-inputs" class="space-y-3">
                <div id="input-group-name" class="hidden">
                    <label class="text-[10px] uppercase font-bold text-slate-500">Nama Baru</label>
                    <input type="text" id="modal-input-name"
                        class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white outline-none focus:border-blue-500">
                </div>
                <div id="input-group-qty">
                    <label id="label-qty" class="text-[10px] uppercase font-bold text-slate-500">Jumlah</label>
                    <input type="number" id="modal-input-qty"
                        class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white outline-none focus:border-blue-500">
                </div>
                <div id="input-group-pic" class="hidden">
                    <label class="text-[10px] uppercase font-bold text-slate-500">PIC (Penanggung Jawab)</label>
                    <input type="text" id="modal-input-pic"
                        class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white outline-none focus:border-blue-500">
                </div>
                <div id="input-group-pic" class="hidden">
                    <!-- Duplicate ID removed in logic, simplified -->
                    <label class="text-[10px] uppercase font-bold text-slate-500">Keterangan</label>
                    <input type="text" id="modal-input-note"
                        class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white outline-none focus:border-blue-500">
                </div>
                <div id="input-group-img" class="hidden">
                    <label class="text-[10px] uppercase font-bold text-slate-500">Bukti Foto</label>
                    <input type="file" id="modal-input-img" accept="image/*"
                        class="w-full text-xs text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-slate-700 file:text-slate-300 hover:file:bg-slate-600">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeModal()"
                    class="flex-1 py-2 bg-slate-700 text-slate-300 rounded hover:bg-slate-600 font-medium transition">Batal</button>
                <button id="btn-modal-confirm" onclick="confirmModalAction()"
                    class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 font-bold transition shadow-lg">Simpan</button>
            </div>
        </div>
    </div>

    <!-- NEW RECIPE CREATION MODAL -->
    <div id="recipeModal"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-purple-500/50 rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100 modal-scale relative">
            <button onclick="closeRecipeModal()"
                class="absolute top-4 right-4 text-slate-400 hover:text-white transition"><i
                    class="fas fa-times"></i></button>

            <h3 id="recipeModalTitle" class="text-xl font-bold text-purple-400 mb-6 flex items-center"><i
                    class="fas fa-scroll mr-3"></i>Buat Resep Baru</h3>

            <form id="cr-form" onsubmit="saveRecipe(event)" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Produk</label>
                    <input type="text" id="cr-name" placeholder="CONTOH: AK-47"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white font-bold uppercase outline-none focus:border-purple-500 transition">
                </div>

                <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-3 flex justify-between">
                        <span>Komposisi Bahan</span>
                        <span class="text-slate-600 italic">(Isi jumlah yang dibutuhkan)</span>
                    </p>
                    <div id="cr-inputs" class="grid grid-cols-2 gap-3 max-h-60 overflow-y-auto custom-scrollbar pr-1">
                        <!-- Inputs injected via JS -->
                    </div>
                </div>

                <button
                    class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-purple-900/20">
                    SIMPAN RESEP
                </button>
            </form>
        </div>
    </div>

    <!-- NEW RECIPE LIST MODAL -->
    <div id="recipeListModal"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-purple-500/50 rounded-xl shadow-2xl w-full max-w-2xl h-[80vh] p-6 transform transition-all scale-100 modal-scale flex flex-col relative">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-purple-400 flex items-center">
                    <i class="fas fa-clipboard-list mr-3"></i>Daftar Resep Aktif
                </h3>
                <div class="flex items-center gap-2">
                    <button onclick="downloadRecipeScreenshot()"
                        class="w-8 h-8 rounded bg-slate-700 hover:bg-slate-600 text-slate-300 flex items-center justify-center transition border border-slate-600"
                        title="Ambil Screenshot Resep" id="btn-recipe-screenshot">
                        <i class="fas fa-camera text-xs"></i>
                    </button>
                    <button onclick="closeRecipeListModal()" class="text-slate-400 hover:text-white transition"><i
                            class="fas fa-times text-xl"></i></button>
                </div>
            </div>

            <div id="recipeListModalContent"
                class="flex-1 overflow-y-auto custom-scrollbar pr-2 grid grid-cols-1 md:grid-cols-2 gap-4 auto-rows-min">
                <!-- Cards injected via JS -->
            </div>
        </div>
    </div>

    <!-- NEW CRAFTING HISTORY MODAL -->
    <div id="craftingHistoryModal"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-cyan-500/50 rounded-xl shadow-2xl w-full max-w-2xl h-[85vh] p-6 transform transition-all scale-100 modal-scale flex flex-col relative">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-cyan-400 flex items-center">
                    <i class="fas fa-history mr-3"></i>Riwayat Produksi
                </h3>
                <button onclick="closeCraftingHistory()" class="text-slate-400 hover:text-white transition"><i
                        class="fas fa-times text-xl"></i></button>
            </div>

            <div id="craftingHistoryContent" class="flex-1 overflow-y-auto custom-scrollbar pr-2">
                <div class="text-center text-slate-500 text-sm py-10 italic">Memuat riwayat...</div>
            </div>
        </div>
    </div>

    <!-- NEW TRANSACTION DETAIL MODAL -->
    <div id="transactionDetailModal"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-slate-600 rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 modal-scale flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-3">
                <h3 id="td-title" class="text-lg font-bold text-white">Detail Transaksi</h3>
                <button onclick="closeTransactionDetailModal()" class="text-slate-400 hover:text-white transition"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div id="td-content" class="flex-1 overflow-y-auto custom-scrollbar"></div>
        </div>
    </div>

    <!-- NEW PRICE LIST MODAL -->
    <div id="priceModal"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-yellow-500/50 rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 modal-scale relative flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-yellow-500 flex items-center">
                    <i class="fas fa-tags mr-3"></i>Harga Modal Bahan
                </h3>
                <button onclick="closePriceModal()" class="text-slate-400 hover:text-white transition"><i
                        class="fas fa-times text-xl"></i></button>
            </div>

            <div class="flex gap-2 mb-4">
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-3 top-2.5 text-slate-500 text-xs"></i>
                    <input type="text" id="price-search" onkeyup="renderPriceListTable()" placeholder="Cari bahan..."
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-9 p-2 text-sm text-white focus:border-yellow-500 outline-none">
                </div>
                <button onclick="document.getElementById('price-import-input').click()"
                    class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-lg font-bold text-xs shadow flex items-center">
                    <i class="fas fa-file-upload mr-2"></i> Import Excel
                </button>
                <input type="file" id="price-import-input" accept=".xlsx, .xls" class="hidden"
                    onchange="importPriceExcel(this)">
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar border border-slate-700 rounded-lg bg-slate-800/30">
                <table class="w-full text-left">
                    <thead class="bg-slate-800 text-xs text-slate-400 uppercase font-bold sticky top-0 z-10">
                        <tr>
                            <th class="p-3">Nama Bahan</th>
                            <th class="p-3 text-right">Harga Modal</th>
                            <th class="p-3 text-right">Stok Gudang</th>
                            <th class="p-3 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="price-table-body" class="divide-y divide-slate-700/50">
                        <!-- Content Injected via JS -->
                    </tbody>
                </table>
            </div>

            <div class="mt-4 pt-3 border-t border-slate-800 text-center">
                <p class="text-[10px] text-slate-500 italic">Format Excel: Kolom "Nama Bahan" & "Harga Modal"</p>
            </div>
        </div>
    </div>

    <!-- NEW EDIT PRICE MODAL -->
    <div id="editPriceModal"
        class="fixed inset-0 z-[60] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100 modal-scale">
            <h3 class="text-lg font-bold text-white mb-4">Edit Harga Bahan</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Nama Bahan</label>
                    <input type="text" id="edit-price-name"
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-2.5 text-slate-400 text-sm font-bold"
                        readonly>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Harga Modal Baru (Rp)</label>
                    <input type="number" id="edit-price-value"
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-yellow-500 outline-none font-mono">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditPriceModal()"
                    class="flex-1 py-2 bg-slate-700 text-slate-300 rounded hover:bg-slate-600 font-medium transition">Batal</button>
                <button onclick="savePriceUpdate()"
                    class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 font-bold transition shadow-lg">Simpan</button>
            </div>
        </div>
    </div>

    <!-- NEW PRODUCT CLASS MANAGER MODAL -->
    <div id="productClassModal"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-purple-500/50 rounded-xl shadow-2xl w-full max-w-3xl p-6 transform transition-all scale-100 modal-scale flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-purple-400 flex items-center">
                    <i class="fas fa-layer-group mr-3"></i>Kelola Kelas Produk
                </h3>
                <button onclick="closeProductClassModal()" class="text-slate-400 hover:text-white transition"><i
                        class="fas fa-times text-xl"></i></button>
            </div>

            <!-- Search Bar -->
            <div class="mb-4">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-3 text-slate-500 text-xs"></i>
                    <input type="text" id="product-class-search" onkeyup="renderProductClassTable()"
                        placeholder="Cari produk..."
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-9 p-2 text-sm text-white focus:border-purple-500 outline-none">
                </div>
            </div>

            <!-- Legend -->
            <div class="mb-4 bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                <p class="text-[10px] font-bold text-slate-500 uppercase mb-2">Legenda Kelas:</p>
                <div class="flex flex-wrap gap-2">
                    <span
                        class="text-[9px] bg-red-900/50 text-red-300 border border-red-700 px-2 py-0.5 rounded font-bold">KELAS
                        1 - Militer Berat</span>
                    <span
                        class="text-[9px] bg-orange-900/50 text-orange-300 border border-orange-700 px-2 py-0.5 rounded font-bold">KELAS
                        2 - Militer Menengah</span>
                    <span
                        class="text-[9px] bg-yellow-900/50 text-yellow-300 border border-yellow-700 px-2 py-0.5 rounded font-bold">KELAS
                        3 - Sipil Berat</span>
                    <span
                        class="text-[9px] bg-green-900/50 text-green-300 border border-green-700 px-2 py-0.5 rounded font-bold">KELAS
                        4 - Sipil Standar</span>
                    <span
                        class="text-[9px] bg-purple-900/50 text-purple-300 border border-purple-700 px-2 py-0.5 rounded font-bold">AKSESORIS
                        - Tambahan</span>
                </div>
            </div>

            <!-- Product Table -->
            <div class="flex-1 overflow-y-auto custom-scrollbar border border-slate-700 rounded-lg bg-slate-800/30">
                <table class="w-full text-left">
                    <thead class="bg-slate-800 text-xs text-slate-400 uppercase font-bold sticky top-0 z-10">
                        <tr>
                            <th class="p-3">Nama Produk</th>
                            <th class="p-3 text-center">Kelas Saat Ini</th>
                            <th class="p-3 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="product-class-table-body" class="divide-y divide-slate-700/50">
                        <tr>
                            <td colspan="3" class="p-4 text-center text-slate-500 italic">Memuat data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 pt-3 border-t border-slate-800">
                <p class="text-[10px] text-slate-500 italic text-center">
                     Perubahan kelas akan otomatis tersinkron ke Toko Senjata (POS) dan Inventori
                </p>
            </div>
        </div>
    </div>

    <!-- EDIT PRODUCT CLASS MODAL -->
    <div id="editProductClassModal"
        class="fixed inset-0 z-[60] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100 modal-scale">
            <h3 class="text-lg font-bold text-white mb-4">Ubah Kelas Produk</h3>
            <div class="space-y-4">
                <input type="hidden" id="edit-class-product-id">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Nama Produk</label>
                    <div id="edit-class-product-name"
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-2.5 text-slate-200 text-sm font-bold">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Pilih Kelas Baru</label>
                    <select id="edit-class-select"
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-purple-500 outline-none font-bold">
                        <option value="">-- Pilih Kelas --</option>
                        <option value="KELAS 1"> KELAS 1 - Militer Berat</option>
                        <option value="KELAS 2"> KELAS 2 - Militer Menengah</option>
                        <option value="KELAS 3"> KELAS 3 - Sipil Berat</option>
                        <option value="KELAS 4"> KELAS 4 - Sipil Standar</option>
                        <option value="AKSESORIS"> AKSESORIS - Tambahan</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditProductClassModal()"
                    class="flex-1 py-2 bg-slate-700 text-slate-300 rounded hover:bg-slate-600 font-medium transition">Batal</button>
                <button onclick="saveProductClass()"
                    class="flex-1 py-2 bg-purple-600 text-white rounded hover:bg-purple-500 font-bold transition shadow-lg">
                    <i class="fas fa-save mr-2"></i> Simpan
                </button>
            </div>
        </div>
    </div>
    <!-- ADD/EDIT WEAPON MODAL -->
    <div id="addWeaponModal"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100 modal-scale">
            <h3 id="weapon-modal-title" class="text-lg font-bold text-white mb-4">Tambah Senjata Baru</h3>
            <form id="weapon-form" onsubmit="saveWeaponData(event)" class="space-y-4">
                <input type="hidden" id="weapon-id-input">

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Nama Senjata</label>
                    <input type="text" id="weapon-name" required
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-blue-500 outline-none uppercase font-bold">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Kelas Senjata</label>
                    <select id="weapon-class" required
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-blue-500 outline-none font-bold">
                        <option value="">-- Pilih Kelas --</option>
                        <option value="KELAS 1"> KELAS 1 - Militer Berat</option>
                        <option value="KELAS 2"> KELAS 2 - Militer Menengah</option>
                        <option value="KELAS 3"> KELAS 3 - Sipil Berat</option>
                        <option value="KELAS 4"> KELAS 4 - Sipil Standar</option>
                        <option value="AKSESORIS"> AKSESORIS - Tambahan</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Harga Modal (Rp)</label>
                        <input type="number" id="weapon-cost" min="0"
                            class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-yellow-500 outline-none font-mono">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Harga Jual (Rp)</label>
                        <input type="number" id="weapon-sell" min="0"
                            class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-emerald-500 outline-none font-mono">
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeAddWeaponModal()"
                        class="flex-1 py-2 bg-slate-700 text-slate-300 rounded hover:bg-slate-600 font-medium transition">Batal</button>
                    <button type="submit"
                        class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 font-bold transition shadow-lg">
                        <i class="fas fa-save mr-2"></i> Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- BULK UPDATE MODAL REFINED -->
    <div id="bulkUpdateModal"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 m-auto modal-scale flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800"><i
                        class="fas fa-layer-group mr-2 text-indigo-600"></i>Update Stok Massal</h3>
                <button onclick="document.getElementById('bulkUpdateModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>

            <!-- Global Settings for Batch -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 bg-gray-50 p-4 rounded-lg border border-gray-100">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">PIC (Penanggung Jawab)</label>
                    <input type="text" id="bulkPIC" class="w-full px-3 py-2 border rounded-lg text-sm text-slate-800"
                        placeholder="Nama PIC">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">Keterangan / Catatan Batch</label>
                    <input type="text" id="bulkDesc" class="w-full px-3 py-2 border rounded-lg text-sm text-slate-800"
                        placeholder="Contoh: Opname Akhir Tahun">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-gray-600 mb-1">Bukti Foto (Opsional - Berlaku untuk
                        semua)</label>
                    <input type="file" id="bulkImage" onchange="handleFileSelect(this)" accept="image/*"
                        class="text-xs w-full file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 text-slate-600">
                    <div id="file-status-indicator"
                        class="hidden mt-1 text-xs text-green-600 font-bold flex items-center">
                        <i class="fas fa-check-circle mr-1"></i> File dipilih: <span id="file-name-display"
                            class="font-normal text-slate-600 ml-1"></span>
                    </div>
                </div>
            </div>

            <!-- Search Bar for Bulk Items (NEW) -->
            <div class="mb-3">
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </span>
                    <input type="text" id="bulkSearchInput" onkeyup="filterBulkItems()"
                        placeholder="Cari nama resource..."
                        class="w-full pl-10 pr-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition placeholder-gray-400 text-slate-800">
                </div>
            </div>

            <!-- Item List -->
            <div class="flex-1 overflow-y-auto border rounded-lg mb-4 bg-white shadow-inner">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-3 text-xs font-bold text-gray-600">Nama Resource</th>
                            <th class="p-3 text-xs font-bold text-gray-600 text-center w-20">Stok</th>
                            <th class="p-3 text-xs font-bold text-gray-600 w-32">Aksi</th>
                            <th class="p-3 text-xs font-bold text-gray-600 w-28">Jumlah</th>
                        </tr>
                    </thead>
                    <tbody id="bulkItemsBody">
                        <!-- JS Injected -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-between items-center pt-2 border-t">
                <div class="text-xs text-gray-500 italic">* Kosongkan jumlah jika item tidak diupdate.</div>
                <div class="flex space-x-3">
                    <button onclick="document.getElementById('bulkUpdateModal').classList.add('hidden')"
                        class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-50 text-sm font-medium">Batal</button>
                    <button id="btnBulkConfirm" onclick="handleBulkSubmit()"
                        class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-indigo-700 text-sm transition">Proses
                        Semua</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CUSTOM CARD ALERT (REPLACEMENT FOR DEFAULT ALERTS) -->
    <div id="custom-alert-modal"
        class="fixed inset-0 z-[120] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl max-w-sm w-full p-8 transform transition-all scale-100 modal-scale">
            <div class="text-center">
                <div id="alert-icon-wrapper"
                    class="w-16 h-16 rounded-full flex items-center justify-center mb-4 transition-colors mx-auto">
                    <i id="alert-icon" class="text-3xl"></i>
                </div>
                <h3 id="alert-title" class="text-xl font-bold text-white mb-2 tracking-wide"></h3>
                <p id="alert-message" class="text-slate-400 text-sm mb-8 leading-relaxed"></p>
                <div id="alert-actions" class="flex gap-3 justify-center">
                    <!-- Buttons injected via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- IMAGE PREVIEW MODAL -->
    <div id="image-preview-modal"
        class="fixed inset-0 z-[60] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4"
        onclick="closeImagePreview()">
        <img id="preview-img-content" class="max-w-full max-h-screen rounded shadow-2xl" src="">
        <p class="absolute bottom-5 text-white/50 text-sm">Klik di mana saja untuk menutup</p>
    </div>

    <!-- MODAL PREVIEW REPORT (STRUK) -->
    <div id="reportModal"
        class="fixed inset-0 bg-black/80 hidden flex flex-col items-center justify-center z-[90] p-4 backdrop-blur-sm">
        <div class="flex justify-between items-center w-full max-w-[450px] mb-4">
            <h3 class="text-white font-bold text-lg">Preview Report</h3>
            <div class="flex space-x-2">
                <button id="btnDownloadReport"
                    class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold shadow transition flex items-center text-sm">
                    <i class="fas fa-download mr-2"></i> Simpan
                </button>
                <button onclick="closeReportModal()"
                    class="bg-white hover:bg-slate-200 text-slate-800 px-4 py-2 rounded-lg font-bold shadow transition text-sm">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Container Struk -->
        <div id="reportPreviewContainer" class="overflow-auto max-h-[80vh] rounded shadow-2xl bg-white p-1 modal-scale">
            <!-- Struk akan di-inject ke sini -->
        </div>
    </div>

    <!-- Template Report (Hidden Source) -->
    <div id="receiptTemplate" class="hidden bg-white text-slate-800 font-sans shadow-none"
        style="width: 500px; padding: 0;">
        <div class="bg-slate-900 text-white p-6 rounded-t-lg">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold tracking-wide">VK WAREHOUSE</h2>
                    <p class="text-blue-200 text-xs mt-1 tracking-wider">OFFICIAL TRANSACTION DOCUMENT</p>
                </div>
                <div class="text-right">
                    <span id="recType"
                        class="inline-block px-3 py-1 bg-white text-blue-800 rounded font-bold text-xs shadow">TYPE</span>
                </div>
            </div>
        </div>

        <div class="p-6 border-x border-b border-gray-200 rounded-b-lg bg-white">
            <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                <div>
                    <p class="text-gray-400 text-xs uppercase mb-1">Transaction ID</p>
                    <p id="recID" class="font-mono font-bold text-gray-700">#ID</p>
                </div>
                <div class="text-right">
                    <p class="text-gray-400 text-xs uppercase mb-1">Date</p>
                    <p id="recDate" class="font-bold text-gray-700">-</p>
                </div>
                <div>
                    <p class="text-gray-400 text-xs uppercase mb-1">PIC (Person In Charge)</p>
                    <p id="recPIC" class="font-bold text-gray-700 uppercase">-</p>
                </div>
            </div>

            <hr class="border-gray-100 my-4">

            <div class="mb-6">
                <p class="text-gray-400 text-xs uppercase mb-2">Transaction Details</p>

                <!-- Single Item View -->
                <div id="recSingleContainer"
                    class="flex justify-between items-center bg-gray-50 p-4 rounded-lg border border-gray-100">
                    <div class="w-full">
                        <span class="block text-lg font-bold text-gray-800" id="recItem">Item Name</span>
                        <div class="text-xs text-gray-500 mt-1 space-x-2 flex items-center">
                            <span class="bg-white border px-1 rounded">Awal: <b id="recBefore">0</b></span>
                            <i class="fas fa-arrow-right text-gray-300"></i>
                            <span class="bg-white border px-1 rounded">Akhir: <b id="recAfter">0</b></span>
                        </div>
                    </div>
                    <div class="text-center ml-4 min-w-[80px]">
                        <span class="block text-xs text-gray-400 mb-1">Quantity</span>
                        <span class="block text-2xl font-bold" id="recAmount">0</span>
                        <span class="block text-[10px] font-bold uppercase mt-1 px-2 py-0.5 rounded text-white"
                            id="recBadge">TYPE</span>
                    </div>
                </div>

                <!-- Batch Item View (New Table) -->
                <div id="recBatchContainer" class="hidden bg-gray-50 rounded-lg border border-gray-100 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 text-xs text-gray-500 uppercase">
                            <tr>
                                <th class="py-2 px-3 text-left">Item Name & Stock</th>
                                <th class="py-2 px-3 text-right">Change</th>
                            </tr>
                        </thead>
                        <tbody id="recBatchBody" class="divide-y divide-gray-200">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mb-6">
                <p class="text-gray-400 text-xs uppercase mb-1">Description / Notes</p>
                <p id="recDesc"
                    class="text-sm text-gray-600 italic border-l-2 border-gray-300 pl-3 py-1 whitespace-pre-line">No
                    description.</p>
            </div>

            <div id="receiptImgCont" class="hidden mt-4">
                <p class="text-gray-400 text-xs uppercase mb-2">Attached Proof</p>
                <div
                    class="w-full rounded-lg overflow-hidden border border-gray-200 bg-gray-100 flex justify-center p-2">
                    <img id="receiptImg" class="max-h-64 object-contain rounded" style="display: block;">
                </div>
            </div>

            <div class="mt-8 pt-4 border-t border-gray-100 flex justify-between items-end text-[10px] text-gray-400">
                <span>Generated by VK Warehouse App</span>
                <span>*** VALID PROOF ***</span>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast"
        class="fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-xl text-white font-bold transition transform duration-300 translate-y-20 opacity-0 pointer-events-none z-[110]">
    </div>
    <!-- GROUP MANAGER MODAL -->
    <div id="groupManagerModal"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-purple-500/50 rounded-xl shadow-2xl w-full max-w-5xl p-6 transform transition-all scale-100 modal-scale flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-purple-400 flex items-center">
                    <i class="fas fa-users mr-3"></i>Manajemen Kelompok & Limit
                </h3>
                <div class="flex gap-2">
                    <button onclick="renderGroupTable()"
                        class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg font-bold text-sm shadow flex items-center transition"
                        title="Refresh Data">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button onclick="openAddGroupModal()"
                        class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition">
                        <i class="fas fa-plus-circle mr-2"></i> Tambah Kelompok
                    </button>
                    <button onclick="closeGroupManager()" class="text-slate-400 hover:text-white transition"><i
                            class="fas fa-times text-xl"></i></button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar border border-slate-700 rounded-lg bg-slate-800/30">
                <table class="w-full text-left">
                    <thead class="bg-slate-800 text-xs text-slate-400 uppercase font-bold sticky top-0 z-10">
                        <tr>
                            <th class="p-3">Nama Kelompok</th>
                            <th class="p-3">Mulai</th>
                            <th class="p-3">Selesai</th>
                            <th class="p-3 text-center">Kelas 1<br><span
                                    class="text-[9px] normal-case text-slate-600">(Sisa/Total)</span></th>
                            <th class="p-3 text-center">Kelas 2<br><span
                                    class="text-[9px] normal-case text-slate-600">(Sisa/Total)</span></th>
                            <th class="p-3 text-center">Kelas 3<br><span
                                    class="text-[9px] normal-case text-slate-600">(Sisa/Total)</span></th>
                            <th class="p-3 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="group-table-body">
                        <tr>
                            <td colspan="7" class="p-8 text-center text-slate-500 italic">Memuat data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-4 pt-3 border-t border-slate-800 text-center">
                <p class="text-[10px] text-slate-500 italic"> Limit dihitung per minggu sesuai periode yang ditentukan
                </p>
            </div>
        </div>
    </div>

    <!-- ADD/EDIT GROUP MODAL -->
    <div id="addGroupModal"
        class="fixed inset-0 z-[60] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-2xl p-6 transform transition-all scale-100 modal-scale">
            <h3 id="group-modal-title" class="text-lg font-bold text-white mb-4">Tambah Kelompok Baru</h3>
            <form id="group-form" onsubmit="saveGroupData(event)" class="space-y-4">
                <input type="hidden" id="group-id-input">

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Nama Kelompok</label>
                    <input type="text" id="group-name" required
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-purple-500 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">
                            <i class="fas fa-calendar-alt mr-1 text-purple-400"></i> Tanggal Mulai (Periode Limit)
                        </label>
                        <div class="date-input-wrapper">
                            <input type="text" id="group-week-start" placeholder="Pilih tanggal mulai..." required
                                class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-purple-500 outline-none"
                                readonly>
                            <i class="fas fa-calendar-day date-input-icon"></i>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">
                            <i class="fas fa-calendar-alt mr-1 text-purple-400"></i> Tanggal Selesai
                        </label>
                        <div class="date-input-wrapper">
                            <input type="text" id="group-week-end" placeholder="Pilih tanggal selesai..." required
                                class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-purple-500 outline-none"
                                readonly>
                            <i class="fas fa-calendar-check date-input-icon"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                    <p class="text-xs font-bold text-slate-400 mb-3 uppercase">Limit Per Kelas (Unit)</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Kelas 1</label>
                            <input type="number" id="group-limit-k1" min="0" value="0"
                                class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-center focus:border-red-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Kelas 2</label>
                            <input type="number" id="group-limit-k2" min="0" value="0"
                                class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-center focus:border-orange-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Kelas 3</label>
                            <input type="number" id="group-limit-k3" min="0" value="0"
                                class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-center focus:border-yellow-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Kelas 4</label>
                            <input type="number" id="group-limit-k4" min="0" value="0"
                                class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-center focus:border-green-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Aksesoris</label>
                            <input type="number" id="group-limit-acc" min="0" value="0"
                                class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-center focus:border-purple-500 outline-none">
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeAddGroupModal()"
                        class="flex-1 py-2 bg-slate-700 text-slate-300 rounded hover:bg-slate-600 font-medium transition">Batal</button>
                    <button type="submit"
                        class="flex-1 py-2 bg-purple-600 text-white rounded hover:bg-purple-500 font-bold transition shadow-lg">
                        <i class="fas fa-save mr-2"></i> Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- SALES REPORT MODAL -->
    <div id="salesReportModal"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-blue-500/50 rounded-xl shadow-2xl w-full max-w-3xl transform transition-all scale-100 modal-scale flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-4 border-b border-slate-800">
                <h3 class="text-lg font-bold text-white flex items-center">
                    <i class="fas fa-file-invoice-dollar mr-2 text-blue-400"></i> Laporan Transaksi Penjualan
                </h3>
                <div class="flex gap-2">
                    <button id="btnDownloadSalesReport" onclick="downloadSalesReport()"
                        class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition">
                        <i class="fas fa-download mr-2"></i> Download
                    </button>
                    <button onclick="closeSalesReportModal()" class="text-slate-400 hover:text-white transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div id="salesReportContent" class="flex-1 overflow-y-auto custom-scrollbar bg-slate-800/50">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>
    <!-- CRAFTING MATERIAL USAGE REPORT MODAL -->
    <div id="craftingReportModal"
        class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-slate-900 border border-purple-500/50 rounded-xl shadow-2xl w-full max-w-4xl transform transition-all scale-100 modal-scale flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-4 border-b border-slate-800">
                <h3 class="text-lg font-bold text-white flex items-center">
                    <i class="fas fa-industry mr-2 text-purple-400"></i> Laporan Penggunaan Bahan Produksi
                </h3>
                <div class="flex gap-2">
                    <button onclick="toggleAllCraftingReports(true)"
                        class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-2 rounded-lg text-xs font-bold transition">
                        <i class="fas fa-chevron-down mr-1"></i> Buka Semua
                    </button>
                    <button onclick="toggleAllCraftingReports(false)"
                        class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-2 rounded-lg text-xs font-bold transition">
                        <i class="fas fa-chevron-up mr-1"></i> Tutup Semua
                    </button>
                    <button id="btnDownloadCraftingReport" onclick="downloadCraftingReport()"
                        class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition">
                        <i class="fas fa-download mr-2"></i> Download
                    </button>
                    <button onclick="closeCraftingReportModal()" class="text-slate-400 hover:text-white transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div id="craftingReportContent" class="flex-1 overflow-y-auto custom-scrollbar bg-slate-800/50">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>
</body>

</html>
