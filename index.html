<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vikrama ERP - Integrated System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; overflow: hidden; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar-item { transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent; }
        .sidebar-item:hover, .sidebar-item.active { background: rgba(59, 130, 246, 0.1); border-left-color: #3b82f6; color: #60a5fa; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        
        .page-section { display: none; animation: fadeIn 0.3s ease-out; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Modal Scale Animation */
        .modal-scale { animation: modalScale 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes modalScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .receipt-pattern {
            background-color: #ffffff;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, deleteDoc, updateDoc, writeBatch, serverTimestamp, query, orderBy, limit, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE (HYBRID) ---
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            // [AREA EDIT UNTUK DEPLOY VERCEL]
            firebaseConfig = {
                apiKey: "AIzaSyDh0E43GugWo4_M6qYwtu9GKJFN9Vm6UAE",
                authDomain: "vk-super-app.firebaseapp.com",
                projectId: "vk-super-app",
                storageBucket: "vk-super-app.firebasestorage.app",
                messagingSenderId: "143863741050",
                appId: "1:143863741050:web:06fccfbd07ba252173d9c3"
            };
        }

        let app, auth, db, appId;
        let currentUser = null;

        // --- STATE GLOBAL ---
        let warehouseStock = {}; 
        let warehouseHistory = []; 
        let warehouseSpecificHistory = [];
        let craftingHistory = []; 
        let productStock = [];
        let recipes = {};
        let materialPrices = {}; 
        let craftQueue = []; // ANTRIAN CRAFTING
        
        // --- MODAL STATE ---
        let currentAction = null; 
        let currentTargetItem = null;
        let currentReportElement = null;
        let currentConfirmCallback = null; // For Custom Alert

        // --- INISIALISASI ---
        const initApp = async () => {
            try {
                appId = typeof __app_id !== 'undefined' ? __app_id : 'vikrama-erp-production';
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('connection-status').innerHTML = '<span class="text-emerald-400"><i class="fas fa-wifi mr-2"></i>Online</span>';
                        startRealtimeListeners();
                    }
                });
            } catch (err) {
                console.error("Init Error", err);
                document.getElementById('connection-status').innerHTML = '<span class="text-rose-500">Offline (Check Config)</span>';
                if(!firebaseConfig.apiKey.includes("ISI_API_KEY")) {
                      showAlert("Koneksi Gagal", "Gagal menghubungkan ke Firebase: " + err.message, "error");
                }
            }
        };

        function startRealtimeListeners() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), (snap) => {
                if(snap.exists()) {
                    warehouseStock = snap.data();
                    renderWarehouseTable();
                    renderCraftingInputs();
                    renderRecipeTable(); 
                    renderCraftQueue(); 
                    renderMaterialStockPreview();
                } else {
                    warehouseStock = {};
                    renderWarehouseTable();
                    renderCraftingInputs();
                    renderRecipeTable(); 
                    renderCraftQueue();
                    renderMaterialStockPreview();
                }
            });
            
            // Listener Harga Bahan
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'material_prices', 'main_prices'), (snap) => {
                if(snap.exists()) materialPrices = snap.data();
                else materialPrices = {};
                renderPriceListTable();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'recipes'), (snap) => {
                const newRecipes = {};
                snap.forEach(d => newRecipes[d.id] = d.data());
                recipes = newRecipes;
                renderRecipeTable();
                renderProductDropdown();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (snap) => {
                productStock = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderPosGrid();
            });
            
            const qHist = query(collection(db, 'artifacts', appId, 'public', 'data', 'global_history'), orderBy('timestamp', 'desc'), limit(50));
            onSnapshot(qHist, (snap) => {
                warehouseHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderHistoryTable();
            });

            const qWhHist = query(collection(db, 'artifacts', appId, 'public', 'data', 'global_history'), orderBy('timestamp', 'desc'), limit(150));
            onSnapshot(qWhHist, (snap) => {
                const allLogs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                warehouseSpecificHistory = allLogs.filter(log => log.type === 'WAREHOUSE');
                // Filter juga untuk Crafting History
                craftingHistory = allLogs.filter(log => log.type === 'CRAFTING');
                
                renderWarehouseSpecificHistory();
                renderCraftingHistory(); // Update modal jika terbuka
            });
        }

        // --- CUSTOM ALERT SYSTEM ---
        window.showAlert = (title, message, type = 'info') => {
            const modal = document.getElementById('custom-alert-modal');
            const iconWrapper = document.getElementById('alert-icon-wrapper');
            const icon = document.getElementById('alert-icon');
            const titleEl = document.getElementById('alert-title');
            const msgEl = document.getElementById('alert-message');
            const actions = document.getElementById('alert-actions');

            titleEl.textContent = title;
            msgEl.innerHTML = message;
            actions.innerHTML = ''; 

            iconWrapper.className = 'w-16 h-16 rounded-full flex items-center justify-center mb-4 transition-colors mx-auto';
            if (type === 'success') {
                iconWrapper.classList.add('bg-emerald-500/20', 'text-emerald-500');
                icon.className = 'fas fa-check text-3xl';
            } else if (type === 'error') {
                iconWrapper.classList.add('bg-rose-500/20', 'text-rose-500');
                icon.className = 'fas fa-times text-3xl';
            } else if (type === 'warning') {
                iconWrapper.classList.add('bg-yellow-500/20', 'text-yellow-500');
                icon.className = 'fas fa-exclamation-triangle text-3xl';
            } else {
                iconWrapper.classList.add('bg-blue-500/20', 'text-blue-500');
                icon.className = 'fas fa-info text-3xl';
            }

            const btn = document.createElement('button');
            btn.className = 'w-full py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-bold transition shadow-lg';
            btn.textContent = 'OK';
            btn.onclick = closeAlert;
            actions.appendChild(btn);

            modal.classList.remove('hidden');
        };

        window.showConfirm = (title, message, callback, type = 'warning') => {
            const modal = document.getElementById('custom-alert-modal');
            const iconWrapper = document.getElementById('alert-icon-wrapper');
            const icon = document.getElementById('alert-icon');
            const titleEl = document.getElementById('alert-title');
            const msgEl = document.getElementById('alert-message');
            const actions = document.getElementById('alert-actions');

            titleEl.textContent = title;
            msgEl.innerHTML = message;
            actions.innerHTML = '';
            currentConfirmCallback = callback;

            iconWrapper.className = 'w-16 h-16 rounded-full flex items-center justify-center mb-4 transition-colors mx-auto';
            if (type === 'danger') {
                iconWrapper.classList.add('bg-rose-500/20', 'text-rose-500');
                icon.className = 'fas fa-trash-alt text-3xl';
            } else {
                iconWrapper.classList.add('bg-yellow-500/20', 'text-yellow-500');
                icon.className = 'fas fa-question text-3xl';
            }

            const btnCancel = document.createElement('button');
            btnCancel.className = 'flex-1 py-2.5 border border-slate-600 text-slate-300 hover:bg-slate-800 rounded-lg font-bold transition mr-3';
            btnCancel.textContent = 'Batal';
            btnCancel.onclick = closeAlert;

            const btnConfirm = document.createElement('button');
            const colorClass = type === 'danger' ? 'bg-rose-600 hover:bg-rose-500' : 'bg-blue-600 hover:bg-blue-500';
            btnConfirm.className = `flex-1 py-2.5 ${colorClass} text-white rounded-lg font-bold transition shadow-lg`;
            btnConfirm.textContent = 'Ya, Lanjutkan';
            btnConfirm.onclick = () => {
                if(currentConfirmCallback) currentConfirmCallback();
                closeAlert();
            };

            actions.appendChild(btnCancel);
            actions.appendChild(btnConfirm);

            modal.classList.remove('hidden');
        };

        window.closeAlert = () => {
            document.getElementById('custom-alert-modal').classList.add('hidden');
            currentConfirmCallback = null;
        };

        // --- FUNGSI-FUNGSI LOGIKA WAREHOUSE ---
        
        window.saveResource = async (e) => {
            e.preventDefault();
            const name = document.getElementById('wh-name').value.trim().toUpperCase();
            const qty = parseFloat(document.getElementById('wh-qty').value);
            
            if(!name || isNaN(qty)) return;

            const currentQty = warehouseStock[name] || 0;
            const newStock = { ...warehouseStock, [name]: currentQty + qty };

            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), newStock);
            await addLog({
                type: 'WAREHOUSE',
                subtype: 'DEPOSIT',
                itemName: name,
                desc: `Input Bahan Baru`,
                amount: qty,
                before: currentQty,
                after: currentQty + qty,
                pic: 'Admin',
                note: 'Setup Awal'
            });
            
            document.getElementById('wh-form').reset();
            showToast(`Bahan ${name} berhasil diupdate!`);
        };

        window.importWarehouseExcel = async (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if (jsonData.length === 0) {
                        showAlert("File Kosong", "File Excel tidak berisi data yang valid.", "warning");
                        return;
                    }

                    const newStock = { ...warehouseStock };
                    let logDetails = [];

                    jsonData.forEach(row => {
                        const nameKey = Object.keys(row).find(k => k.toLowerCase().includes('nama') || k.toLowerCase().includes('item') || k.toLowerCase().includes('bahan'));
                        const qtyKey = Object.keys(row).find(k => k.toLowerCase().includes('stok') || k.toLowerCase().includes('jumlah') || k.toLowerCase().includes('qty'));

                        if (nameKey && qtyKey) {
                            const name = String(row[nameKey]).trim().toUpperCase();
                            const qty = parseFloat(row[qtyKey]) || 0;
                            if (name) {
                                const current = newStock[name] || 0;
                                newStock[name] = current + qty;
                                logDetails.push(`${name} (+${qty})`);
                            }
                        }
                    });

                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), newStock);
                    await addLog({
                        type: 'WAREHOUSE',
                        subtype: 'BATCH',
                        itemName: 'Batch Import',
                        desc: `Import Excel (${logDetails.length} item)`,
                        amount: 0,
                        note: logDetails.join(', ')
                    });
                    
                    showAlert("Sukses", `Berhasil import <b>${logDetails.length}</b> item dari Excel!`, "success");
                    input.value = '';
                } catch (err) {
                    console.error(err);
                    showAlert("Gagal Import", "Terjadi kesalahan saat membaca file Excel.", "error");
                }
            };
            reader.readAsArrayBuffer(file);
        };
        
        // --- NEW FEATURE: MATERIAL PRICE MANAGEMENT ---
        window.openPriceModal = () => {
            renderPriceListTable();
            document.getElementById('priceModal').classList.remove('hidden');
        };

        window.closePriceModal = () => {
            document.getElementById('priceModal').classList.add('hidden');
        };

        window.renderPriceListTable = () => {
            const tbody = document.getElementById('price-table-body');
            if(!tbody) return;
            
            const search = document.getElementById('price-search')?.value.toUpperCase() || '';
            tbody.innerHTML = '';

            const allItems = new Set([...Object.keys(warehouseStock), ...Object.keys(materialPrices)]);
            
            if(allItems.size === 0) {
                 tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-500 italic">Belum ada data bahan.</td></tr>';
                 return;
            }

            const sortedItems = Array.from(allItems).sort();
            let count = 0;

            sortedItems.forEach(name => {
                if(name.toUpperCase().includes(search)) {
                    const price = materialPrices[name] || 0;
                    const stock = warehouseStock[name] || 0;
                    
                    tbody.innerHTML += `
                        <tr class="border-b border-slate-700 hover:bg-slate-700/50">
                            <td class="p-3 text-sm font-bold text-slate-200">${name}</td>
                            <td class="p-3 text-sm text-right font-mono text-emerald-400">Rp ${price.toLocaleString()}</td>
                            <td class="p-3 text-xs text-right text-slate-400">${stock.toLocaleString()} Unit</td>
                            <td class="p-3 text-center">
                                <div class="flex justify-center gap-2">
                                    <button onclick="openEditPriceModal('${name}', ${price})" class="text-blue-400 hover:text-white" title="Edit Harga">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteMaterialPrice('${name}')" class="text-rose-400 hover:text-white" title="Hapus Harga">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    count++;
                }
            });

            if(count === 0) tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-500 italic">Tidak ditemukan.</td></tr>';
        };

        window.openEditPriceModal = (name, currentPrice) => {
            document.getElementById('edit-price-name').value = name;
            document.getElementById('edit-price-value').value = currentPrice;
            document.getElementById('editPriceModal').classList.remove('hidden');
        };

        window.closeEditPriceModal = () => {
            document.getElementById('editPriceModal').classList.add('hidden');
        };

        window.savePriceUpdate = async () => {
            const name = document.getElementById('edit-price-name').value;
            const price = parseFloat(document.getElementById('edit-price-value').value);

            if(!name || isNaN(price) || price < 0) {
                return showAlert("Error", "Harga tidak valid", "error");
            }

            try {
                const newPrices = { ...materialPrices };
                newPrices[name] = price;
                
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'material_prices', 'main_prices'), newPrices);
                showAlert("Sukses", `Harga <b>${name}</b> berhasil diupdate!`, "success");
                closeEditPriceModal();
            } catch(err) {
                console.error(err);
                showAlert("Error", "Gagal update harga: " + err.message, "error");
            }
        };

        window.deleteMaterialPrice = (name) => {
            showConfirm("Hapus Harga?", `Yakin ingin menghapus data harga untuk <b>${name}</b>? Stok gudang tidak akan terhapus.`, async () => {
                try {
                    const newPrices = { ...materialPrices };
                    delete newPrices[name];
                    
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'material_prices', 'main_prices'), newPrices);
                    showAlert("Sukses", `Data harga ${name} dihapus.`, "success");
                } catch(err) {
                    console.error(err);
                    showAlert("Error", "Gagal menghapus harga: " + err.message, "error");
                }
            }, "danger");
        };

        window.importPriceExcel = async (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if (jsonData.length === 0) return showAlert("File Kosong", "Data tidak ditemukan.", "warning");

                    const newPrices = { ...materialPrices };
                    let updatedCount = 0;

                    jsonData.forEach(row => {
                        // Flexible key matching
                        const nameKey = Object.keys(row).find(k => k.toLowerCase().includes('nama') || k.toLowerCase().includes('bahan'));
                        const priceKey = Object.keys(row).find(k => k.toLowerCase().includes('harga') || k.toLowerCase().includes('price') || k.toLowerCase().includes('modal'));

                        if (nameKey && priceKey) {
                            const name = String(row[nameKey]).trim().toUpperCase();
                            const price = parseFloat(row[priceKey]);
                            
                            if (name && !isNaN(price)) {
                                newPrices[name] = price;
                                updatedCount++;
                            }
                        }
                    });

                    if (updatedCount > 0) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'material_prices', 'main_prices'), newPrices);
                        showAlert("Sukses", `Berhasil memperbarui harga <b>${updatedCount}</b> bahan!`, "success");
                    } else {
                        showAlert("Gagal", "Tidak ada kolom 'Nama Bahan' atau 'Harga' yang valid.", "error");
                    }
                    input.value = '';
                } catch (err) {
                    console.error(err);
                    showAlert("Error", "Gagal membaca Excel: " + err.message, "error");
                }
            };
            reader.readAsArrayBuffer(file);
        };

        window.renderWarehouseTable = () => {
            const tbody = document.getElementById('wh-table-body');
            const searchInput = document.getElementById('wh-list-search');
            const filter = searchInput ? searchInput.value.toUpperCase() : '';
            
            tbody.innerHTML = '';
            
            const items = Object.entries(warehouseStock)
                .filter(([name]) => name.toUpperCase().includes(filter))
                .sort();
            
            if (Object.keys(warehouseStock).length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-slate-500 italic">Gudang kosong.</td></tr>`;
                return;
            }

            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-slate-500">Tidak ada barang yang cocok.</td></tr>`;
                return;
            }

            items.forEach(([name, qty]) => {
                let rowClass = "border-b border-slate-700/50 hover:bg-slate-700/30 transition duration-150";
                let qtyClass = "text-emerald-400";
                
                if(qty <= 0) {
                    qtyClass = "text-rose-500 font-bold";
                    rowClass += " bg-rose-900/10";
                } else if(qty < 10) {
                    qtyClass = "text-yellow-400 font-bold";
                }

                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="p-3 align-middle">
                            <div class="font-bold text-slate-200 text-sm">${name}</div>
                        </td>
                        <td class="p-3 text-right align-middle">
                            <span class="font-mono text-sm ${qtyClass}">${qty.toLocaleString()}</span>
                        </td>
                        <td class="p-3 text-center align-middle">
                            <div class="flex justify-center gap-1">
                                <button onclick="openActionModal('DP', '${name}')" class="w-7 h-7 rounded bg-emerald-600/20 text-emerald-400 hover:bg-emerald-600 hover:text-white transition flex items-center justify-center border border-emerald-600/30" title="Deposit">
                                    <i class="fas fa-plus text-[10px]"></i>
                                </button>
                                <button onclick="openActionModal('WD', '${name}')" class="w-7 h-7 rounded bg-orange-600/20 text-orange-400 hover:bg-orange-600 hover:text-white transition flex items-center justify-center border border-orange-600/30" title="Withdraw">
                                    <i class="fas fa-minus text-[10px]"></i>
                                </button>
                                <button onclick="openActionModal('EDIT', '${name}')" class="w-7 h-7 rounded bg-blue-600/20 text-blue-400 hover:bg-blue-600 hover:text-white transition flex items-center justify-center border border-blue-600/30" title="Edit">
                                    <i class="fas fa-edit text-[10px]"></i>
                                </button>
                                <button onclick="openActionModal('DELETE', '${name}')" class="w-7 h-7 rounded bg-rose-600/20 text-rose-400 hover:bg-rose-600 hover:text-white transition flex items-center justify-center border border-rose-600/30" title="Hapus">
                                    <i class="fas fa-trash text-[10px]"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        };

        window.openBulkModal = () => {
            const tbody = document.getElementById('bulkItemsBody');
            tbody.innerHTML = '';
            const items = Object.entries(warehouseStock).sort();
            if(items.length === 0) return showAlert("Gudang Kosong", "Tidak ada item untuk diupdate.", "warning");

            items.forEach(([name, qty]) => {
                tbody.innerHTML += `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="p-3 text-sm text-gray-800 font-bold">${name}</td>
                        <td class="p-3 text-center">
                            <span class="px-2 py-1 rounded bg-gray-200 text-gray-700 text-xs font-bold border border-gray-300">${qty}</span>
                        </td>
                        <td class="p-3">
                            <select class="bulk-action w-full bg-white text-gray-800 text-xs border border-gray-300 rounded p-2 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                                <option value="DEPOSIT">Masuk (+)</option>
                                <option value="WITHDRAW">Keluar (-)</option>
                            </select>
                        </td>
                        <td class="p-3">
                            <input type="number" min="0" placeholder="0" data-name="${name}" data-stock="${qty}" class="bulk-input w-full bg-white text-gray-800 text-xs border border-gray-300 rounded p-2 text-center outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition font-bold">
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('bulkImage').value = '';
            document.getElementById('file-status-indicator').classList.add('hidden');
            
            document.getElementById('bulkUpdateModal').classList.remove('hidden');
        };

        window.filterBulkItems = () => {
            const input = document.getElementById('bulkSearchInput').value.toUpperCase();
            const rows = document.querySelectorAll('#bulkItemsBody tr');
            rows.forEach(row => {
                const name = row.cells[0].innerText.toUpperCase();
                row.style.display = name.includes(input) ? '' : 'none';
            });
        };
        
        window.handleFileSelect = (input) => {
            const indicator = document.getElementById('file-status-indicator');
            const fileNameSpan = document.getElementById('file-name-display');
            if(input.files && input.files[0]) {
                indicator.classList.remove('hidden');
                fileNameSpan.textContent = input.files[0].name;
            } else {
                indicator.classList.add('hidden');
            }
        };

        window.handleBulkSubmit = async () => {
            const rows = document.querySelectorAll('#bulkItemsBody tr');
            const pic = document.getElementById('bulkPIC').value || 'Batch Admin';
            const desc = document.getElementById('bulkDesc').value || 'Update Massal';
            
            const updates = [];
            const details = [];
            let updatedStock = { ...warehouseStock };

            for(let row of rows) {
                const input = row.querySelector('.bulk-input');
                const select = row.querySelector('.bulk-action');
                const amount = parseFloat(input.value);
                const name = input.dataset.name;
                const currentStock = parseFloat(input.dataset.stock);

                if(!isNaN(amount) && amount > 0) {
                    const type = select.value; 
                    let newStock = currentStock;
                    let symbol = '';

                    if(type === 'WITHDRAW') {
                        if(amount > currentStock) {
                            showAlert("Stok Kurang", `Stok <b>${name}</b> tidak cukup untuk dikurangi ${amount}.`, "error");
                            input.focus();
                            return;
                        }
                        newStock -= amount;
                        symbol = '-';
                    } else {
                        newStock += amount;
                        symbol = '+';
                    }

                    updatedStock[name] = newStock;
                    updates.push({ name, type, amount, before: currentStock, after: newStock });
                    details.push(`${name}: ${symbol}${amount}`);
                }
            }

            if(updates.length === 0) return showAlert("Data Kosong", "Tidak ada item yang diisi jumlahnya.", "warning");

            const btn = document.getElementById('btnBulkConfirm');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Memproses...';
            btn.disabled = true;

            try {
                let imgData = null;
                const imgInput = document.getElementById('bulkImage');
                if (imgInput.files[0]) {
                    imgData = await compressImage(imgInput.files[0]);
                }

                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), updatedStock);

                await addLog({
                    type: 'WAREHOUSE',
                    subtype: 'BATCH',
                    itemName: `Batch Update (${updates.length} Items)`,
                    desc: desc,
                    amount: 0,
                    pic: pic,
                    note: details.join(', '),
                    image: imgData,
                    details: updates
                });

                showAlert("Sukses", `Berhasil update <b>${updates.length}</b> item secara massal!`, "success");
                document.getElementById('bulkUpdateModal').classList.add('hidden');
                document.getElementById('bulkPIC').value = '';
                document.getElementById('bulkDesc').value = '';
                document.getElementById('bulkSearchInput').value = '';
                document.getElementById('bulkImage').value = '';
                document.getElementById('file-status-indicator').classList.add('hidden');

            } catch(err) {
                console.error(err);
                showAlert("Error", "Gagal melakukan update massal: " + err.message, "error");
            } finally {
                btn.innerHTML = 'Proses Semua';
                btn.disabled = false;
            }
        };

        // --- NEW FEATURE: DELETE ALL HISTORY ---
        window.deleteAllHistory = () => {
            if (warehouseSpecificHistory.length === 0) {
                return showAlert("Info", "Riwayat transaksi sudah kosong.", "info");
            }

            showConfirm(
                "Hapus Semua Riwayat?", 
                "Apakah Anda yakin ingin menghapus <b>SEMUA</b> catatan riwayat transaksi gudang? <br><br><span class='text-rose-500 font-bold'>PERINGATAN: Tindakan ini permanen dan TIDAK akan mengubah stok barang saat ini.</span>",
                async () => {
                    const btn = document.getElementById('btn-delete-all-hist');
                    if(btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    
                    try {
                        // 1. Get all warehouse logs
                        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'global_history'));
                        const snapshot = await getDocs(q);
                        
                        // 2. Batch Delete with Pagination (Max 500 per batch)
                        const batch = writeBatch(db);
                        let count = 0;
                        
                        snapshot.docs.forEach((doc) => {
                            const data = doc.data();
                            if (data.type === 'WAREHOUSE') {
                                batch.delete(doc.ref);
                                count++;
                            }
                        });

                        if(count > 0) {
                             await batch.commit();
                             showAlert("Berhasil", `Berhasil menghapus <b>${count}</b> riwayat transaksi gudang.`, "success");
                        } else {
                             showAlert("Info", "Tidak ada riwayat gudang untuk dihapus.", "info");
                        }
                    } catch (err) {
                        console.error(err);
                        showAlert("Error", "Gagal menghapus riwayat: " + err.message, "error");
                    } finally {
                         if(btn) btn.innerHTML = '<i class="fas fa-trash-alt mr-2"></i> Hapus Semua';
                    }
                },
                "danger"
            );
        };

        // --- HISTORY & RECEIPT ---
        window.renderWarehouseSpecificHistory = () => {
            const tbody = document.getElementById('wh-history-body');
            if(!tbody) return;
            tbody.innerHTML = '';

            if(warehouseSpecificHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-slate-500 italic">Belum ada riwayat transaksi gudang.</td></tr>';
                return;
            }

            warehouseSpecificHistory.forEach(h => {
                let badge = '';
                if(h.subtype === 'DEPOSIT') badge = '<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-500/20 text-blue-400 border border-blue-500/30">DP</span>';
                else if(h.subtype === 'WITHDRAW') badge = '<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-orange-500/20 text-orange-400 border border-orange-500/30">WD</span>';
                else if(h.subtype === 'BATCH') badge = '<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-purple-500/20 text-purple-400 border border-purple-500/30">BATCH</span>';
                else badge = '<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-700 text-slate-400">LOG</span>';

                const dateStr = h.timestamp ? new Date(h.timestamp.seconds*1000).toLocaleString('id-ID', {day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit'}) : '-';
                const imgBtn = h.image ? `<button onclick="showImagePreview('${h.image}')" class="text-blue-400 hover:text-blue-300 transition"><i class="fas fa-image"></i></button>` : '<span class="text-slate-600">-</span>';

                tbody.innerHTML += `
                    <tr class="border-b border-slate-800 hover:bg-slate-800/30 text-xs transition duration-150">
                        <td class="p-3 text-slate-400 whitespace-nowrap">${dateStr}</td>
                        <td class="p-3 font-bold text-slate-200">${h.itemName || '-'}</td>
                        <td class="p-3 text-center">${badge}</td>
                        <td class="p-3 text-center font-mono ${h.subtype === 'DEPOSIT' ? 'text-emerald-400' : 'text-rose-400'}">${h.amount || 0}</td>
                        <td class="p-3 text-center text-slate-500">${h.before !== undefined ? h.before : '-'}</td>
                        <td class="p-3 text-center text-slate-300 font-bold">${h.after !== undefined ? h.after : '-'}</td>
                        <td class="p-3 text-slate-400">${h.pic || '-'}</td>
                        <td class="p-3 text-slate-500 italic truncate max-w-[100px]" title="${h.note || ''}">${h.note || '-'}</td>
                        <td class="p-3 text-center">${imgBtn}</td>
                        <td class="p-3 text-center flex justify-center gap-2">
                            <button onclick="takeRowScreenshot('${h.id}')" class="text-slate-500 hover:text-blue-400 transition" title="Print Struk"><i class="fas fa-print"></i></button>
                            <button onclick="rollbackLog('${h.id}')" class="text-slate-600 hover:text-rose-500 transition" title="Hapus & Rollback Stok"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            });
        };

        window.takeRowScreenshot = (id) => {
            const log = warehouseSpecificHistory.find(l => l.id === id);
            if (!log) return;

            const originalTpl = document.getElementById('receiptTemplate');
            const tpl = originalTpl.cloneNode(true);
            tpl.removeAttribute('id');
            tpl.classList.remove('hidden');
            tpl.style.width = "100%"; 
            tpl.style.boxShadow = "none";

            const dateVal = log.timestamp ? new Date(log.timestamp.seconds*1000).toLocaleString('id-ID', {day: 'numeric', month: 'short', year:'numeric', hour: '2-digit', minute:'2-digit'}) : '-';
            tpl.querySelector('#recDate').textContent = dateVal;
            tpl.querySelector('#recPIC').textContent = log.pic || '-';
            tpl.querySelector('#recID').textContent = log.id.substring(0,8).toUpperCase();
            
            let cleanDesc = log.desc || '-';
            if (log.subtype === 'BATCH' && log.desc.includes('---')) cleanDesc = log.desc.split('---')[0];
            tpl.querySelector('#recDesc').textContent = cleanDesc;

            const recType = tpl.querySelector('#recType');
            const singleContainer = tpl.querySelector('#recSingleContainer');
            const batchContainer = tpl.querySelector('#recBatchContainer');

            if (log.subtype === 'BATCH') {
                recType.textContent = 'BATCH UPDATE';
                recType.className = 'inline-block px-3 py-1 rounded border-2 font-bold border-purple-500 text-purple-800 bg-purple-50';
                singleContainer.classList.add('hidden');
                batchContainer.classList.remove('hidden');

                const tbody = tpl.querySelector('#recBatchBody');
                tbody.innerHTML = '';

                if (log.details && log.details.length > 0) {
                    log.details.forEach(d => {
                        const isDepo = d.type === 'DEPOSIT';
                        const colorClass = isDepo ? 'text-green-600' : 'text-orange-600';
                        const sign = isDepo ? '+' : '-';
                        const badgeColor = isDepo ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800';
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="py-2 px-3">
                                <div class="font-bold text-gray-700">${d.name}</div>
                                <div class="text-[10px] text-gray-400 mt-0.5">Stok: ${d.before} <i class="fas fa-arrow-right mx-1"></i> <b>${d.after}</b></div>
                            </td>
                            <td class="py-2 px-3 text-right align-top">
                                <div class="font-bold text-lg ${colorClass}">${sign}${d.amount}</div>
                                <span class="text-[9px] font-bold uppercase px-1.5 py-0.5 rounded ${badgeColor}">${isDepo ? 'DP' : 'WD'}</span>
                            </td>`;
                        tbody.appendChild(tr);
                    });
                } else { tbody.innerHTML = `<tr><td colspan="2" class="p-3 text-center text-gray-400 italic">Detail item tidak tersedia.</td></tr>`; }
            } else {
                singleContainer.classList.remove('hidden');
                batchContainer.classList.add('hidden');
                let typeText = 'SETUP';
                let typeClass = 'border-gray-300 text-gray-700 bg-gray-50';
                let amountColor = 'text-gray-800';
                let amountSign = '';
                let badgeBg = 'bg-gray-400';

                if (log.subtype === 'DEPOSIT') { typeText = 'INBOUND (DP)'; typeClass = 'border-blue-500 text-blue-800 bg-blue-50'; amountColor = 'text-green-600'; amountSign = '+'; badgeBg = 'bg-blue-600'; }
                else if (log.subtype === 'WITHDRAW') { typeText = 'OUTBOUND (WD)'; typeClass = 'border-orange-500 text-orange-800 bg-orange-50'; amountColor = 'text-orange-600'; amountSign = '-'; badgeBg = 'bg-orange-600'; }
                
                recType.textContent = typeText;
                recType.className = `inline-block px-3 py-1 rounded border-2 font-bold ${typeClass}`;
                tpl.querySelector('#recItem').textContent = log.itemName;
                const amountEl = tpl.querySelector('#recAmount');
                amountEl.textContent = `${amountSign}${log.amount}`;
                amountEl.className = `block text-2xl font-bold ${amountColor}`;
                const badgeEl = tpl.querySelector('#recBadge');
                badgeEl.textContent = log.subtype || 'LOG';
                badgeEl.className = `block text-[10px] font-bold uppercase mt-1 px-2 py-0.5 rounded text-white ${badgeBg}`;
                tpl.querySelector('#recBefore').textContent = log.before !== undefined ? log.before : '-';
                tpl.querySelector('#recAfter').textContent = log.after !== undefined ? log.after : '-';
            }

            const imgCont = tpl.querySelector('#receiptImgCont');
            const imgEl = tpl.querySelector('#receiptImg');
            if (log.image) { imgCont.classList.remove('hidden'); imgEl.src = log.image; } else { imgCont.classList.add('hidden'); }

            const container = document.getElementById('reportPreviewContainer');
            container.innerHTML = ''; container.appendChild(tpl);
            currentReportElement = tpl; 
            document.getElementById('reportModal').classList.remove('hidden');
        };

        window.showImagePreview = (src) => { document.getElementById('preview-img-content').src = src; document.getElementById('image-preview-modal').classList.remove('hidden'); };
        window.closeImagePreview = () => document.getElementById('image-preview-modal').classList.add('hidden');

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 500;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        // --- COMMON MODAL ACTIONS ---
        window.openActionModal = (action, itemName) => {
            currentAction = action;
            currentTargetItem = itemName;
            const modal = document.getElementById('universal-modal');
            const title = document.getElementById('modal-title');
            const desc = document.getElementById('modal-desc');
            const groupName = document.getElementById('input-group-name');
            const groupQty = document.getElementById('input-group-qty');
            const groupPic = document.getElementById('input-group-pic');
            const groupImg = document.getElementById('input-group-img');
            const inputName = document.getElementById('modal-input-name');
            const inputQty = document.getElementById('modal-input-qty');
            const btnConfirm = document.getElementById('btn-modal-confirm');

            modal.classList.remove('hidden');
            inputName.value = itemName;
            inputQty.value = '';
            document.getElementById('modal-input-pic').value = '';
            document.getElementById('modal-input-note').value = '';
            document.getElementById('modal-input-img').value = '';
            
            desc.classList.add('hidden');
            groupPic.classList.add('hidden');
            groupImg.classList.add('hidden');
            
            if (action === 'DP') {
                title.innerText = `Deposit (Masuk): ${itemName}`;
                groupName.classList.add('hidden');
                groupQty.classList.remove('hidden');
                groupPic.classList.remove('hidden');
                groupImg.classList.remove('hidden');
                btnConfirm.innerText = "Tambah Stok";
                btnConfirm.className = "flex-1 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-500 font-bold";
            } else if (action === 'WD') {
                title.innerText = `Withdraw (Keluar): ${itemName}`;
                groupName.classList.add('hidden');
                groupQty.classList.remove('hidden');
                groupPic.classList.remove('hidden');
                groupImg.classList.remove('hidden');
                btnConfirm.innerText = "Kurangi Stok";
                btnConfirm.className = "flex-1 py-2 bg-orange-600 text-white rounded hover:bg-orange-500 font-bold";
            } else if (action === 'EDIT') {
                title.innerText = `Edit Resource: ${itemName}`;
                groupName.classList.remove('hidden');
                groupQty.classList.remove('hidden');
                document.getElementById('label-qty').innerText = "Stok Baru (Opname)";
                inputQty.value = warehouseStock[itemName]; 
                btnConfirm.innerText = "Simpan Perubahan";
                btnConfirm.className = "flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 font-bold";
            } else if (action === 'DELETE') {
                title.innerText = `Hapus Resource: ${itemName}`;
                desc.innerText = "Tindakan ini permanen. Stok akan dihapus dari sistem.";
                desc.classList.remove('hidden');
                groupName.classList.add('hidden');
                groupQty.classList.add('hidden');
                btnConfirm.innerText = "Ya, Hapus";
                btnConfirm.className = "flex-1 py-2 bg-rose-600 text-white rounded hover:bg-rose-500 font-bold";
            }
        };

        window.closeModal = () => {
            document.getElementById('universal-modal').classList.add('hidden');
            currentAction = null;
            currentTargetItem = null;
        };

        window.confirmModalAction = async () => {
            const name = currentTargetItem;
            const inputNameVal = document.getElementById('modal-input-name').value.trim().toUpperCase();
            const qtyVal = parseFloat(document.getElementById('modal-input-qty').value);
            const picVal = document.getElementById('modal-input-pic').value || '-';
            const noteVal = document.getElementById('modal-input-note').value || '-';
            const imgInput = document.getElementById('modal-input-img');
            const currentQty = warehouseStock[name] || 0;

            const btn = document.getElementById('btn-modal-confirm');
            const originalText = btn.innerText;
            btn.innerText = "Processing...";
            btn.disabled = true;

            try {
                let imgData = null;
                if (imgInput.files[0]) imgData = await compressImage(imgInput.files[0]);

                if (currentAction === 'DELETE') {
                    showConfirm("Konfirmasi Hapus", `Yakin ingin menghapus <b>${name}</b> permanen?`, async () => {
                         const updated = { ...warehouseStock };
                        delete updated[name];
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), updated);
                        await addLog({ type: 'WAREHOUSE', subtype: 'DELETE', itemName: name, desc: `Hapus Bahan`, amount: 0, before: currentQty, after: 0, pic: 'Admin' });
                        showAlert("Sukses", `Item ${name} berhasil dihapus.`, "success");
                        closeModal();
                    }, "danger");
                } 
                else if (currentAction === 'DP') {
                    if (isNaN(qtyVal) || qtyVal <= 0) throw new Error("Jumlah harus > 0");
                    const newStock = { ...warehouseStock, [name]: currentQty + qtyVal };
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), newStock);
                    await addLog({ type: 'WAREHOUSE', subtype: 'DEPOSIT', itemName: name, desc: `Deposit Manual`, amount: qtyVal, before: currentQty, after: currentQty + qtyVal, pic: picVal, note: noteVal, image: imgData });
                    showAlert("Sukses", "Stok berhasil ditambahkan.", "success");
                    closeModal();
                } 
                else if (currentAction === 'WD') {
                    if (isNaN(qtyVal) || qtyVal <= 0) throw new Error("Jumlah harus > 0");
                    if (qtyVal > currentQty) throw new Error("Stok tidak cukup!");
                    const newStock = { ...warehouseStock, [name]: currentQty - qtyVal };
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), newStock);
                    await addLog({ type: 'WAREHOUSE', subtype: 'WITHDRAW', itemName: name, desc: `Withdraw Manual`, amount: qtyVal, before: currentQty, after: currentQty - qtyVal, pic: picVal, note: noteVal, image: imgData });
                    showAlert("Sukses", "Stok berhasil dikurangi.", "success");
                    closeModal();
                }
                else if (currentAction === 'EDIT') {
                    if (!inputNameVal) throw new Error("Nama tidak boleh kosong");
                    if (isNaN(qtyVal) || qtyVal < 0) throw new Error("Stok tidak valid");
                    const updated = { ...warehouseStock };
                    if (inputNameVal !== name) delete updated[name];
                    updated[inputNameVal] = qtyVal;
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), updated);
                    await addLog({ type: 'WAREHOUSE', subtype: 'EDIT', itemName: inputNameVal, desc: `Opname Stok`, amount: 0, before: currentQty, after: qtyVal, pic: 'Admin' });
                    showAlert("Sukses", "Data resource berhasil diperbarui.", "success");
                    closeModal();
                }
            } catch (err) {
                showAlert("Error", err.message, "error");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        // ==========================================
        // MODULE 2: CRAFTING (PERAKITAN)
        // ==========================================
        
        window.renderCraftingInputs = () => {
            const container = document.getElementById('cr-inputs');
            if(!container) return; // Safety check if element doesn't exist yet

            if(Object.keys(warehouseStock).length === 0) {
                container.innerHTML = '<p class="text-xs text-slate-500 col-span-2">Belum ada bahan di Gudang. Input di menu Warehouse dulu.</p>';
                return;
            }
            container.innerHTML = Object.keys(warehouseStock).sort().map(mat => `
                <div class="flex flex-col">
                    <label class="text-[10px] text-slate-400 font-bold mb-1">${mat}</label>
                    <input type="number" step="any" min="0" data-material="${mat}" placeholder="Butuh brp?" 
                        class="recipe-input bg-slate-800 border border-slate-700 rounded p-2 text-xs focus:border-blue-500 outline-none text-white">
                </div>
            `).join('');
        };

        window.saveRecipe = async (e) => {
            e.preventDefault();
            const name = document.getElementById('cr-name').value.trim().toUpperCase();
            // const sellPrice = parseFloat(document.getElementById('cr-price').value) || 0; // Removed per request
            const sellPrice = 0; // Default to 0 since input is removed
            const inputs = document.querySelectorAll('.recipe-input');
            const requirements = {};
            inputs.forEach(input => {
                const val = parseFloat(input.value);
                if(val > 0) requirements[input.dataset.material] = val;
            });

            if(Object.keys(requirements).length === 0) return showAlert("Validasi", "Pilih minimal 1 bahan!", "warning");

            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'recipes', name), {
                requirements,
                sellingPrice: sellPrice
            });
            document.getElementById('cr-form').reset();
            showAlert("Sukses", `Resep ${name} berhasil disimpan.`, "success");
            closeRecipeModal();
        };

        window.renderRecipeTable = () => {
             const container = document.getElementById('cr-recipe-list');
             if(!container) return;

             const keys = Object.keys(recipes);
             if (keys.length === 0) {
                 container.innerHTML = '<div class="text-center text-slate-500 text-xs py-8 italic border-2 border-dashed border-slate-700 rounded-lg">Belum ada resep aktif.</div>';
             } else {
                container.innerHTML = keys.map(name => {
                    const rec = recipes[name];
                    const reqs = Object.entries(rec.requirements).map(([m,q]) => {
                        const currentStock = warehouseStock[m] || 0;
                        const isEnough = currentStock >= q;
                        const stockColor = isEnough ? 'text-slate-400' : 'text-rose-500 font-bold';
                        
                        return `<div class="flex justify-between items-center text-xs text-slate-400 border-b border-slate-700/50 pb-1 mb-1 last:border-0 last:mb-0 last:pb-0">
                            <span>${m}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] ${stockColor} mr-1" title="Stok Gudang">${currentStock}</span>
                                <span class="font-mono text-emerald-400 font-bold bg-slate-900 px-1.5 rounded" title="Butuh per unit">${q}</span>
                            </div>
                        </div>`;
                    }).join('');

                    return `
                        <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 hover:border-purple-500/50 transition group shadow-sm">
                            <div class="flex justify-between items-start mb-3 pb-2 border-b border-slate-700">
                                <h4 class="font-bold text-white text-sm uppercase tracking-wide flex items-center">
                                    <i class="fas fa-box-open text-purple-500 mr-2"></i> ${name}
                                </h4>
                                <div class="flex gap-1">
                                    <button onclick="editRecipe('${name}')" class="text-slate-600 hover:text-blue-400 transition p-1 rounded hover:bg-slate-700" title="Edit Resep">
                                        <i class="fas fa-edit text-xs"></i>
                                    </button>
                                    <button onclick="deleteRecipe('${name}')" class="text-slate-600 hover:text-rose-500 transition p-1 rounded hover:bg-slate-700" title="Hapus Resep">
                                        <i class="fas fa-trash-alt text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="bg-slate-900/50 rounded p-2 border border-slate-800/50">
                                <div class="flex justify-between items-center mb-2 border-b border-slate-800 pb-1">
                                    <p class="text-[10px] uppercase font-bold text-slate-500">Komposisi Bahan</p>
                                    <p class="text-[9px] text-slate-500 italic">(Punya / Butuh)</p>
                                </div>
                                <div class="space-y-1">
                                    ${reqs}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('recipeListModal').classList.remove('hidden');
        };

        // --- NEW FEATURE: EDIT RECIPE ---
        window.editRecipe = (name) => {
            const rec = recipes[name];
            if (!rec) return;

            // 1. Isi Nama Produk
            const nameInput = document.getElementById('cr-name');
            nameInput.value = name;
            
            // 2. Reset semua input bahan
            document.querySelectorAll('.recipe-input').forEach(inp => inp.value = '');
            
            // 3. Isi input bahan sesuai resep
            Object.entries(rec.requirements).forEach(([mat, qty]) => {
                const input = document.querySelector(`.recipe-input[data-material="${mat}"]`);
                if(input) input.value = qty;
            });

            // 4. Buka Modal
            openRecipeModal("Edit Resep: " + name);
        };

        window.deleteRecipe = async (name) => {
            showConfirm("Hapus Resep?", "Yakin hapus resep ini?", async () => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'recipes', name));
                showAlert("Sukses", "Resep dihapus.", "success");
            }, "danger");
        };
        
        // --- NEW FEATURE: IMPORT RECIPE FROM EXCEL ---
        window.importRecipeExcel = async (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if (jsonData.length === 0) {
                        showAlert("File Kosong", "File Excel tidak berisi data.", "warning");
                        return;
                    }

                    // Structure: { "ProductName": { sellingPrice: 0, requirements: { "Mat": Qty } } }
                    const recipeMap = {};
                    let successCount = 0;

                    jsonData.forEach(row => {
                        // Flexible key matching
                        const prodName = (row['Nama Produk'] || row['Product'] || row['Name'])?.toString().trim().toUpperCase();
                        // Harga Jual diabaikan/diset 0 sesuai request
                        const price = 0; 
                        const matName = (row['Nama Bahan'] || row['Material'] || row['Bahan'])?.toString().trim().toUpperCase();
                        const matQty = parseFloat(row['Jumlah Bahan'] || row['Qty'] || row['Amount']) || 0;

                        if (prodName && matName && matQty > 0) {
                            if (!recipeMap[prodName]) {
                                recipeMap[prodName] = { requirements: {}, sellingPrice: price };
                            }
                            
                            recipeMap[prodName].requirements[matName] = matQty;
                        }
                    });

                    const batch = writeBatch(db);
                    const recipesToSave = Object.entries(recipeMap);

                    if(recipesToSave.length === 0) {
                        showAlert("Format Salah", "Tidak ada data resep valid. Pastikan kolom: 'Nama Produk', 'Nama Bahan', 'Jumlah Bahan'.", "error");
                        return;
                    }

                    recipesToSave.forEach(([name, data]) => {
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'recipes', name);
                        batch.set(ref, data);
                        successCount++;
                    });

                    await batch.commit();
                    
                    showAlert("Sukses", `Berhasil mengimport <b>${successCount}</b> resep produk!`, "success");
                    input.value = ''; // Reset input

                } catch (err) {
                    console.error(err);
                    showAlert("Gagal Import", "Gagal membaca file Excel resep: " + err.message, "error");
                }
            };
            reader.readAsArrayBuffer(file);
        };

        window.renderProductDropdown = () => {
            const options = '<option value="">-- Pilih Produk --</option>' + 
                Object.keys(recipes).map(r => `<option value="${r}">${r}</option>`).join('');
            
            // Dropdown untuk Produksi Massal
            const s1 = document.getElementById('cr-select-product');
            if(s1) s1.innerHTML = options;
        };

        // NEW FUNCTION: GENERIC ELEMENT SCREENSHOT
        window.takeElementScreenshot = async (elementId, fileNamePrefix) => {
            const element = document.getElementById(elementId);
            if (!element) return;

            try {
                // Visual feedback (cursor wait)
                document.body.style.cursor = 'wait';
                
                const canvas = await html2canvas(element, {
                    backgroundColor: '#1e293b', // Match dark theme slate-800
                    scale: 2, 
                    logging: false,
                    ignoreElements: (el) => el.tagName === 'BUTTON' // Optional: Hide buttons in screenshot
                });

                const link = document.createElement('a');
                link.download = `${fileNamePrefix}_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast("Screenshot berhasil disimpan!", "success");
            } catch (err) {
                console.error(err);
                showAlert("Gagal", "Screenshot error: " + err.message, "error");
            } finally {
                document.body.style.cursor = 'default';
            }
        };

        // --- NEW CRAFTING QUEUE LOGIC ---
        
        window.addToCraftQueue = () => {
            const prod = document.getElementById('cr-select-product').value;
            const qty = parseInt(document.getElementById('cr-qty').value) || 1;
            
            if(!prod) return showAlert("Error", "Pilih produk terlebih dahulu.", "warning");
            if(qty <= 0) return showAlert("Error", "Jumlah harus minimal 1.", "warning");

            // Check if item already in queue
            const existingItem = craftQueue.find(item => item.name === prod);
            if(existingItem) {
                existingItem.qty += qty;
            } else {
                craftQueue.push({ name: prod, qty: qty });
            }
            
            renderCraftQueue();
            // Reset quantity input but keep product selected
            document.getElementById('cr-qty').value = 1;
        };

        window.removeFromCraftQueue = (index) => {
            craftQueue.splice(index, 1);
            renderCraftQueue();
        };

        window.resetCraftQueue = () => {
            craftQueue = [];
            renderCraftQueue();
        };

        window.renderCraftQueue = () => {
            const listContainer = document.getElementById('cr-queue-list');
            const summaryContainer = document.getElementById('cr-queue-summary');
            const btnProcess = document.getElementById('btn-process-queue');
            
            // Render Queue List
            if (craftQueue.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-slate-500 text-xs italic py-4">Antrean kosong. Tambahkan produk.</div>';
                summaryContainer.innerHTML = '<div class="text-center text-slate-500 text-xs italic">Belum ada estimasi.</div>';
                // Reset wrapper content if exists
                const wrapper = document.getElementById('total-estimation-wrapper');
                if(wrapper) wrapper.innerHTML = '<h4 class="text-[11px] font-bold text-slate-400 uppercase mb-3 flex items-center gap-2"><i class="fas fa-calculator"></i> Total Estimasi Bahan (Semua Item)</h4><div class="text-center text-slate-500 text-xs italic">Belum ada estimasi.</div>';
                
                btnProcess.disabled = true;
                btnProcess.className = "w-full bg-slate-700 text-slate-500 font-bold p-3 rounded cursor-not-allowed";
                btnProcess.innerHTML = "ANTREAN KOSONG";
                return;
            }

            // MODIFIED: Tampilkan resep terpisah per item di antrean
            listContainer.innerHTML = craftQueue.map((item, idx) => {
                const rec = recipes[item.name];
                let ingredientsHtml = '';
                
                if (rec) {
                    ingredientsHtml = '<div class="mt-2 pt-2 border-t border-slate-600/50 grid grid-cols-2 gap-x-4 gap-y-1">';
                    Object.entries(rec.requirements).forEach(([mat, baseReq]) => {
                        const totalReqItem = baseReq * item.qty;
                        ingredientsHtml += `
                            <div class="flex justify-between items-center text-[10px]">
                                <span class="text-slate-400">${mat}</span>
                                <span class="font-mono text-purple-300 font-bold">${totalReqItem}</span>
                            </div>
                        `;
                    });
                    ingredientsHtml += '</div>';
                }

                return `
                <div id="queue-item-${idx}" class="bg-slate-700/40 p-3 rounded-lg border border-slate-600 mb-3 relative group hover:border-purple-500/50 transition">
                    <button onclick="removeFromCraftQueue(${idx})" class="absolute top-2 right-2 text-slate-500 hover:text-rose-500 transition" title="Hapus dari antrean">
                        <i class="fas fa-times"></i>
                    </button>
                    <button onclick="takeElementScreenshot('queue-item-${idx}', 'Rincian_${item.name}')" class="absolute top-2 right-8 text-slate-400 hover:text-white transition" title="Screenshot Kartu Ini">
                        <i class="fas fa-camera text-xs"></i>
                    </button>
                    <div class="flex items-baseline gap-2 mb-1">
                        <h4 class="font-bold text-white text-sm uppercase text-blue-400">${item.name}</h4>
                        <span class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-bold">x${item.qty}</span>
                    </div>
                    <!-- Resep Terlampir -->
                    ${ingredientsHtml}
                </div>
            `;}).join('');

            // Calculate Total Resources Needed
            const totalResources = {};
            craftQueue.forEach(item => {
                const rec = recipes[item.name];
                if(rec) {
                    Object.entries(rec.requirements).forEach(([mat, req]) => {
                        const totalReq = req * item.qty;
                        totalResources[mat] = (totalResources[mat] || 0) + totalReq;
                    });
                }
            });

            // Render Resource Summary (MODIFIED: Full View / No Scroll)
            let allAvailable = true;
            let summaryHTML = '<div class="grid grid-cols-1 gap-2">'; 
            
            Object.entries(totalResources).forEach(([mat, req]) => {
                const stock = warehouseStock[mat] || 0;
                const isEnough = stock >= req;
                if(!isEnough) allAvailable = false;
                
                const colorClass = isEnough ? 'text-emerald-400' : 'text-rose-500 font-bold';
                const statusIcon = isEnough ? '<i class="fas fa-check-circle text-emerald-500"></i>' : '<i class="fas fa-exclamation-triangle text-rose-500"></i>';
                
                summaryHTML += `
                    <div class="flex justify-between items-center text-xs bg-slate-800 p-2.5 rounded border border-slate-700">
                        <div class="flex items-center gap-2">
                            ${statusIcon}
                            <span class="text-slate-300 font-bold">${mat}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="text-right">
                                <div class="text-[9px] text-slate-500 uppercase">Stok</div>
                                <div class="text-slate-300 font-mono">${stock}</div>
                            </div>
                            <div class="h-6 w-px bg-slate-600 mx-1"></div>
                            <div class="text-right">
                                <div class="text-[9px] text-slate-500 uppercase">Butuh</div>
                                <div class="${colorClass} font-mono text-sm">${req}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            summaryHTML += '</div>';
            
            if(!allAvailable) {
                summaryHTML += `<div class="mt-4 text-xs text-rose-200 font-bold text-center bg-rose-900/50 border border-rose-500/50 p-3 rounded-lg flex items-center justify-center gap-2 animate-pulse">
                    <i class="fas fa-hand-paper"></i> Stok tidak mencukupi untuk memproses semua antrean!
                </div>`;
            }

            // Update Summary Container with ID for screenshot
            const wrapper = document.getElementById('total-estimation-wrapper');
            if(wrapper) {
                wrapper.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-[11px] font-bold text-slate-400 uppercase flex items-center gap-2">
                            <i class="fas fa-calculator"></i> Total Estimasi Bahan
                        </h4>
                        <button onclick="takeElementScreenshot('total-estimation-wrapper', 'Estimasi_Total_Produksi')" class="text-slate-400 hover:text-white bg-slate-700 hover:bg-slate-600 rounded px-2 py-1 transition" title="Screenshot Total">
                            <i class="fas fa-camera text-xs"></i>
                        </button>
                    </div>
                    ${summaryHTML}
                `;
            }

            // Enable/Disable Process Button
            btnProcess.disabled = !allAvailable;
            btnProcess.className = `w-full mt-6 p-4 rounded-lg font-bold transition shadow-lg text-sm uppercase tracking-wider ${allAvailable ? 'bg-emerald-600 hover:bg-emerald-500 text-white shadow-emerald-900/20' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`;
            btnProcess.innerHTML = allAvailable ? `<i class="fas fa-industry mr-2"></i>PROSES PRODUKSI (${craftQueue.length} Jenis)` : `<i class="fas fa-ban mr-2"></i>BAHAN KURANG`;
        };

        window.processCraftQueue = async () => {
            if(craftQueue.length === 0) return;

            showConfirm("Konfirmasi Produksi", `Yakin ingin merakit <b>${craftQueue.length} jenis produk</b> sekaligus?`, async () => {
                try {
                    const batch = writeBatch(db);
                    const newWhStock = { ...warehouseStock };
                    const historyDetails = [];
                    const logDataPayload = []; // For structured history

                    // 1. Calculate Deductions & Updates
                    craftQueue.forEach(item => {
                        const rec = recipes[item.name];
                        const matUsed = {};
                        
                        // Deduct Materials
                        Object.entries(rec.requirements).forEach(([mat, req]) => {
                            const totalNeeded = req * item.qty;
                            newWhStock[mat] -= totalNeeded;
                            matUsed[mat] = totalNeeded;
                        });

                        // Update Product Stock
                        const existingProd = productStock.find(p => p.name === item.name);
                        if(existingProd) {
                            const prodRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', existingProd.id);
                            batch.update(prodRef, { stock: (existingProd.stock || 0) + item.qty });
                        } else {
                            const newProdRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'products'));
                            batch.set(newProdRef, {
                                name: item.name,
                                category: 'Senjata',
                                stock: item.qty,
                                sellingPrice: rec.sellingPrice,
                                costPrice: 0
                            });
                        }
                        
                        historyDetails.push(`${item.name} (x${item.qty})`);
                        logDataPayload.push({
                            name: item.name,
                            qty: item.qty,
                            materials: matUsed
                        });
                    });

                    // 2. Set Updated Warehouse Stock
                    batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'warehouse_inventory', 'main_stock'), newWhStock);

                    // 3. Create Log with Detailed Payload
                    const logRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'global_history'));
                    batch.set(logRef, {
                        type: 'CRAFTING',
                        desc: `Produksi Massal: ${historyDetails.join(', ')}`,
                        timestamp: serverTimestamp(),
                        pic: 'Operator (Batch)',
                        details: logDataPayload // Storing structured data here
                    });

                    // 4. Commit
                    await batch.commit();
                    
                    showAlert("Sukses", "Produksi massal berhasil diselesaikan!", "success");
                    resetCraftQueue();

                } catch(err) {
                    console.error(err);
                    showAlert("Error", "Gagal memproses antrean: " + err.message, "error");
                }
            }, "info");
        };

        // --- NEW: CRAFTING HISTORY LOGIC ---
        window.openCraftingHistory = () => {
            renderCraftingHistory();
            document.getElementById('craftingHistoryModal').classList.remove('hidden');
        };

        window.closeCraftingHistory = () => {
            document.getElementById('craftingHistoryModal').classList.add('hidden');
        };

        window.renderCraftingHistory = () => {
            const container = document.getElementById('craftingHistoryContent');
            if(!container) return;

            if (craftingHistory.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 text-sm py-10 italic">Belum ada riwayat produksi.</div>';
                return;
            }

            container.innerHTML = craftingHistory.map((log, index) => {
                const date = log.timestamp ? new Date(log.timestamp.seconds*1000).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) : '-';
                
                let detailsHtml = '';
                
                // Jika log memiliki struktur detail baru (details array)
                if (log.details && Array.isArray(log.details)) {
                     detailsHtml = log.details.map(item => {
                        let matsHtml = '';
                        if(item.materials) {
                            matsHtml = Object.entries(item.materials).map(([mat, qty]) => 
                                `<span class="text-xs text-slate-400 bg-slate-800 px-1.5 py-0.5 rounded border border-slate-700">${mat}: ${qty}</span>`
                            ).join(' ');
                        }

                        return `
                            <div class="mb-2 pb-2 border-b border-slate-700/50 last:border-0">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-emerald-400 text-sm">${item.name}</span>
                                    <span class="bg-blue-900/50 text-blue-300 text-xs px-2 py-0.5 rounded font-bold">x${item.qty}</span>
                                </div>
                                <div class="mt-1">
                                    <p class="text-[9px] text-slate-500 mb-1 font-bold uppercase">Bahan Digunakan:</p>
                                    <div class="flex flex-wrap gap-1">
                                        ${matsHtml}
                                    </div>
                                </div>
                            </div>
                        `;
                     }).join('');
                } else {
                    // Fallback untuk log lama (hanya deskripsi string)
                    detailsHtml = `<p class="text-slate-400 text-xs italic">${log.desc}</p>`;
                }

                return `
                    <div id="craft-log-${index}" class="bg-slate-800 border border-slate-700 rounded-lg p-4 mb-4 relative group">
                        <div class="flex justify-between items-start mb-3 border-b border-slate-700 pb-2">
                            <div>
                                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Waktu Produksi</p>
                                <p class="text-sm text-white font-mono">${date}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Operator</p>
                                <p class="text-xs text-slate-300">${log.pic || '-'}</p>
                            </div>
                        </div>
                        
                        <div class="bg-slate-900/50 rounded p-3 mb-2">
                            ${detailsHtml}
                        </div>

                        <div class="flex justify-end pt-2 gap-2">
                             <button onclick="deleteGlobalLog('${log.id}')" class="text-xs flex items-center bg-rose-900/20 hover:bg-rose-600 text-rose-500 hover:text-white border border-rose-800/50 px-3 py-1.5 rounded transition">
                                <i class="fas fa-trash-alt mr-2"></i> Hapus
                            </button>
                            <button onclick="takeElementScreenshot('craft-log-${index}', 'Log_Produksi_${index}')" class="text-xs flex items-center bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1.5 rounded transition">
                                <i class="fas fa-camera mr-2"></i> Simpan Bukti
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        };

        // --- NEW: MATERIAL STOCK PREVIEW ---
        window.renderMaterialStockPreview = () => {
            const container = document.getElementById('material-stock-preview');
            if(!container) return;
            
            if(Object.keys(warehouseStock).length === 0) {
                container.innerHTML = '<span class="text-slate-500 text-xs">Belum ada stok bahan.</span>';
                return;
            }

            container.innerHTML = Object.entries(warehouseStock).sort().map(([name, qty]) => `
                <div class="flex items-center space-x-2 bg-slate-800/50 px-3 py-1.5 rounded border border-slate-700/50">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">${name}</span>
                    <span class="text-xs font-bold text-emerald-400">${qty}</span>
                </div>
            `).join('');
        };

        // --- NEW FEATURE: STOCK SCREENSHOT ---
        window.downloadStockScreenshot = async () => {
            const btn = document.getElementById('btn-stock-screenshot');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // 1. Buat Container Invisible untuk Render Report
                const exportContainer = document.createElement('div');
                exportContainer.style.position = 'absolute';
                exportContainer.style.top = '-9999px';
                exportContainer.style.left = '-9999px';
                exportContainer.style.width = '600px';
                exportContainer.style.backgroundColor = '#1e293b'; // slate-800 context
                exportContainer.style.color = '#fff';
                exportContainer.style.padding = '30px';
                exportContainer.style.borderRadius = '12px';
                exportContainer.style.fontFamily = 'Inter, sans-serif';
                
                // 2. Isi Konten Laporan
                const date = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });
                const totalItems = Object.keys(warehouseStock).length;
                
                let rows = '';
                if(totalItems === 0) {
                    rows = '<tr><td colspan="2" class="p-4 text-center text-slate-500 italic">Gudang Kosong</td></tr>';
                } else {
                    rows = Object.entries(warehouseStock).sort().map(([name, qty]) => `
                        <tr class="border-b border-slate-600/50">
                            <td class="py-2 px-3 font-bold text-slate-200">${name}</td>
                            <td class="py-2 px-3 text-right font-mono text-emerald-400 font-bold">${qty.toLocaleString()}</td>
                        </tr>
                    `).join('');
                }

                exportContainer.innerHTML = `
                    <div class="mb-6 border-b-2 border-emerald-500 pb-4 flex justify-between items-start">
                        <div>
                            <h2 class="text-3xl font-bold text-white tracking-tight">Laporan Stok Gudang</h2>
                            <p class="text-sm text-emerald-400 font-medium mt-1">Vikrama ERP System</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-400 uppercase font-bold">Waktu Generate</div>
                            <div class="text-sm text-white font-mono">${date}</div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-900/50 rounded-lg overflow-hidden border border-slate-700">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-700 text-xs text-slate-300 uppercase font-bold">
                                <tr>
                                    <th class="py-3 px-3 text-left">Nama Material</th>
                                    <th class="py-3 px-3 text-right">Jumlah Stok</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-6 flex justify-between items-end text-[10px] text-slate-500 font-mono border-t border-slate-700 pt-4">
                        <span>Total Item: ${totalItems}</span>
                        <span>Authorized Document</span>
                    </div>
                `;

                document.body.appendChild(exportContainer);

                // 3. Generate Canvas
                const canvas = await html2canvas(exportContainer, {
                    backgroundColor: '#0f172a', // Background body slate-900
                    scale: 2, // High resolution
                    logging: false
                });

                // 4. Download
                document.body.removeChild(exportContainer);
                const link = document.createElement('a');
                link.download = `Stok_Gudang_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast("Laporan stok berhasil diunduh!", "success");

            } catch (err) {
                console.error(err);
                showAlert("Gagal", "Terjadi kesalahan saat mengambil screenshot: " + err.message, "error");
            } finally {
                btn.innerHTML = originalIcon;
                btn.disabled = false;
            }
        };

        // --- NEW FEATURE: RECIPE SCREENSHOT ---
        window.downloadRecipeScreenshot = async () => {
            const btn = document.getElementById('btn-recipe-screenshot');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // 1. Buat Container Invisible
                const exportContainer = document.createElement('div');
                exportContainer.style.position = 'absolute';
                exportContainer.style.top = '-9999px';
                exportContainer.style.left = '-9999px';
                exportContainer.style.width = '800px'; // Lebih lebar untuk grid resep
                exportContainer.style.backgroundColor = '#1e293b'; 
                exportContainer.style.color = '#fff';
                exportContainer.style.padding = '30px';
                exportContainer.style.borderRadius = '12px';
                exportContainer.style.fontFamily = 'Inter, sans-serif';
                
                const date = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });
                const totalRecipes = Object.keys(recipes).length;
                
                let content = '';
                if(totalRecipes === 0) {
                    content = '<div class="p-8 text-center text-slate-500 italic">Belum ada resep aktif.</div>';
                } else {
                    // Grid Layout untuk Resep
                    content = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">';
                    Object.entries(recipes).forEach(([name, data]) => {
                        const reqs = Object.entries(data.requirements).map(([m, q]) => 
                            `<div style="display: flex; justify-content: space-between; border-bottom: 1px solid rgba(148, 163, 184, 0.2); padding-bottom: 4px; margin-bottom: 4px; font-size: 11px;">
                                <span style="color: #cbd5e1;">${m}</span>
                                <span style="font-weight: bold; color: #34d399;">${q}</span>
                            </div>`
                        ).join('');

                        content += `
                            <div style="background-color: rgba(30, 41, 59, 0.5); border: 1px solid #475569; border-radius: 8px; padding: 15px;">
                                <h4 style="font-weight: bold; color: #c084fc; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; border-bottom: 2px solid #c084fc; padding-bottom: 5px;">${name}</h4>
                                <div>${reqs}</div>
                            </div>
                        `;
                    });
                    content += '</div>';
                }

                exportContainer.innerHTML = `
                    <div style="margin-bottom: 20px; border-bottom: 2px solid #c084fc; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h2 style="font-size: 24px; font-weight: bold; margin: 0;">Laporan Resep Produksi</h2>
                            <p style="font-size: 12px; color: #a78bfa; margin: 5px 0 0 0;">Vikrama ERP System - Crafting Module</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 10px; color: #94a3b8; text-transform: uppercase; font-weight: bold;">Waktu Generate</div>
                            <div style="font-size: 12px; font-family: monospace;">${date}</div>
                        </div>
                    </div>
                    
                    ${content}

                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: flex-end; font-size: 10px; color: #64748b; border-top: 1px solid #334155; padding-top: 15px;">
                        <span>Total Resep: ${totalRecipes}</span>
                        <span>Authorized Document</span>
                    </div>
                `;

                document.body.appendChild(exportContainer);

                // 3. Generate Canvas
                const canvas = await html2canvas(exportContainer, {
                    backgroundColor: '#0f172a',
                    scale: 2, 
                    logging: false
                });

                // 4. Download
                document.body.removeChild(exportContainer);
                const link = document.createElement('a');
                link.download = `Resep_Produksi_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast("Laporan resep berhasil diunduh!", "success");

            } catch (err) {
                console.error(err);
                showAlert("Gagal", "Screenshot error: " + err.message, "error");
            } finally {
                btn.innerHTML = originalIcon;
                btn.disabled = false;
            }
        };

        // --- NEW FEATURE: PREVIEW STOCK SCREENSHOT ---
        window.downloadPreviewScreenshot = async () => {
            const btn = document.getElementById('btn-preview-screenshot');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // 1. Buat Container Invisible
                const exportContainer = document.createElement('div');
                exportContainer.style.position = 'absolute';
                exportContainer.style.top = '-9999px';
                exportContainer.style.left = '-9999px';
                exportContainer.style.width = '600px';
                exportContainer.style.backgroundColor = '#1e293b'; 
                exportContainer.style.color = '#fff';
                exportContainer.style.padding = '30px';
                exportContainer.style.borderRadius = '12px';
                exportContainer.style.fontFamily = 'Inter, sans-serif';
                
                const date = new Date().toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });
                
                let content = '';
                if(Object.keys(warehouseStock).length === 0) {
                    content = '<div style="text-align: center; color: #64748b; font-style: italic; padding: 20px;">Belum ada stok bahan.</div>';
                } else {
                    // Render as chips to match preview style
                    const chips = Object.entries(warehouseStock).sort().map(([name, qty]) => `
                        <div style="display: inline-flex; align-items: center; background-color: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 4px; padding: 6px 12px; margin: 4px;">
                            <span style="font-size: 10px; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-right: 8px;">${name}</span>
                            <span style="font-size: 12px; font-weight: bold; color: #34d399;">${qty}</span>
                        </div>
                    `).join('');
                    content = `<div style="display: flex; flex-wrap: wrap; gap: 8px;">${chips}</div>`;
                }

                exportContainer.innerHTML = `
                    <div style="margin-bottom: 20px; border-bottom: 2px solid #34d399; padding-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h2 style="font-size: 20px; font-weight: bold; margin: 0;">Preview Stok Bahan</h2>
                            <p style="font-size: 12px; color: #6ee7b7; margin: 5px 0 0 0;">Vikrama ERP - Crafting Module</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 10px; color: #94a3b8; text-transform: uppercase; font-weight: bold;">Waktu Generate</div>
                            <div style="font-size: 12px; font-family: monospace;">${date}</div>
                        </div>
                    </div>
                    
                    ${content}

                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: flex-end; font-size: 10px; color: #64748b; border-top: 1px solid #334155; padding-top: 15px;">
                        <span>Total Item: ${Object.keys(warehouseStock).length}</span>
                        <span>Authorized Document</span>
                    </div>
                `;

                document.body.appendChild(exportContainer);

                // 3. Generate Canvas
                const canvas = await html2canvas(exportContainer, {
                    backgroundColor: '#0f172a',
                    scale: 2, 
                    logging: false
                });

                // 4. Download
                document.body.removeChild(exportContainer);
                const link = document.createElement('a');
                link.download = `Preview_Stok_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast("Screenshot preview stok berhasil!", "success");

            } catch (err) {
                console.error(err);
                showAlert("Gagal", "Screenshot error: " + err.message, "error");
            } finally {
                btn.innerHTML = originalIcon;
                btn.disabled = false;
            }
        };

        // --- NEW: RECIPE MODAL FUNCTIONS ---
        window.openRecipeModal = (title = "Buat Resep Baru") => {
            document.getElementById('recipeModalTitle').textContent = title;
            document.getElementById('recipeModal').classList.remove('hidden');
        };

        window.closeRecipeModal = () => {
            document.getElementById('recipeModal').classList.add('hidden');
            document.getElementById('cr-form').reset();
            // Reset title back to default
            setTimeout(() => document.getElementById('recipeModalTitle').textContent = "Buat Resep Baru", 300);
        };

        // --- NEW: LIST RESEP MODAL FUNCTION ---
        window.openRecipeListModal = () => {
            const container = document.getElementById('recipeListModalContent');
            if(!container) return;

            const keys = Object.keys(recipes);
            if (keys.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 text-xs py-8 italic border-2 border-dashed border-slate-700 rounded-lg">Belum ada resep aktif.</div>';
            } else {
                container.innerHTML = keys.map(name => {
                    const rec = recipes[name];
                    const reqs = Object.entries(rec.requirements).map(([m,q]) => {
                        const currentStock = warehouseStock[m] || 0;
                        const isEnough = currentStock >= q;
                        const stockColor = isEnough ? 'text-slate-400' : 'text-rose-500 font-bold';
                        
                        return `<div class="flex justify-between items-center text-xs text-slate-400 border-b border-slate-700/50 pb-1 mb-1 last:border-0 last:mb-0 last:pb-0">
                            <span>${m}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] ${stockColor} mr-1" title="Stok Gudang">${currentStock}</span>
                                <span class="font-mono text-emerald-400 font-bold bg-slate-900 px-1.5 rounded" title="Butuh per unit">${q}</span>
                            </div>
                        </div>`;
                    }).join('');

                    return `
                        <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 hover:border-purple-500/50 transition group shadow-sm">
                            <div class="flex justify-between items-start mb-3 pb-2 border-b border-slate-700">
                                <h4 class="font-bold text-white text-sm uppercase tracking-wide flex items-center">
                                    <i class="fas fa-box-open text-purple-500 mr-2"></i> ${name}
                                </h4>
                                <div class="flex gap-1">
                                    <button onclick="editRecipe('${name}')" class="text-slate-600 hover:text-blue-400 transition p-1 rounded hover:bg-slate-700" title="Edit Resep">
                                        <i class="fas fa-edit text-xs"></i>
                                    </button>
                                    <button onclick="deleteRecipe('${name}')" class="text-slate-600 hover:text-rose-500 transition p-1 rounded hover:bg-slate-700" title="Hapus Resep">
                                        <i class="fas fa-trash-alt text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="bg-slate-900/50 rounded p-2 border border-slate-800/50">
                                <div class="flex justify-between items-center mb-2 border-b border-slate-800 pb-1">
                                    <p class="text-[10px] uppercase font-bold text-slate-500">Komposisi Bahan</p>
                                    <p class="text-[9px] text-slate-500 italic">(Punya / Butuh)</p>
                                </div>
                                <div class="space-y-1">
                                    ${reqs}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('recipeListModal').classList.remove('hidden');
        };

        window.closeRecipeListModal = () => {
            document.getElementById('recipeListModal').classList.add('hidden');
        };

        // --- DEPRECATED SINGLE CRAFT (KEPT FOR REFERENCE OR REMOVED) ---
        // calculateCraft and doCraft removed in favor of queue system for the main panel
        window.calculateCraft = () => {}; // Dummy to prevent error if called
        window.doCraft = async () => {}; // Dummy

        // ==========================================
        // MODULE 3: GUN POS (PENJUALAN)
        // ==========================================
        let cart = [];

        window.renderPosGrid = () => {
            const grid = document.getElementById('pos-grid');
            grid.innerHTML = productStock.map(p => {
                const inStock = p.stock > 0;
                return `
                <div onclick="${inStock ? `addToCart('${p.id}')` : ''}" 
                    class="bg-slate-800 border ${inStock ? 'border-slate-700 hover:border-blue-500 cursor-pointer' : 'border-rose-900/50 opacity-60'} rounded-lg p-4 relative group transition">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-white text-sm">${p.name}</h4>
                        <span class="text-[10px] bg-slate-900 px-2 py-0.5 rounded text-slate-400">${p.category}</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <span class="text-xs text-slate-400">Stok: ${p.stock}</span>
                        <span class="text-emerald-400 font-bold text-sm">Rp ${p.sellingPrice.toLocaleString()}</span>
                    </div>
                    ${!inStock ? '<div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-lg text-rose-500 font-bold text-xs">HABIS</div>' : ''}
                </div>`;
            }).join('');
        };

        window.addToCart = (id) => {
            const prod = productStock.find(p => p.id === id);
            const item = cart.find(c => c.id === id);
            
            if(item) {
                if(item.qty < prod.stock) item.qty++;
                else showToast('Stok tidak cukup', 'error');
            } else {
                cart.push({ ...prod, qty: 1 });
            }
            renderCart();
        };

        window.renderCart = () => {
            const container = document.getElementById('pos-cart-items');
            let total = 0;
            container.innerHTML = cart.map((c, idx) => {
                const sub = c.qty * c.sellingPrice;
                total += sub;
                return `
                <div class="flex justify-between items-center bg-slate-800 p-2 rounded mb-2 text-sm border border-slate-700">
                    <div class="flex-1">
                        <div class="font-bold text-slate-200">${c.name}</div>
                        <div class="text-xs text-slate-500">@ ${c.sellingPrice.toLocaleString()}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateCart(${idx}, -1)" class="w-6 h-6 bg-slate-700 rounded text-xs">-</button>
                        <span class="font-bold w-4 text-center text-white">${c.qty}</span>
                        <button onclick="updateCart(${idx}, 1)" class="w-6 h-6 bg-blue-600 rounded text-xs">+</button>
                    </div>
                </div>`;
            }).join('');
            
            document.getElementById('pos-total').innerText = `Rp ${total.toLocaleString()}`;
            document.getElementById('btn-checkout').disabled = cart.length === 0;
        };

        window.updateCart = (idx, delta) => {
            const item = cart[idx];
            const prod = productStock.find(p => p.id === item.id);
            const newQty = item.qty + delta;
            if(newQty > prod.stock) return showToast('Melebihi stok gudang', 'error');
            if(newQty <= 0) cart.splice(idx, 1);
            else item.qty = newQty;
            renderCart();
        };

        window.checkout = async () => {
            if(cart.length === 0) return;
            const pic = document.getElementById('pos-pic').value || 'Kasir';
            
            showConfirm('Proses Transaksi?', 'Apakah Anda yakin ingin memproses transaksi ini? Stok akan berkurang.', async () => {
                const batch = writeBatch(db);
                let totalSales = 0;
                const descItems = [];

                cart.forEach(item => {
                    const prod = productStock.find(p => p.id === item.id);
                    const remaining = prod.stock - item.qty;
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'products', item.id);
                    batch.update(ref, { stock: remaining });
                    
                    totalSales += (item.qty * item.sellingPrice);
                    descItems.push(`${item.name} (${item.qty})`);
                });

                const logRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'global_history'));
                batch.set(logRef, {
                    type: 'SALES',
                    desc: `Penjualan: ${descItems.join(', ')}`,
                    amount: totalSales,
                    pic: pic,
                    timestamp: serverTimestamp()
                });

                await batch.commit();
                cart = [];
                renderCart();
                document.getElementById('pos-pic').value = '';
                showAlert("Berhasil", 'Transaksi penjualan berhasil diproses!', 'success');
            }, 'info');
        };

        // ==========================================
        // MODULE 4: HISTORY & GLOBAL
        // ==========================================

        window.addLog = async (data) => {
            const logData = { timestamp: serverTimestamp(), ...data };
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'global_history'), logData);
        };
        
        // --- NEW: DELETE & VIEW DETAILS GLOBAL HISTORY ---
        window.deleteGlobalLog = (id) => {
            showConfirm("Hapus Riwayat?", "Apakah Anda yakin ingin menghapus catatan riwayat ini? Stok tidak akan berubah.", async () => {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'global_history', id));
                    showToast("Riwayat berhasil dihapus.", "success");
                } catch(err) {
                    console.error(err);
                    showAlert("Error", "Gagal menghapus riwayat: " + err.message, "error");
                }
            }, "danger");
        };

        window.viewLogDetails = (id) => {
            const log = warehouseHistory.find(l => l.id === id);
            if (!log) return;
            
            const modal = document.getElementById('transactionDetailModal');
            const title = document.getElementById('td-title');
            const content = document.getElementById('td-content');
            
            title.textContent = `Detail Transaksi: ${log.type}`;
            let html = '';
            
            // Format Content based on log type
            if (log.details && Array.isArray(log.details)) {
                // Crafting details structure
                html = log.details.map(item => {
                    let matsHtml = '';
                    if(item.materials) {
                        matsHtml = Object.entries(item.materials).map(([mat, qty]) => 
                            `<div class="flex justify-between text-xs text-slate-400 border-b border-slate-700/30 pb-1 mb-1 last:border-0">
                                <span>${mat}</span>
                                <span class="font-mono text-emerald-400">${qty}</span>
                             </div>`
                        ).join('');
                    }
                    return `
                        <div class="bg-slate-800 p-3 rounded mb-3 border border-slate-700">
                            <div class="flex justify-between items-center mb-2 border-b border-slate-600 pb-2">
                                <span class="font-bold text-white">${item.name}</span>
                                <span class="text-xs bg-blue-900 text-blue-300 px-2 py-0.5 rounded">x${item.qty}</span>
                            </div>
                            <div>
                                <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Bahan Digunakan:</p>
                                ${matsHtml || '<span class="text-xs text-slate-500 italic">Tidak ada detail bahan</span>'}
                            </div>
                        </div>
                    `;
                }).join('');
            } else if (log.note) {
                 html = `<div class="p-4 bg-slate-800 rounded text-slate-300 text-sm">${log.note}</div>`;
            } else {
                 html = `<div class="p-4 bg-slate-800 rounded text-slate-300 text-sm">${log.desc}</div>`;
            }
            
            content.innerHTML = html;
            modal.classList.remove('hidden');
        };

        window.closeTransactionDetailModal = () => {
            document.getElementById('transactionDetailModal').classList.add('hidden');
        };

        window.renderHistoryTable = () => {
            const tbody = document.getElementById('hist-table-body');
            tbody.innerHTML = warehouseHistory.map(h => {
                let color = 'text-slate-400';
                if(h.type === 'SALES') color = 'text-emerald-400';
                if(h.type === 'CRAFTING') color = 'text-blue-400';
                if(h.type === 'WAREHOUSE') color = 'text-orange-400';

                // Check if details exist to show view button
                const showDetail = (h.details && h.details.length > 0) || h.note;
                const viewBtn = showDetail ? 
                    `<button onclick="viewLogDetails('${h.id}')" class="text-blue-400 hover:text-white mr-2" title="Lihat Detail"><i class="fas fa-eye"></i></button>` : 
                    `<span class="text-slate-700 mr-2"><i class="fas fa-eye-slash"></i></span>`;

                return `
                <tr class="border-b border-slate-800 text-xs hover:bg-slate-800/30">
                    <td class="p-3 text-slate-500">${h.timestamp ? new Date(h.timestamp.seconds*1000).toLocaleString() : '-'}</td>
                    <td class="p-3 font-bold ${color}">${h.type}</td>
                    <td class="p-3 text-slate-300">${h.desc}</td>
                    <td class="p-3 text-right font-mono">${h.amount && h.type === 'SALES' ? 'Rp '+h.amount.toLocaleString() : '-'}</td>
                    <td class="p-3 text-slate-500">${h.pic || '-'}</td>
                    <td class="p-3 text-center">
                        ${viewBtn}
                        <button onclick="deleteGlobalLog('${h.id}')" class="text-rose-400 hover:text-white" title="Hapus"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
        };

        // UI HELPERS
        window.switchTab = (tabId) => {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`btn-${tabId}`).classList.add('active');
        };

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.innerHTML = msg;
            t.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-xl text-white font-bold transition transform duration-300 z-[110] ${type === 'error' ? 'bg-rose-600' : 'bg-emerald-600'}`;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        initApp();

    </script>
</head>
<body class="flex h-screen bg-slate-900">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col z-20 shrink-0">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-900/50">
                <i class="fas fa-network-wired text-white"></i>
            </div>
            <div>
                <h1 class="font-bold text-white text-lg tracking-tight">VIKRAMA ERP</h1>
                <p id="connection-status" class="text-[10px] text-slate-500 font-mono">Connecting...</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <div id="btn-warehouse" onclick="switchTab('warehouse')" class="sidebar-item active px-6 py-3 text-slate-400 font-medium flex items-center gap-3">
                <i class="fas fa-warehouse w-5 text-center"></i>
                <span>Gudang Bahan</span>
            </div>
            <div id="btn-crafting" onclick="switchTab('crafting')" class="sidebar-item px-6 py-3 text-slate-400 font-medium flex items-center gap-3">
                <i class="fas fa-hammer w-5 text-center"></i>
                <span>Perakitan (Craft)</span>
            </div>
            <div id="btn-pos" onclick="switchTab('pos')" class="sidebar-item px-6 py-3 text-slate-400 font-medium flex items-center gap-3">
                <i class="fas fa-cash-register w-5 text-center"></i>
                <span>Toko Senjata (POS)</span>
            </div>
            <div id="btn-history" onclick="switchTab('history')" class="sidebar-item px-6 py-3 text-slate-400 font-medium flex items-center gap-3">
                <i class="fas fa-history w-5 text-center"></i>
                <span>Riwayat Global</span>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-800 text-xs text-slate-600 text-center">
            v5.0 Recipe Import<br>
            &copy; 2025 Vikrama Kulapati
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-hidden relative bg-slate-900 text-slate-200">
        <div class="absolute inset-0 overflow-y-auto p-8 custom-scrollbar">
            
            <!-- 1. WAREHOUSE VIEW -->
            <section id="warehouse" class="page-section active w-full max-w-[95%] mx-auto">
                <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">Gudang Material</h2>
                        <p class="text-slate-400">Kelola stok bahan mentah untuk keperluan produksi.</p>
                    </div>
                    <div class="flex gap-3">
                         <button onclick="openPriceModal()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-tags mr-2"></i> Harga Bahan
                         </button>
                         <button onclick="document.getElementById('wh-import-input').click()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-file-excel mr-2"></i> Import Excel
                         </button>
                         <button onclick="openBulkModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-layer-group mr-2"></i> Update Massal
                         </button>
                         <input type="file" id="wh-import-input" accept=".xlsx, .xls" class="hidden" onchange="importWarehouseExcel(this)">
                    </div>
                </header>

                <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
                    <!-- INPUT FORM -->
                    <div class="xl:col-span-1 glass-panel p-6 rounded-xl h-fit">
                        <h3 class="text-lg font-bold text-blue-400 mb-4 flex items-center"><i class="fas fa-plus-circle mr-2"></i>Input Material</h3>
                        <form id="wh-form" onsubmit="saveResource(event)" class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Nama Bahan</label>
                                <input type="text" id="wh-name" placeholder="Contoh: BESI, KAYU" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:border-blue-500 outline-none uppercase font-bold">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Jumlah Masuk</label>
                                <input type="number" id="wh-qty" placeholder="0" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:border-blue-500 outline-none">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2.5 rounded-lg transition shadow-lg shadow-blue-900/20">
                                SIMPAN STOK
                            </button>
                        </form>
                    </div>

                    <div class="xl:col-span-3 space-y-8">
                        <!-- TABEL STOK COMPACT -->
                        <div class="glass-panel p-6 rounded-xl flex flex-col h-[600px]">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-white flex items-center">
                                    <span><i class="fas fa-boxes mr-2 text-slate-500"></i>Stok Saat Ini</span>
                                </h3>
                                <div class="flex gap-2">
                                    <button id="btn-stock-screenshot" onclick="downloadStockScreenshot()" class="w-9 h-9 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300 flex items-center justify-center transition border border-slate-600" title="Ambil Screenshot Stok">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                    <div class="relative w-64">
                                        <i class="fas fa-search absolute left-3 top-3 text-slate-500 text-xs"></i>
                                        <input type="text" id="wh-list-search" onkeyup="renderWarehouseTable()" placeholder="Cari barang..." class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-9 p-2 text-sm text-white focus:border-blue-500 outline-none">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex-1 overflow-y-auto custom-scrollbar border border-slate-700 rounded-lg bg-slate-900/30">
                                <table class="w-full text-left text-sm relative">
                                    <thead class="text-xs text-slate-400 uppercase bg-slate-800/90 sticky top-0 z-10 shadow-sm backdrop-blur-sm">
                                        <tr>
                                            <th class="p-3 text-left">Nama Resource</th>
                                            <th class="p-3 text-right">Stok</th>
                                            <th class="p-3 text-center w-32">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wh-table-body" class="divide-y divide-slate-700/50">
                                        <tr><td colspan="3" class="p-8 text-center text-slate-500 italic"><i class="fas fa-circle-notch fa-spin mr-2"></i>Memuat data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- TABEL RIWAYAT TRANSAKSI -->
                        <div class="glass-panel p-6 rounded-xl border-t-4 border-slate-700">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-white flex items-center">
                                    <i class="fas fa-history mr-2 text-slate-500"></i>Riwayat Transaksi Gudang
                                </h3>
                                <button id="btn-delete-all-hist" onclick="deleteAllHistory()" class="text-xs bg-rose-600/20 text-rose-400 hover:bg-rose-600 hover:text-white px-3 py-1.5 rounded-lg border border-rose-600/30 transition flex items-center">
                                    <i class="fas fa-trash-alt mr-2"></i> Hapus Semua
                                </button>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm whitespace-nowrap">
                                    <thead class="text-xs text-slate-500 uppercase bg-slate-800/50">
                                        <tr>
                                            <th class="p-3 rounded-l-lg">Tanggal</th>
                                            <th class="p-3">Resource</th>
                                            <th class="p-3 text-center">Tipe</th>
                                            <th class="p-3 text-center">Jml</th>
                                            <th class="p-3 text-center">Awal</th>
                                            <th class="p-3 text-center">Akhir</th>
                                            <th class="p-3">PIC</th>
                                            <th class="p-3">Ket</th>
                                            <th class="p-3 text-center">Bukti</th>
                                            <th class="p-3 text-center rounded-r-lg">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wh-history-body">
                                        <tr><td colspan="10" class="p-4 text-center text-slate-500 italic">Memuat riwayat...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. CRAFTING VIEW -->
            <section id="crafting" class="page-section max-w-7xl mx-auto">
                <!-- NEW HEADER WITH STOCK PREVIEW -->
                <div class="mb-6 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-xs font-bold text-slate-400 uppercase flex items-center">
                            <i class="fas fa-cubes mr-2"></i>Stok Bahan Saat Ini (Preview)
                        </h4>
                        <button id="btn-preview-screenshot" onclick="downloadPreviewScreenshot()" class="w-6 h-6 rounded bg-slate-700 hover:bg-slate-600 text-slate-300 flex items-center justify-center transition border border-slate-600" title="Ambil Screenshot Preview">
                            <i class="fas fa-camera text-[10px]"></i>
                        </button>
                    </div>
                    <div id="material-stock-preview" class="flex flex-wrap gap-2 max-h-24 overflow-y-auto custom-scrollbar">
                        <!-- Injected via JS -->
                        <span class="text-slate-500 text-xs italic">Memuat stok...</span>
                    </div>
                </div>

                <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">Pabrik Perakitan</h2>
                        <p class="text-slate-400">Ubah bahan mentah menjadi produk senjata siap jual.</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                         <!-- Tombol Daftar Resep Dipindahkan ke Sini -->
                         <button onclick="openRecipeListModal()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-clipboard-list mr-2"></i> Daftar Resep
                         </button>
                         <button onclick="openRecipeModal()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-plus-circle mr-2"></i> Buat Resep Baru
                         </button>
                         <button onclick="document.getElementById('recipe-import-input').click()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-file-excel mr-2"></i> Import Resep (Excel)
                         </button>
                         <input type="file" id="recipe-import-input" accept=".xlsx, .xls" class="hidden" onchange="importRecipeExcel(this)">
                         
                         <!-- NEW CRAFTING HISTORY BUTTON -->
                         <button onclick="openCraftingHistory()" class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-history mr-2"></i> Riwayat Produksi
                         </button>
                    </div>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <!-- RIGHT COLUMN: PRODUCTION PANEL -->
                    <div class="lg:col-span-12">
                        <div class="glass-panel p-8 rounded-xl border-t-4 border-emerald-500 h-full flex flex-col relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-32 bg-emerald-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                            
                            <div class="text-center mb-6">
                                <i class="fas fa-industry text-6xl text-slate-700 mb-2"></i>
                                <h2 class="text-2xl font-bold text-white">Produksi Massal</h2>
                                <p class="text-xs text-slate-400">Tambahkan beberapa item ke antrean untuk dirakit sekaligus.</p>
                            </div>
                            
                            <!-- Split Panel for Queue System -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10 flex-1 min-h-0">
                                <!-- INPUT SECTION -->
                                <div class="flex flex-col space-y-4">
                                    <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700 h-full">
                                        <h4 class="text-sm font-bold text-emerald-400 mb-4 border-b border-slate-700 pb-2">1. Pilih Produk & Jumlah</h4>
                                        
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Produk</label>
                                                <select id="cr-select-product" class="w-full bg-slate-900 border border-slate-600 rounded p-2.5 text-white font-bold outline-none focus:border-emerald-500 text-sm"></select>
                                            </div>
                                            <div>
                                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Jumlah Unit</label>
                                                <input type="number" id="cr-qty" value="1" min="1" class="w-full bg-slate-900 border border-slate-600 rounded p-2.5 text-white font-bold outline-none focus:border-emerald-500 text-sm text-center">
                                            </div>
                                            <button onclick="addToCraftQueue()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2.5 rounded-lg transition shadow-lg mt-2 flex items-center justify-center">
                                                <i class="fas fa-plus mr-2"></i> Tambahkan ke List
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- QUEUE & SUMMARY SECTION -->
                                <div class="flex flex-col h-full space-y-4">
                                    <!-- Queue List -->
                                    <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex-col min-h-0">
                                        <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                                            <h4 class="text-sm font-bold text-emerald-400">2. Antrean & Kebutuhan Per Item</h4>
                                            <button onclick="resetCraftQueue()" class="text-[10px] text-rose-400 hover:text-white hover:bg-rose-500 px-2 py-0.5 rounded transition">Reset</button>
                                        </div>
                                        <!-- List now accommodates detailed cards -->
                                        <div id="cr-queue-list" class="flex-1 space-y-2 mb-6">
                                            <div class="text-center text-slate-500 text-xs italic py-4">Antrean kosong.</div>
                                        </div>

                                        <!-- Resource Summary (Full, No Scroll) -->
                                        <div id="total-estimation-wrapper" class="bg-slate-900 p-4 rounded-lg border border-slate-800">
                                            <div class="flex justify-between items-center mb-3">
                                                <h4 class="text-[11px] font-bold text-slate-400 uppercase flex items-center gap-2">
                                                    <i class="fas fa-calculator"></i> Total Estimasi Bahan
                                                </h4>
                                                <button onclick="takeElementScreenshot('total-estimation-wrapper', 'Estimasi_Total_Produksi')" class="text-slate-400 hover:text-white bg-slate-700 hover:bg-slate-600 rounded px-2 py-1 transition" title="Screenshot Total">
                                                    <i class="fas fa-camera text-xs"></i>
                                                </button>
                                            </div>
                                            <!-- Removed max-h classes to show full list -->
                                            <div id="cr-queue-summary" class="text-xs text-slate-400">
                                                <div class="text-center italic">Belum ada estimasi.</div>
                                            </div>
                                        </div>

                                        <button id="btn-process-queue" onclick="processCraftQueue()" disabled class="w-full bg-slate-700 text-slate-500 font-bold p-3 rounded cursor-not-allowed transition shadow-lg mt-4">
                                            ANTREAN KOSONG
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. GUN POS VIEW -->
            <section id="pos" class="page-section max-w-7xl mx-auto">
                 <header class="mb-8 flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">Toko Senjata</h2>
                        <p class="text-slate-400">Penjualan produk jadi kepada pelanggan.</p>
                    </div>
                </header>

                <div class="flex flex-col lg:flex-row gap-6 h-[calc(100vh-150px)]">
                    <div class="flex-1 glass-panel rounded-xl p-4 overflow-y-auto custom-scrollbar">
                         <div id="pos-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
                             <div class="col-span-full text-center text-slate-500 py-20">Belum ada stok barang jadi. Lakukan Crafting dulu.</div>
                         </div>
                    </div>

                    <div class="w-full lg:w-96 glass-panel rounded-xl flex flex-col border-l-4 border-blue-500">
                        <div class="p-4 border-b border-slate-800 bg-slate-800/50">
                            <h3 class="font-bold text-white flex items-center"><i class="fas fa-shopping-cart mr-2"></i>Keranjang</h3>
                        </div>
                        
                        <div id="pos-cart-items" class="flex-1 overflow-y-auto p-4 space-y-2">
                            <p class="text-center text-slate-500 text-sm mt-10">Keranjang kosong.</p>
                        </div>

                        <div class="p-4 bg-slate-800/80 mt-auto border-t border-slate-700">
                            <div class="mb-3">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Nama Pembeli / PIC</label>
                                <input type="text" id="pos-pic" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm text-white mt-1">
                            </div>
                            <div class="flex justify-between items-end mb-4">
                                <span class="text-slate-400 text-sm">Total Tagihan:</span>
                                <span id="pos-total" class="text-2xl font-bold text-emerald-400">Rp 0</span>
                            </div>
                            <button id="btn-checkout" onclick="checkout()" disabled class="w-full bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:text-slate-500 text-white font-bold py-3 rounded-lg shadow-lg transition">
                                PROSES TRANSAKSI
                            </button>
                        </div>
                    </div>
                </div>
            </section>

             <!-- 4. HISTORY VIEW -->
            <section id="history" class="page-section max-w-6xl mx-auto">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Jejak Aktivitas Global</h2>
                    <p class="text-slate-400">Log transaksi Gudang, Produksi, dan Penjualan.</p>
                </header>

                <div class="glass-panel rounded-xl overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-800 text-slate-400 text-xs uppercase font-bold">
                            <tr>
                                <th class="p-4">Waktu</th>
                                <th class="p-4">Tipe</th>
                                <th class="p-4">Aktivitas</th>
                                <th class="p-4 text-right">Nilai (Rp)</th>
                                <th class="p-4">PIC</th>
                                <th class="p-4 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="hist-table-body"></tbody>
                    </table>
                </div>
            </section>

        </div>
    </main>

    <!-- NEW UNIVERSAL MODAL -->
    <div id="universal-modal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-100">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4">Action</h3>
            <p id="modal-desc" class="text-slate-400 text-sm mb-4 hidden"></p>
            
            <div id="modal-inputs" class="space-y-3">
                 <div id="input-group-name" class="hidden">
                    <label class="text-[10px] uppercase font-bold text-slate-500">Nama Baru</label>
                    <input type="text" id="modal-input-name" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white outline-none focus:border-blue-500">
                 </div>
                 <div id="input-group-qty">
                    <label id="label-qty" class="text-[10px] uppercase font-bold text-slate-500">Jumlah</label>
                    <input type="number" id="modal-input-qty" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white outline-none focus:border-blue-500">
                 </div>
                 <div id="input-group-pic" class="hidden">
                    <label class="text-[10px] uppercase font-bold text-slate-500">PIC (Penanggung Jawab)</label>
                    <input type="text" id="modal-input-pic" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white outline-none focus:border-blue-500">
                 </div>
                 <div id="input-group-pic" class="hidden"> <!-- Duplicate ID removed in logic, simplified -->
                    <label class="text-[10px] uppercase font-bold text-slate-500">Keterangan</label>
                    <input type="text" id="modal-input-note" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white outline-none focus:border-blue-500">
                 </div>
                 <div id="input-group-img" class="hidden">
                    <label class="text-[10px] uppercase font-bold text-slate-500">Bukti Foto</label>
                    <input type="file" id="modal-input-img" accept="image/*" class="w-full text-xs text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-slate-700 file:text-slate-300 hover:file:bg-slate-600">
                 </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeModal()" class="flex-1 py-2 bg-slate-700 text-slate-300 rounded hover:bg-slate-600 font-medium transition">Batal</button>
                <button id="btn-modal-confirm" onclick="confirmModalAction()" class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 font-bold transition shadow-lg">Simpan</button>
            </div>
        </div>
    </div>

    <!-- NEW RECIPE CREATION MODAL -->
    <div id="recipeModal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-purple-500/50 rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100 modal-scale relative">
            <button onclick="closeRecipeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white transition"><i class="fas fa-times"></i></button>
            
            <h3 id="recipeModalTitle" class="text-xl font-bold text-purple-400 mb-6 flex items-center"><i class="fas fa-scroll mr-3"></i>Buat Resep Baru</h3>
            
            <form id="cr-form" onsubmit="saveRecipe(event)" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Produk</label>
                    <input type="text" id="cr-name" placeholder="CONTOH: AK-47" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white font-bold uppercase outline-none focus:border-purple-500 transition">
                </div>
                
                <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-3 flex justify-between">
                        <span>Komposisi Bahan</span>
                        <span class="text-slate-600 italic">(Isi jumlah yang dibutuhkan)</span>
                    </p>
                    <div id="cr-inputs" class="grid grid-cols-2 gap-3 max-h-60 overflow-y-auto custom-scrollbar pr-1">
                        <!-- Inputs injected via JS -->
                    </div>
                </div>
                
                <button class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-purple-900/20">
                    SIMPAN RESEP
                </button>
            </form>
        </div>
    </div>

    <!-- NEW RECIPE LIST MODAL -->
    <div id="recipeListModal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-purple-500/50 rounded-xl shadow-2xl w-full max-w-2xl h-[80vh] p-6 transform transition-all scale-100 modal-scale flex flex-col relative">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-purple-400 flex items-center">
                    <i class="fas fa-clipboard-list mr-3"></i>Daftar Resep Aktif
                </h3>
                <div class="flex items-center gap-2">
                    <button onclick="downloadRecipeScreenshot()" class="w-8 h-8 rounded bg-slate-700 hover:bg-slate-600 text-slate-300 flex items-center justify-center transition border border-slate-600" title="Ambil Screenshot Resep" id="btn-recipe-screenshot">
                        <i class="fas fa-camera text-xs"></i>
                    </button>
                    <button onclick="closeRecipeListModal()" class="text-slate-400 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
                </div>
            </div>
            
            <div id="recipeListModalContent" class="flex-1 overflow-y-auto custom-scrollbar pr-2 grid grid-cols-1 md:grid-cols-2 gap-4 auto-rows-min">
                <!-- Cards injected via JS -->
            </div>
        </div>
    </div>

    <!-- NEW CRAFTING HISTORY MODAL -->
    <div id="craftingHistoryModal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-cyan-500/50 rounded-xl shadow-2xl w-full max-w-2xl h-[85vh] p-6 transform transition-all scale-100 modal-scale flex flex-col relative">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-cyan-400 flex items-center">
                    <i class="fas fa-history mr-3"></i>Riwayat Produksi
                </h3>
                <button onclick="closeCraftingHistory()" class="text-slate-400 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div id="craftingHistoryContent" class="flex-1 overflow-y-auto custom-scrollbar pr-2">
                <div class="text-center text-slate-500 text-sm py-10 italic">Memuat riwayat...</div>
            </div>
        </div>
    </div>
    
    <!-- NEW TRANSACTION DETAIL MODAL -->
    <div id="transactionDetailModal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-600 rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 modal-scale flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-3">
                <h3 id="td-title" class="text-lg font-bold text-white">Detail Transaksi</h3>
                <button onclick="closeTransactionDetailModal()" class="text-slate-400 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="td-content" class="flex-1 overflow-y-auto custom-scrollbar"></div>
        </div>
    </div>

    <!-- NEW PRICE LIST MODAL -->
    <div id="priceModal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-yellow-500/50 rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 modal-scale relative flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-yellow-500 flex items-center">
                    <i class="fas fa-tags mr-3"></i>Harga Modal Bahan
                </h3>
                <button onclick="closePriceModal()" class="text-slate-400 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="flex gap-2 mb-4">
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-3 top-2.5 text-slate-500 text-xs"></i>
                    <input type="text" id="price-search" onkeyup="renderPriceListTable()" placeholder="Cari bahan..." class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-9 p-2 text-sm text-white focus:border-yellow-500 outline-none">
                </div>
                <button onclick="document.getElementById('price-import-input').click()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-lg font-bold text-xs shadow flex items-center">
                    <i class="fas fa-file-upload mr-2"></i> Import Excel
                </button>
                <input type="file" id="price-import-input" accept=".xlsx, .xls" class="hidden" onchange="importPriceExcel(this)">
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar border border-slate-700 rounded-lg bg-slate-800/30">
                <table class="w-full text-left">
                    <thead class="bg-slate-800 text-xs text-slate-400 uppercase font-bold sticky top-0 z-10">
                        <tr>
                            <th class="p-3">Nama Bahan</th>
                            <th class="p-3 text-right">Harga Modal</th>
                            <th class="p-3 text-right">Stok Gudang</th>
                            <th class="p-3 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="price-table-body" class="divide-y divide-slate-700/50">
                        <!-- Content Injected via JS -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 pt-3 border-t border-slate-800 text-center">
                <p class="text-[10px] text-slate-500 italic">Format Excel: Kolom "Nama Bahan" & "Harga Modal"</p>
            </div>
        </div>
    </div>

    <!-- NEW EDIT PRICE MODAL -->
    <div id="editPriceModal" class="fixed inset-0 z-[60] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100 modal-scale">
            <h3 class="text-lg font-bold text-white mb-4">Edit Harga Bahan</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Nama Bahan</label>
                    <input type="text" id="edit-price-name" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-2.5 text-slate-400 text-sm font-bold" readonly>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Harga Modal Baru (Rp)</label>
                    <input type="number" id="edit-price-value" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-yellow-500 outline-none font-mono">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditPriceModal()" class="flex-1 py-2 bg-slate-700 text-slate-300 rounded hover:bg-slate-600 font-medium transition">Batal</button>
                <button onclick="savePriceUpdate()" class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 font-bold transition shadow-lg">Simpan</button>
            </div>
        </div>
    </div>

    <!-- BULK UPDATE MODAL REFINED -->
    <div id="bulkUpdateModal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 m-auto modal-scale flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-layer-group mr-2 text-indigo-600"></i>Update Stok Massal</h3>
                <button onclick="document.getElementById('bulkUpdateModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <!-- Global Settings for Batch -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 bg-gray-50 p-4 rounded-lg border border-gray-100">
                <div>
                     <label class="block text-xs font-bold text-gray-600 mb-1">PIC (Penanggung Jawab)</label>
                     <input type="text" id="bulkPIC" class="w-full px-3 py-2 border rounded-lg text-sm text-slate-800" placeholder="Nama PIC">
                </div>
                <div>
                     <label class="block text-xs font-bold text-gray-600 mb-1">Keterangan / Catatan Batch</label>
                     <input type="text" id="bulkDesc" class="w-full px-3 py-2 border rounded-lg text-sm text-slate-800" placeholder="Contoh: Opname Akhir Tahun">
                </div>
                 <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-gray-600 mb-1">Bukti Foto (Opsional - Berlaku untuk semua)</label>
                    <input type="file" id="bulkImage" onchange="handleFileSelect(this)" accept="image/*" class="text-xs w-full file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 text-slate-600">
                    <div id="file-status-indicator" class="hidden mt-1 text-xs text-green-600 font-bold flex items-center">
                        <i class="fas fa-check-circle mr-1"></i> File dipilih: <span id="file-name-display" class="font-normal text-slate-600 ml-1"></span>
                    </div>
                </div>
            </div>

            <!-- Search Bar for Bulk Items (NEW) -->
            <div class="mb-3">
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </span>
                    <input type="text" id="bulkSearchInput" onkeyup="filterBulkItems()" placeholder="Cari nama resource..." class="w-full pl-10 pr-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition placeholder-gray-400 text-slate-800">
                </div>
            </div>

            <!-- Item List -->
            <div class="flex-1 overflow-y-auto border rounded-lg mb-4 bg-white shadow-inner">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-3 text-xs font-bold text-gray-600">Nama Resource</th>
                            <th class="p-3 text-xs font-bold text-gray-600 text-center w-20">Stok</th>
                            <th class="p-3 text-xs font-bold text-gray-600 w-32">Aksi</th>
                            <th class="p-3 text-xs font-bold text-gray-600 w-28">Jumlah</th>
                        </tr>
                    </thead>
                    <tbody id="bulkItemsBody">
                        <!-- JS Injected -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-between items-center pt-2 border-t">
                <div class="text-xs text-gray-500 italic">* Kosongkan jumlah jika item tidak diupdate.</div>
                <div class="flex space-x-3">
                    <button onclick="document.getElementById('bulkUpdateModal').classList.add('hidden')" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-50 text-sm font-medium">Batal</button>
                    <button id="btnBulkConfirm" onclick="handleBulkSubmit()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-indigo-700 text-sm transition">Proses Semua</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CUSTOM CARD ALERT (REPLACEMENT FOR DEFAULT ALERTS) -->
    <div id="custom-alert-modal" class="fixed inset-0 z-[120] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl max-w-sm w-full p-8 transform transition-all scale-100 modal-scale">
            <div class="text-center">
                <div id="alert-icon-wrapper" class="w-16 h-16 rounded-full flex items-center justify-center mb-4 transition-colors mx-auto">
                    <i id="alert-icon" class="text-3xl"></i>
                </div>
                <h3 id="alert-title" class="text-xl font-bold text-white mb-2 tracking-wide"></h3>
                <p id="alert-message" class="text-slate-400 text-sm mb-8 leading-relaxed"></p>
                <div id="alert-actions" class="flex gap-3 justify-center">
                    <!-- Buttons injected via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- IMAGE PREVIEW MODAL -->
    <div id="image-preview-modal" class="fixed inset-0 z-[60] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4" onclick="closeImagePreview()">
        <img id="preview-img-content" class="max-w-full max-h-screen rounded shadow-2xl" src="">
        <p class="absolute bottom-5 text-white/50 text-sm">Klik di mana saja untuk menutup</p>
    </div>

    <!-- MODAL PREVIEW REPORT (STRUK) -->
    <div id="reportModal" class="fixed inset-0 bg-black/80 hidden flex flex-col items-center justify-center z-[90] p-4 backdrop-blur-sm">
        <div class="flex justify-between items-center w-full max-w-[450px] mb-4">
            <h3 class="text-white font-bold text-lg">Preview Report</h3>
            <div class="flex space-x-2">
                <button id="btnDownloadReport" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold shadow transition flex items-center text-sm">
                    <i class="fas fa-download mr-2"></i> Simpan
                </button>
                <button onclick="closeReportModal()" class="bg-white hover:bg-slate-200 text-slate-800 px-4 py-2 rounded-lg font-bold shadow transition text-sm">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- Container Struk -->
        <div id="reportPreviewContainer" class="overflow-auto max-h-[80vh] rounded shadow-2xl bg-white p-1 modal-scale">
            <!-- Struk akan di-inject ke sini -->
        </div>
    </div>

    <!-- Template Report (Hidden Source) -->
    <div id="receiptTemplate" class="hidden bg-white text-slate-800 font-sans shadow-none" style="width: 500px; padding: 0;">
        <div class="bg-slate-900 text-white p-6 rounded-t-lg">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold tracking-wide">VK WAREHOUSE</h2>
                    <p class="text-blue-200 text-xs mt-1 tracking-wider">OFFICIAL TRANSACTION DOCUMENT</p>
                </div>
                <div class="text-right">
                    <span id="recType" class="inline-block px-3 py-1 bg-white text-blue-800 rounded font-bold text-xs shadow">TYPE</span>
                </div>
            </div>
        </div>

        <div class="p-6 border-x border-b border-gray-200 rounded-b-lg bg-white">
            <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                <div>
                    <p class="text-gray-400 text-xs uppercase mb-1">Transaction ID</p>
                    <p id="recID" class="font-mono font-bold text-gray-700">#ID</p>
                </div>
                <div class="text-right">
                    <p class="text-gray-400 text-xs uppercase mb-1">Date</p>
                    <p id="recDate" class="font-bold text-gray-700">-</p>
                </div>
                <div>
                    <p class="text-gray-400 text-xs uppercase mb-1">PIC (Person In Charge)</p>
                    <p id="recPIC" class="font-bold text-gray-700 uppercase">-</p>
                </div>
            </div>

            <hr class="border-gray-100 my-4">

            <div class="mb-6">
                <p class="text-gray-400 text-xs uppercase mb-2">Transaction Details</p>
                
                <!-- Single Item View -->
                <div id="recSingleContainer" class="flex justify-between items-center bg-gray-50 p-4 rounded-lg border border-gray-100">
                    <div class="w-full">
                        <span class="block text-lg font-bold text-gray-800" id="recItem">Item Name</span>
                        <div class="text-xs text-gray-500 mt-1 space-x-2 flex items-center">
                            <span class="bg-white border px-1 rounded">Awal: <b id="recBefore">0</b></span>
                            <i class="fas fa-arrow-right text-gray-300"></i>
                            <span class="bg-white border px-1 rounded">Akhir: <b id="recAfter">0</b></span>
                        </div>
                    </div>
                    <div class="text-center ml-4 min-w-[80px]">
                        <span class="block text-xs text-gray-400 mb-1">Quantity</span>
                        <span class="block text-2xl font-bold" id="recAmount">0</span>
                        <span class="block text-[10px] font-bold uppercase mt-1 px-2 py-0.5 rounded text-white" id="recBadge">TYPE</span>
                    </div>
                </div>

                <!-- Batch Item View (New Table) -->
                <div id="recBatchContainer" class="hidden bg-gray-50 rounded-lg border border-gray-100 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 text-xs text-gray-500 uppercase">
                            <tr>
                                <th class="py-2 px-3 text-left">Item Name & Stock</th>
                                <th class="py-2 px-3 text-right">Change</th>
                            </tr>
                        </thead>
                        <tbody id="recBatchBody" class="divide-y divide-gray-200">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mb-6">
                <p class="text-gray-400 text-xs uppercase mb-1">Description / Notes</p>
                <p id="recDesc" class="text-sm text-gray-600 italic border-l-2 border-gray-300 pl-3 py-1 whitespace-pre-line">No description.</p>
            </div>

            <div id="receiptImgCont" class="hidden mt-4">
                <p class="text-gray-400 text-xs uppercase mb-2">Attached Proof</p>
                <div class="w-full rounded-lg overflow-hidden border border-gray-200 bg-gray-100 flex justify-center p-2">
                    <img id="receiptImg" class="max-h-64 object-contain rounded" style="display: block;">
                </div>
            </div>

            <div class="mt-8 pt-4 border-t border-gray-100 flex justify-between items-end text-[10px] text-gray-400">
                <span>Generated by VK Warehouse App</span>
                <span>*** VALID PROOF ***</span>
            </div>
        </div>
    </div>
    
    <!-- TOAST -->
    <div id="toast" class="fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-xl text-white font-bold transition transform duration-300 translate-y-20 opacity-0 pointer-events-none z-[110]"></div>

</body>
</html>
